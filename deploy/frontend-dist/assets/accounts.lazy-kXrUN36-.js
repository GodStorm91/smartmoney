var Ke=t=>{throw TypeError(t)};var Ce=(t,s,r)=>s.has(t)||Ke("Cannot "+r);var E=(t,s,r)=>(Ce(t,s,"read from private field"),r?r.call(t):s.get(t)),U=(t,s,r)=>s.has(t)?Ke("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(t):s.set(t,r),z=(t,s,r,a)=>(Ce(t,s,"write to private field"),a?a.call(t,r):s.set(t,r),r),W=(t,s,r)=>(Ce(t,s,"access private method"),r);import{aQ as ft,aR as Me,aS as jt,aT as vt,aU as rt,y as re,aV as Nt,aW as kt,r as u,aX as wt,aY as _t,aZ as Ct,a_ as St,a$ as Ve,b0 as He,b1 as Ft,b2 as At,a as J,u as G,a3 as Rt,P as at,O as ve,j as e,C as xe,A as B,a8 as se,b3 as Mt,b4 as Dt,b5 as Pt,a0 as Ne,N as ke,a2 as nt,g as Q,H as Y,v as me,an as De,aG as lt,R as ie,_ as Lt,I as Ue,B as ue,$ as it,aI as $t,q as be,d as we,V as Be,E as Pe,L as Le,X as pe,x as Ie,D as ot,ar as qt,z as Et,ag as Tt,aC as Se,ay as Ot,G as dt,b6 as Bt,ad as Fe,c as It}from"./index-CeIjqT8j.js";import{c as zt,d as Qt,s as Kt,C as fe,e as je,f as ct,h as Vt,i as Ht,j as xt,k as mt,l as Ut,m as ut,n as Wt,o as Yt,p as Jt,q as Gt,r as Xt,t as gt,u as ht}from"./crypto-DIUGQnIg.js";import{E as ze}from"./external-link-BW6ihPEf.js";import{C as _e}from"./chevron-down-NxYWKU8k.js";import{R as Zt,x as es,v as ts,X as ss,Y as rs,T as as,t as ns}from"./LineChart-Ct1gzDzB.js";import{C as yt}from"./chevron-up-DlFncXxd.js";import{T as ls,R as is}from"./TransactionFormModal-CuxAruOB.js";import"./recurring-service-DtzLohSz.js";import"./useCategories-De2iPPdj.js";import"./RecurringOptions-BNugIcyt.js";import"./useXPGain-DwfXP-ew.js";function We(t,s){const r=new Set(s);return t.filter(a=>!r.has(a))}function os(t,s,r){const a=t.slice(0);return a[s]=r,a}var ae,K,ne,le,V,ee,ge,he,ye,I,$e,qe,Ee,Te,Oe,st,ds=(st=class extends ft{constructor(s,r,a){super();U(this,I);U(this,ae);U(this,K);U(this,ne);U(this,le);U(this,V);U(this,ee);U(this,ge);U(this,he);U(this,ye,[]);z(this,ae,s),z(this,le,a),z(this,ne,[]),z(this,V,[]),z(this,K,[]),this.setQueries(r)}onSubscribe(){this.listeners.size===1&&E(this,V).forEach(s=>{s.subscribe(r=>{W(this,I,Te).call(this,s,r)})})}onUnsubscribe(){this.listeners.size||this.destroy()}destroy(){this.listeners=new Set,E(this,V).forEach(s=>{s.destroy()})}setQueries(s,r){z(this,ne,s),z(this,le,r),Me.batch(()=>{const a=E(this,V),d=W(this,I,Ee).call(this,E(this,ne));z(this,ye,d),d.forEach(y=>y.observer.setOptions(y.defaultedQueryOptions));const i=d.map(y=>y.observer),n=i.map(y=>y.getCurrentResult()),m=a.length!==i.length,p=i.some((y,v)=>y!==a[v]),w=m||p,_=w?!0:n.some((y,v)=>{const c=E(this,K)[v];return!c||!jt(y,c)});!w&&!_||(w&&z(this,V,i),z(this,K,n),this.hasListeners()&&(w&&(We(a,i).forEach(y=>{y.destroy()}),We(i,a).forEach(y=>{y.subscribe(v=>{W(this,I,Te).call(this,y,v)})})),W(this,I,Oe).call(this)))})}getCurrentResult(){return E(this,K)}getQueries(){return E(this,V).map(s=>s.getCurrentQuery())}getObservers(){return E(this,V)}getOptimisticResult(s,r){const a=W(this,I,Ee).call(this,s),d=a.map(i=>i.observer.getOptimisticResult(i.defaultedQueryOptions));return[d,i=>W(this,I,qe).call(this,i??d,r),()=>W(this,I,$e).call(this,d,a)]}},ae=new WeakMap,K=new WeakMap,ne=new WeakMap,le=new WeakMap,V=new WeakMap,ee=new WeakMap,ge=new WeakMap,he=new WeakMap,ye=new WeakMap,I=new WeakSet,$e=function(s,r){return r.map((a,d)=>{const i=s[d];return a.defaultedQueryOptions.notifyOnChangeProps?i:a.observer.trackResult(i,n=>{r.forEach(m=>{m.observer.trackProp(n)})})})},qe=function(s,r){return r?((!E(this,ee)||E(this,K)!==E(this,he)||r!==E(this,ge))&&(z(this,ge,r),z(this,he,E(this,K)),z(this,ee,vt(E(this,ee),r(s)))),E(this,ee)):s},Ee=function(s){const r=new Map;E(this,V).forEach(d=>{const i=d.options.queryHash;if(!i)return;const n=r.get(i);n?n.push(d):r.set(i,[d])});const a=[];return s.forEach(d=>{var p;const i=E(this,ae).defaultQueryOptions(d),m=((p=r.get(i.queryHash))==null?void 0:p.shift())??new rt(E(this,ae),i);a.push({defaultedQueryOptions:i,observer:m})}),a},Te=function(s,r){const a=E(this,V).indexOf(s);a!==-1&&(z(this,K,os(E(this,K),a,r)),W(this,I,Oe).call(this))},Oe=function(){var s;if(this.hasListeners()){const r=E(this,ee),a=W(this,I,$e).call(this,E(this,K),E(this,ye)),d=W(this,I,qe).call(this,a,(s=E(this,le))==null?void 0:s.combine);r!==d&&Me.batch(()=>{this.listeners.forEach(i=>{i(E(this,K))})})}},st);function Ye({queries:t,...s},r){const a=re(),d=Nt(),i=kt(),n=u.useMemo(()=>t.map(k=>{const D=a.defaultQueryOptions(k);return D._optimisticResults=d?"isRestoring":"optimistic",D}),[t,a,d]);n.forEach(k=>{wt(k),_t(k,i)}),Ct(i);const[m]=u.useState(()=>new ds(a,n,s)),[p,w,_]=m.getOptimisticResult(n,s.combine),y=!d&&s.subscribed!==!1;u.useSyncExternalStore(u.useCallback(k=>y?m.subscribe(Me.batchCalls(k)):St,[m,y]),()=>m.getCurrentResult(),()=>m.getCurrentResult()),u.useEffect(()=>{m.setQueries(n,s)},[n,s,m]);const c=p.some((k,D)=>Ve(n[D],k))?p.flatMap((k,D)=>{const F=n[D];if(F){const l=new rt(a,F);if(Ve(F,k))return He(F,l,i);Ft(k,d)&&He(F,l,i)}return[]}):[];if(c.length>0)throw Promise.all(c);const R=p.find((k,D)=>{const F=n[D];return F&&At({result:k,errorResetBoundary:i,throwOnError:F.throwOnError,query:a.getQueryCache().get(F.queryHash),suspense:F.suspense})});if(R!=null&&R.error)throw R.error;return w(_())}/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],xs=J("archive",cs);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=[["path",{d:"m7 7 10 10",key:"1fmybs"}],["path",{d:"M17 7v10H7",key:"6fjiku"}]],us=J("arrow-down-right",ms);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]],hs=J("arrow-right-left",gs);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ys=[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]],ps=J("arrow-up-right",ys);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bs=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],fs=J("circle-check",bs);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const js=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],vs=J("clock",js);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]],Qe=J("gift",Ns);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ks=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],ws=J("layers",ks);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _s=[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]],Cs=J("percent",_s);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ss=[["path",{d:"M21 10.656V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.344",key:"2acyp4"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Je=J("square-check-big",Ss);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fs=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]],Ge=J("square",Fs),As={bank:{icon:"ðŸ¦",color:"text-blue-600",bgColor:"bg-blue-50 dark:bg-blue-900/30"},cash:{icon:"ðŸ’µ",color:"text-green-600",bgColor:"bg-green-50 dark:bg-green-900/30"},credit_card:{icon:"ðŸ’³",color:"text-purple-600",bgColor:"bg-purple-50 dark:bg-purple-900/30"},investment:{icon:"ðŸ“ˆ",color:"text-orange-600",bgColor:"bg-orange-50 dark:bg-orange-900/30"},receivable:{icon:"ðŸ’°",color:"text-teal-600",bgColor:"bg-teal-50 dark:bg-teal-900/30"},savings:{icon:"ðŸ·",color:"text-pink-600",bgColor:"bg-pink-50 dark:bg-pink-900/30"},crypto:{icon:"â‚¿",color:"text-amber-600",bgColor:"bg-amber-50 dark:bg-amber-900/30"},other:{icon:"ðŸ“",color:"text-gray-600",bgColor:"bg-gray-50 dark:bg-gray-700"}};function Rs({account:t,onEdit:s,onAddTransaction:r}){const{t:a}=G("common"),d=Rt(),{data:i}=at(),{isPrivacyMode:n}=ve(),m=As[t.type],p=t.current_balance>=0,w=()=>{const y=new Date,v=`${y.getFullYear()}-${String(y.getMonth()+1).padStart(2,"0")}`;d({to:"/transactions",search:{accountId:t.id,month:v,fromAccounts:!0}})},_=y=>{y.stopPropagation(),r==null||r(t.id)};return e.jsxs(xe,{className:"relative hover:shadow-md transition-shadow cursor-pointer",onClick:w,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:B("p-3 rounded-lg",m.bgColor),children:e.jsx("span",{className:"text-2xl",children:m.icon})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900 dark:text-gray-100",children:t.name}),e.jsx("p",{className:B("text-sm",m.color),children:a(`account.type.${t.type}`)})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[r&&e.jsx("button",{onClick:_,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors","aria-label":a("transaction.addTransaction"),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5 text-green-600 dark:text-green-400",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"})})}),s&&e.jsx("button",{onClick:y=>{y.stopPropagation(),s(t.id)},className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors","aria-label":a("account.edit"),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5 text-gray-600 dark:text-gray-400",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"})})}),!t.is_active&&e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full",children:a("account.inactive")})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-1",children:a("account.currentBalance")}),e.jsx("p",{className:B("text-3xl font-bold font-mono",p?"text-green-600":"text-red-600"),children:se(t.current_balance,t.currency,(i==null?void 0:i.rates)||{},!0,n)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a("account.initialBalance")}),e.jsx("p",{className:"text-sm font-mono text-gray-700 dark:text-gray-300",children:se(t.initial_balance,t.currency,(i==null?void 0:i.rates)||{},!0,n)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:a("account.transactions")}),e.jsx("p",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300",children:t.transaction_count})]})]}),t.notes&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:a("account.notes")}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:t.notes})]})]})}const Ae=t=>{const s=t.startsWith("-"),a=t.replace(/[^\d.]/g,"").split(".");return a[0]=a[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),(s?"-":"")+a.join(".")},Re=t=>{const s=t.startsWith("-"),r=t.replace(/[^\d.]/g,"");return(s?"-":"")+r},oe=t=>t==="USD"?100:1;function Ms({isOpen:t,onClose:s,editingAccountId:r}){const{t:a}=G("common"),d=Mt(),i=Dt(),{data:n}=Pt(r||void 0),m=Ne(),{isPrivacyMode:p}=ve(),[w,_]=u.useState(""),[y,v]=u.useState("bank"),[c,R]=u.useState(""),[k,D]=u.useState(""),[F,l]=u.useState("JPY"),[b,h]=u.useState(""),[N,j]=u.useState({}),[S,$]=u.useState(""),[P,A]=u.useState(!1),x=["bank","cash","credit_card","investment","receivable","savings","other"],M=n&&n.transaction_count>0,q=(()=>{if(!n||!S)return null;const L=oe(n.currency),f=parseFloat(S)*L,T=n.current_balance;return f-T})();u.useEffect(()=>{if(t){if(r&&n)if(_(n.name),v(n.type),h(n.notes||""),l(n.currency),M)$(""),A(!1);else{const L=oe(n.currency);R((n.initial_balance/L).toString()),D(n.initial_balance_date)}else _(""),v("bank"),R("0"),D(new Date().toISOString().split("T")[0]),l("JPY"),h(""),$(""),A(!1);j({})}},[t,r,n,M]);const o=()=>{const L={};return w.trim()||(L.name=a("account.errors.nameRequired")),r?r&&!M&&(k||(L.initialBalanceDate=a("account.errors.dateRequired"))):k||(L.initialBalanceDate=a("account.errors.dateRequired")),j(L),Object.keys(L).length===0},C=async L=>{if(L.preventDefault(),!!o()){if(r&&M&&S&&!P){A(!0);return}try{if(r){const f={name:w.trim(),type:y,notes:b.trim()||void 0};if(!M&&n){const T=oe(n.currency);f.initial_balance=Math.round(parseFloat(c||"0")*T),f.initial_balance_date=k}if(M&&S&&n){const T=oe(n.currency);f.desired_current_balance=Math.round(parseFloat(S)*T)}await i.mutateAsync({id:r,data:f})}else{const f=oe(F),T={name:w.trim(),type:y,initial_balance:Math.round(parseFloat(c||"0")*f),initial_balance_date:k,currency:F,notes:b.trim()||void 0};await d.mutateAsync(T)}s()}catch(f){j({submit:f.message||a("account.errors.submitFailed")})}}};if(!t)return null;const Z=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:s}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},children:[e.jsxs("div",{className:"sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:a(r?"account.editAccount":"account.createAccount")}),e.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:2,stroke:"currentColor",className:"w-6 h-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("form",{onSubmit:C,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[a("account.name")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"name",value:w,onChange:L=>_(L.target.value),className:B("w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500","bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",N.name?"border-red-500":"border-gray-300 dark:border-gray-600"),placeholder:a("account.namePlaceholder")}),N.name&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:N.name})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"type",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[a("account.accountType")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{id:"type",value:y,onChange:L=>v(L.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",children:x.map(L=>e.jsx("option",{value:L,children:a(`account.type.${L}`)},L))})]}),!r&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"initialBalance",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("account.initialBalance")}),e.jsx("input",{type:"text",inputMode:"decimal",id:"initialBalance",value:Ae(c),onChange:L=>R(Re(L.target.value)),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-numbers",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"initialBalanceDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[a("account.initialBalanceDate")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",id:"initialBalanceDate",value:k,onChange:L=>D(L.target.value),className:B("w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500","bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",N.initialBalanceDate?"border-red-500":"border-gray-300 dark:border-gray-600")}),N.initialBalanceDate&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:N.initialBalanceDate})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"currency",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("account.currency")}),e.jsxs("select",{id:"currency",value:F,onChange:L=>l(L.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",children:[e.jsx("option",{value:"JPY",children:"JPY (Â¥)"}),e.jsx("option",{value:"USD",children:"USD ($)"}),e.jsx("option",{value:"VND",children:"VND (â‚«)"})]})]})]}),r&&!M&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"initialBalance",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("account.initialBalance")}),e.jsx("input",{type:"text",inputMode:"decimal",id:"initialBalance",value:Ae(c),onChange:L=>R(Re(L.target.value)),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-numbers",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"initialBalanceDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[a("account.initialBalanceDate")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",id:"initialBalanceDate",value:k,onChange:L=>D(L.target.value),className:B("w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500","bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",N.initialBalanceDate?"border-red-500":"border-gray-300 dark:border-gray-600")}),N.initialBalanceDate&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:N.initialBalanceDate})]})]}),r&&M&&n&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-blue-900 dark:text-blue-200",children:"Current Balance"}),e.jsx("span",{className:"text-lg font-bold text-blue-900 dark:text-blue-200",children:se(n.current_balance,n.currency,m,!0,p)})]}),e.jsxs("p",{className:"text-xs text-blue-700 dark:text-blue-300 mt-1",children:[n.transaction_count," transactions"]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"desiredBalance",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Desired Current Balance"}),e.jsx("input",{type:"text",inputMode:"decimal",id:"desiredBalance",value:Ae(S),onChange:L=>{$(Re(L.target.value)),A(!1)},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-numbers",placeholder:"Enter the actual balance"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Enter the actual balance from your bank/wallet to reconcile"})]}),q!==null&&q!==0&&e.jsx("div",{className:B("border rounded-lg p-4",q>0?"bg-green-50 border-green-200":"bg-red-50 border-red-200"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:B("text-sm font-medium",q>0?"text-green-900":"text-red-900"),children:"Adjustment Amount"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:B("text-lg font-bold",q>0?"text-green-900":"text-red-900"),children:q>0?"â†‘":"â†“"}),e.jsx("span",{className:B("text-lg font-bold",q>0?"text-green-900":"text-red-900"),children:se(Math.abs(q),n.currency,m,!0,p)})]})]})}),P&&q!==null&&q!==0&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("svg",{className:"w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-900",children:"Confirm Balance Adjustment"}),e.jsxs("p",{className:"text-sm text-yellow-700 mt-1",children:["This will create a balance adjustment transaction of"," ",e.jsx("span",{className:"font-semibold",children:se(Math.abs(q),n.currency,m,!0,p)})," ","to reconcile your account balance."]})]})]})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("account.notes")}),e.jsx("textarea",{id:"notes",value:b,onChange:L=>h(L.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",rows:3,placeholder:a("account.notesPlaceholder")})]}),N.submit&&e.jsx("div",{className:"bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-3",children:e.jsx("p",{className:"text-red-700 dark:text-red-300 text-sm",children:N.submit})}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[P&&e.jsx("button",{type:"button",onClick:()=>{A(!1),$("")},className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:"Cancel Adjustment"}),!P&&e.jsx("button",{type:"button",onClick:s,className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:a("cancel")}),e.jsx("button",{type:"submit",disabled:d.isPending||i.isPending,className:B("flex-1 px-4 py-2 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",P?"bg-yellow-600 hover:bg-yellow-700":"bg-blue-600 hover:bg-blue-700"),children:d.isPending||i.isPending?a("saving"):P?"Confirm Adjustment":a(r?"update":"create")})]})]})]})]});return typeof document>"u"?null:ke.createPortal(Z,document.body)}const Ds=["eth","bsc","polygon"];function Xe({token:t,isPrivacyMode:s}){return e.jsxs("div",{className:"flex items-center justify-between py-1.5 px-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.logo_url?e.jsx("img",{src:t.logo_url,alt:t.symbol,className:"w-5 h-5 rounded-full",onError:r=>{r.target.style.display="none"}}):e.jsx("div",{className:"w-5 h-5 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-[10px] font-medium",children:t.symbol.slice(0,2)}),e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 truncate",children:t.symbol})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-900 dark:text-white",children:s?"***":Number(t.balance)<1e-4?"<0.0001":Number(t.balance).toFixed(4)}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s?"$***":`$${Number(t.balance_usd).toFixed(2)}`})]})]})}function Ze(){const{t}=G("common"),s=re(),{currency:r}=nt(),{isPrivacyMode:a}=ve(),d=Ne(),[i,n]=u.useState(!1),[m,p]=u.useState(""),[w,_]=u.useState(""),[y,v]=u.useState(["eth","bsc","polygon"]),[c,R]=u.useState(null),[k,D]=u.useState(null),{data:F,isLoading:l}=Q({queryKey:["crypto-wallets"],queryFn:ct}),{data:b}=Q({queryKey:["crypto-wallets-balance",F==null?void 0:F.map(f=>f.id)],queryFn:async()=>!F||F.length===0?[]:Promise.all(F.map(f=>Vt(f.id))),enabled:!!F&&F.length>0}),{data:h,isLoading:N}=Q({queryKey:["crypto-portfolio",k],queryFn:()=>Ht(k),enabled:!!k}),j=Y({mutationFn:zt,onSuccess:()=>{s.invalidateQueries({queryKey:["crypto-wallets"]}),n(!1),p(""),_(""),v(["eth","bsc","polygon"])}}),S=Y({mutationFn:Qt,onSuccess:()=>{s.invalidateQueries({queryKey:["crypto-wallets"]}),s.invalidateQueries({queryKey:["crypto-wallets-balance"]})}}),$=Y({mutationFn:Kt,onSuccess:()=>{s.invalidateQueries({queryKey:["crypto-wallets"]}),s.invalidateQueries({queryKey:["crypto-wallets-balance"]}),s.invalidateQueries({queryKey:["dashboard-summary"]}),R(null)},onError:()=>{R(null)}}),P=()=>{m.trim()&&j.mutate({wallet_address:m.trim(),label:w.trim()||void 0,chains:y})},A=f=>{confirm(t("confirmDelete"))&&S.mutate(f)},x=f=>{R(f),$.mutate(f)},M=f=>{v(T=>T.includes(f)?T.filter(te=>te!==f):[...T,f])},g=f=>{D(T=>T===f?null:f)},q=f=>`${f.slice(0,6)}...${f.slice(-4)}`,o=(f,T)=>{const te={eth:`https://etherscan.io/address/${f}`,bsc:`https://bscscan.com/address/${f}`,polygon:`https://polygonscan.com/address/${f}`,arbitrum:`https://arbiscan.io/address/${f}`,optimism:`https://optimistic.etherscan.io/address/${f}`};return te[T]||te.eth},C=(b==null?void 0:b.reduce((f,T)=>f+Number(T.total_balance_usd||0),0))||0,Z=1/((d==null?void 0:d.USD)||.00667),L=Math.round(C*Z);return l?e.jsx(fe,{title:t("crypto.wallets"),badge:0,children:e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(me,{size:"md"})})}):e.jsxs(fe,{title:t("crypto.wallets"),badge:(F==null?void 0:F.length)||0,defaultOpen:F&&F.length>0,children:[b&&b.length>0&&e.jsxs("div",{className:"mb-4 p-4 bg-gradient-to-r from-purple-500/10 to-blue-500/10 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:t("crypto.totalBalance")}),e.jsx("p",{className:"text-2xl font-bold text-purple-600 dark:text-purple-400",children:se(L,r,d,!1,a)})]}),b&&b.length>0?e.jsx("div",{className:"space-y-3 mb-4",children:b.map(f=>{var T,te;return e.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg",children:e.jsx(De,{className:"w-5 h-5 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white truncate",children:f.label||q(f.wallet_address)}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("code",{className:"text-xs",children:q(f.wallet_address)}),e.jsx("a",{href:o(f.wallet_address,"eth"),target:"_blank",rel:"noopener noreferrer",className:"hover:text-purple-500",children:e.jsx(ze,{className:"w-3 h-3"})})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:a?"$***":`$${Number(f.total_balance_usd||0).toFixed(2)}`}),e.jsx("div",{className:"flex gap-1 mt-1",children:(T=f.chains)==null?void 0:T.map(O=>{var H;return e.jsx("span",{className:"text-xs px-1.5 py-0.5 bg-gray-200 dark:bg-gray-700 rounded",title:(H=je[O])==null?void 0:H.name,children:O.toUpperCase()},O)})})]})]}),e.jsxs("button",{onClick:()=>g(f.id),className:"flex items-center gap-2 mt-3 text-sm text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 transition-colors",children:[k===f.id?e.jsx(_e,{className:"w-4 h-4"}):e.jsx(lt,{className:"w-4 h-4"}),t("crypto.tokens")]}),k===f.id&&e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:N?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(me,{size:"sm"})}):h!=null&&h.chains&&h.chains.length>0?e.jsx("div",{className:"space-y-4",children:h.chains.filter(O=>O.tokens.length>0||O.native_balance).sort((O,H)=>Number(H.total_usd)-Number(O.total_usd)).map(O=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase",children:O.chain_name}),e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:a?"$***":`$${Number(O.total_usd).toFixed(2)}`})]}),e.jsxs("div",{className:"space-y-1",children:[O.native_balance&&Number(O.native_balance.balance)>0&&e.jsx(Xe,{token:O.native_balance,isPrivacyMode:a}),O.tokens.filter(H=>Number(H.balance_usd)>=1).sort((H,bt)=>Number(bt.balance_usd)-Number(H.balance_usd)).map(H=>e.jsx(Xe,{token:H,isPrivacyMode:a},H.token_address))]})]},O.chain_id))}):e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500 text-center py-2",children:t("crypto.noTokens")})}),e.jsxs("div",{className:"flex items-center justify-between mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:(te=f.sync_statuses)!=null&&te.some(O=>O.last_sync_at)?t("crypto.lastSync",{time:new Date(Math.max(...f.sync_statuses.filter(O=>O.last_sync_at).map(O=>new Date(O.last_sync_at).getTime()))).toLocaleString()}):t("crypto.neverSynced")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>x(f.id),disabled:c===f.id,className:"p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded-lg transition-colors",title:t("crypto.sync"),children:c===f.id?e.jsx(me,{size:"sm"}):e.jsx(ie,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>A(f.id),className:"p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors",title:t("delete"),children:e.jsx(Lt,{className:"w-4 h-4"})})]})]})]},f.id)})}):i?null:e.jsxs("div",{className:"text-center py-6",children:[e.jsx(De,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-2",children:t("crypto.noWallets")}),e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:t("crypto.addWalletDescription")})]}),i?e.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-800 rounded-lg space-y-4",children:[e.jsx(Ue,{label:t("crypto.walletAddress"),placeholder:"0x...",value:m,onChange:f=>p(f.target.value)}),e.jsx(Ue,{label:t("crypto.walletLabel"),placeholder:t("crypto.walletLabelPlaceholder"),value:w,onChange:f=>_(f.target.value)}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:t("crypto.selectChains")}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Ds.map(f=>{var T;return e.jsx("button",{type:"button",onClick:()=>M(f),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${y.includes(f)?"bg-purple-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300"}`,children:((T=je[f])==null?void 0:T.name)||f.toUpperCase()},f)})})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(ue,{variant:"outline",onClick:()=>n(!1),children:t("cancel")}),e.jsx(ue,{onClick:P,disabled:!m.trim()||y.length===0||j.isPending,children:j.isPending?t("saving"):t("crypto.addWallet")})]})]}):e.jsxs(ue,{variant:"outline",onClick:()=>n(!0),className:"w-full",children:[e.jsx(it,{className:"w-4 h-4 mr-2"}),t("crypto.addWallet")]})]})}function Ps({snapshots:t}){const{resolvedTheme:s}=$t(),r=s==="dark",a=r?"#374151":"#E5E7EB",d=r?"#9CA3AF":"#6B7280",i=r?"#1F2937":"#FFFFFF",n=r?"#374151":"#E5E7EB",m="#6366F1",p=u.useMemo(()=>[...t].sort((y,v)=>new Date(y.snapshot_date).getTime()-new Date(v.snapshot_date).getTime()).map(y=>({date:y.snapshot_date,value:Number(y.balance_usd),formattedDate:new Date(y.snapshot_date).toLocaleDateString("en-US",{month:"short",day:"numeric"})})),[t]),[w,_]=u.useMemo(()=>{const y=p.map(k=>k.value),v=Math.min(...y),c=Math.max(...y),R=(c-v)*.1||10;return[Math.max(0,v-R),c+R]},[p]);return p.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:"No historical data available"}):e.jsx(Zt,{width:"100%",height:"100%",children:e.jsxs(es,{data:p,margin:{top:5,right:10,left:0,bottom:5},children:[e.jsx(ts,{strokeDasharray:"3 3",stroke:a,vertical:!1}),e.jsx(ss,{dataKey:"formattedDate",tick:{fill:d,fontSize:11},tickLine:!1,axisLine:{stroke:a},interval:"preserveStartEnd"}),e.jsx(rs,{domain:[w,_],tick:{fill:d,fontSize:11},tickLine:!1,axisLine:!1,tickFormatter:y=>`$${y.toFixed(0)}`,width:50}),e.jsx(as,{contentStyle:{backgroundColor:i,border:`1px solid ${n}`,borderRadius:"8px",fontSize:"12px"},labelStyle:{color:d,fontWeight:"bold"},formatter:y=>[`$${y.toFixed(2)}`,"Value"]}),e.jsx(ns,{type:"monotone",dataKey:"value",stroke:m,strokeWidth:2,dot:p.length<=10,activeDot:{r:6,fill:m}})]})})}function Ls({positionId:t}){var g,q;const{t:s}=G(),r=re(),[a,d]=u.useState(null),[i,n]=u.useState(!1),[m,p]=u.useState(null),[w,_]=u.useState(null),[y,v]=u.useState(null),{data:c,isLoading:R}=Q({queryKey:["position-roi",t],queryFn:()=>ut(t)}),{data:k=[]}=Q({queryKey:["position-rewards-list",t],queryFn:()=>Wt(t)}),D=Y({mutationFn:()=>xt(90),onSuccess:o=>{d({scanned:o.scanned_claims,new:o.new_claims}),r.invalidateQueries({queryKey:["position-roi"]}),r.invalidateQueries({queryKey:["position-rewards-list"]}),r.invalidateQueries({queryKey:["unattributed-rewards"]}),setTimeout(()=>d(null),5e3)}}),F=Y({mutationFn:o=>mt(o),onSuccess:o=>{_(s("crypto.transactionCreated","Transaction created: ${{amount}}",{amount:o.amount_usd.toFixed(2)})),r.invalidateQueries({queryKey:["position-rewards-list"]}),r.invalidateQueries({queryKey:["transactions"]}),p(null),setTimeout(()=>_(null),5e3)},onError:o=>{v(o.message||s("crypto.transactionCreateError","Failed to create transaction")),p(null),setTimeout(()=>v(null),5e3)}}),l=Y({mutationFn:o=>Ut(o),onSuccess:o=>{const C=s("crypto.batchTransactionsCreated","Created {{created}} transactions (${{total}}). Skipped: {{skipped}}",{created:o.created,total:o.total_usd.toFixed(2),skipped:o.skipped});_(C),r.invalidateQueries({queryKey:["position-rewards-list"]}),r.invalidateQueries({queryKey:["transactions"]}),setTimeout(()=>_(null),8e3)},onError:o=>{v(o.message||s("crypto.batchTransactionError","Failed to create transactions")),setTimeout(()=>v(null),5e3)}}),b=k.filter(o=>!o.transaction_id),h=1,N=((g=c==null?void 0:c.rewards_by_token)==null?void 0:g.filter(o=>Number(o.amount_usd)>=h))||[],j=((q=c==null?void 0:c.rewards_by_month)==null?void 0:q.filter(o=>Number(o.amount_usd)>=h))||[],S=k.filter(o=>Number(o.reward_usd||0)>=h),$=N.reduce((o,C)=>o+Number(C.amount_usd||0),0);if(R)return e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-24 bg-gray-200 dark:bg-gray-700 rounded-lg"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded-lg"})]});const P=o=>{if(o==null)return null;const C=Number(o);return isNaN(C)?null:`$${C.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`},A=o=>{if(o===null)return"-";const C=Number(o);return`${C>=0?"+":""}${C.toFixed(2)}%`},x=o=>{const[C,Z]=o.split("-");return new Date(Number(C),Number(Z)-1).toLocaleDateString(void 0,{month:"short",year:"numeric"})},M=o=>Number(o).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg",children:[e.jsx("div",{className:"text-sm text-indigo-700 dark:text-indigo-300",children:s("crypto.scanRewardsHint","Scan blockchain for claimed rewards")}),e.jsx("button",{onClick:()=>D.mutate(),disabled:D.isPending,className:"flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white text-sm font-medium rounded-lg transition-colors",children:D.isPending?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 animate-spin"}),s("crypto.scanning","Scanning...")]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4"}),s("crypto.scanRewards","Scan Rewards")]})})]}),a&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(be,{className:"h-4 w-4"}),s("crypto.scanComplete","Scanned {{scanned}} claims, found {{new}} new",a)]}),c&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-medium text-green-800 dark:text-green-200 mb-3 flex items-center gap-2",children:[e.jsx(we,{className:"h-4 w-4"}),s("crypto.roiSummary","ROI Summary")]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:s("crypto.totalRewards","Total Rewards")}),N.length>0?e.jsx("div",{className:"space-y-1",children:N.map(o=>{const C=P(o.amount_usd);return e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:[M(o.amount)," ",o.symbol]}),C&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400",children:["â‰ˆ ",C]})]},o.symbol)})}):e.jsx("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:P($)||"-"}),e.jsxs("div",{className:"text-xs text-green-600 dark:text-green-400",children:[S.length," ",s("crypto.claims","claims")]})]}),c.cost_basis_usd!==null&&c.simple_roi_pct!==null&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t border-green-200 dark:border-green-800",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:s("crypto.costBasis","Cost Basis")}),e.jsx("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:P(c.cost_basis_usd)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:s("crypto.roi","ROI")}),e.jsx("div",{className:`text-lg font-semibold ${c.simple_roi_pct>=0?"text-green-800 dark:text-green-200":"text-red-600 dark:text-red-400"}`,children:A(c.simple_roi_pct)}),c.days_held&&e.jsxs("div",{className:"text-xs text-green-600 dark:text-green-400",children:[c.days_held," ",s("crypto.daysHeld","days")]})]})]})]})]}),c&&j.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4"}),s("crypto.monthlyBreakdown","Monthly Breakdown")]}),e.jsx("div",{className:"space-y-2",children:j.map(o=>{const C=P(o.amount_usd);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-gray-100",children:x(o.month)}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[o.count," ",s("crypto.claims","claims")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[M(o.amount)," ",o.symbol]}),C&&e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["â‰ˆ ",C]})]})]},`${o.month}-${o.symbol}`)})})]}),S.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{onClick:()=>n(!i),className:"flex items-center gap-2 font-medium text-gray-900 dark:text-gray-100 hover:text-primary-600 dark:hover:text-primary-400 transition-colors",children:[e.jsx(Pe,{className:"h-4 w-4"}),s("crypto.allRewards","All Rewards")," (",S.length,")",i?e.jsx(yt,{className:"h-4 w-4"}):e.jsx(_e,{className:"h-4 w-4"})]}),b.length>0&&e.jsxs("button",{type:"button",onClick:()=>l.mutate(b.map(o=>o.id)),disabled:l.isPending,className:"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-white bg-primary-600 hover:bg-primary-700 disabled:bg-primary-400 rounded-lg transition-colors",children:[l.isPending?e.jsx(Le,{className:"h-3.5 w-3.5 animate-spin"}):e.jsx(it,{className:"h-3.5 w-3.5"}),s("crypto.createAllTransactions","Create All Txns")," (",b.length,")"]})]}),i&&e.jsxs(e.Fragment,{children:[w&&e.jsxs("div",{className:"flex items-center gap-2 p-3 mb-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(be,{className:"h-4 w-4"}),w]}),y&&e.jsxs("div",{className:"flex items-center gap-2 p-3 mb-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-sm text-red-700 dark:text-red-300",children:[e.jsx(pe,{className:"h-4 w-4"}),y]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:S.map(o=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:[Number(o.reward_amount).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:4})," ",o.reward_token_symbol||"tokens"]}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[new Date(o.claimed_at).toLocaleDateString()," via ",o.source,o.reward_usd&&e.jsxs("span",{className:"ml-2 text-green-600 dark:text-green-400",children:["â‰ˆ $",Number(o.reward_usd).toFixed(2)]})]})]}),o.reward_usd&&Number(o.reward_usd)>0&&e.jsx("div",{className:"flex-shrink-0 ml-3",children:o.transaction_id?e.jsxs("a",{href:`/transactions?id=${o.transaction_id}`,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/30 rounded hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors",children:[e.jsx(ze,{className:"h-3 w-3"}),s("crypto.viewTransaction","View Txn")]}):e.jsxs("button",{type:"button",onClick:()=>{p(o.id),F.mutate(o.id)},disabled:m===o.id,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-primary-700 dark:text-primary-300 bg-primary-100 dark:bg-primary-900/30 rounded hover:bg-primary-200 dark:hover:bg-primary-900/50 disabled:opacity-50 transition-colors",children:[m===o.id?e.jsx(Le,{className:"h-3 w-3 animate-spin"}):e.jsx(Pe,{className:"h-3 w-3"}),s("crypto.createTransaction","Create Txn")]})})]},o.id))})]})]}),c&&S.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx(Qe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),$<h?s("crypto.rewardsBelowThreshold","No rewards above ${{threshold}} to display",{threshold:h}):s("crypto.noRewards","No rewards claimed for this position yet.")]})]})}function $s({source:t="symbiotic"}){var D,F;const{t:s}=G(),r=re(),[a,d]=u.useState(null),{data:i,isLoading:n}=Q({queryKey:["staking-rewards",t],queryFn:()=>Yt(t)}),m=Y({mutationFn:()=>xt(90),onSuccess:l=>{d({scanned:l.scanned_claims,new:l.new_claims}),r.invalidateQueries({queryKey:["staking-rewards"]}),setTimeout(()=>d(null),5e3)}});if(n)return e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-24 bg-gray-200 dark:bg-gray-700 rounded-lg"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded-lg"})]});const p=l=>{if(l==null)return null;const b=Number(l);return isNaN(b)?null:`$${b.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`},w=l=>{const[b,h]=l.split("-");return new Date(Number(b),Number(h)-1).toLocaleDateString(void 0,{month:"short",year:"numeric"})},_=l=>Number(l).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:4}),y=t==="symbiotic"?"Symbiotic":t,v=1,c=((D=i==null?void 0:i.rewards_by_token)==null?void 0:D.filter(l=>Number(l.amount_usd)>=v))||[],R=((F=i==null?void 0:i.rewards_by_month)==null?void 0:F.filter(l=>Number(l.amount_usd)>=v))||[],k=c.reduce((l,b)=>l+Number(b.amount_usd||0),0);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg",children:[e.jsx("div",{className:"text-sm text-indigo-700 dark:text-indigo-300",children:s("crypto.scanStakingRewardsHint","Scan blockchain for claimed staking rewards")}),e.jsx("button",{onClick:()=>m.mutate(),disabled:m.isPending,className:"flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white text-sm font-medium rounded-lg transition-colors",children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 animate-spin"}),s("crypto.scanning","Scanning...")]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4"}),s("crypto.scanRewards","Scan Rewards")]})})]}),a&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(be,{className:"h-4 w-4"}),s("crypto.scanComplete","Scanned {{scanned}} claims, found {{new}} new",a)]}),i&&c.length>0&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-medium text-green-800 dark:text-green-200 mb-3 flex items-center gap-2",children:[e.jsx(we,{className:"h-4 w-4"}),s("crypto.stakingRewardsSummary","{{source}} Rewards Summary",{source:y})]}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:s("crypto.totalRewards","Total Rewards")}),c.length>0?e.jsx("div",{className:"space-y-1",children:c.map(l=>{const b=p(l.amount_usd);return e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:[_(l.amount)," ",l.symbol]}),b&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400",children:["â‰ˆ ",b]})]},l.symbol)})}):e.jsx("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:p(k)||"-"}),e.jsxs("div",{className:"text-xs text-green-600 dark:text-green-400 mt-1",children:[R.reduce((l,b)=>l+b.count,0)," ",s("crypto.claims","claims")]})]})})]}),i&&R.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2",children:[e.jsx(Be,{className:"h-4 w-4"}),s("crypto.monthlyBreakdown","Monthly Breakdown")]}),e.jsx("div",{className:"space-y-2",children:R.map(l=>{const b=p(l.amount_usd);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-gray-100",children:w(l.month)}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[l.count," ",s("crypto.claims","claims")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[_(l.amount)," ",l.symbol]}),b&&e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["â‰ˆ ",b]})]})]},`${l.month}-${l.symbol}`)})})]}),i&&c.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx(Qe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"font-medium text-gray-700 dark:text-gray-300 mb-2",children:k<v?s("crypto.rewardsBelowThreshold","No rewards above ${{threshold}} to display",{threshold:v}):s("crypto.noStakingRewards","No staking rewards found")}),e.jsx("p",{className:"text-sm",children:s("crypto.noStakingRewardsHint",'Click "Scan Rewards" to search for claimed rewards on the blockchain.')})]})]})}async function qs(t,s){return(await Ie.post(`/api/crypto/positions/${encodeURIComponent(t)}/close`,s)).data}async function Es(){return(await Ie.get("/api/crypto/positions/closed")).data}function Ts({group:t,lastSnapshotValueUsd:s,costBasisUsd:r,totalRewardsUsd:a,onClose:d,onSuccess:i}){var o;const{t:n}=G("common"),{data:m}=at(),p=((o=m==null?void 0:m.rates)==null?void 0:o.USD)||150,w=re(),[_,y]=u.useState(new Date().toISOString().slice(0,16)),[v,c]=u.useState(s),[R,k]=u.useState(Math.round(s*p)),[D,F]=u.useState(null),[l,b]=u.useState(`LP Exit: ${t.protocol} ${t.name}`),[h,N]=u.useState("");u.useEffect(()=>{k(Math.round(v*p))},[v,p]);const{data:j}=Q({queryKey:["accounts"],queryFn:()=>Et()}),S=(j==null?void 0:j.filter(C=>C.is_active&&(C.type==="bank"||C.type==="savings")))||[],$=r!==null?v-r+(a||0):null,P=r&&$!==null?$/r*100:null,A=t.tokens[0],x=(A==null?void 0:A.id)||"",M=(A==null?void 0:A.wallet_address)||"",g=Y({mutationFn:()=>{if(!D)throw new Error(n("crypto.selectAccount","Select destination account"));const C={exit_date:new Date(_).toISOString(),exit_value_usd:v,exit_value_jpy:R,destination_account_id:D,note:l||void 0,tx_hash:h||void 0,wallet_address:M,chain_id:t.chain_id,protocol:t.protocol,symbol:t.name};return qs(x,C)},onSuccess:()=>{w.invalidateQueries({queryKey:["closed-positions"]}),w.invalidateQueries({queryKey:["defi-positions"]}),w.invalidateQueries({queryKey:["accounts"]}),i(),d()}}),q=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4 overflow-hidden",style:{touchAction:"pan-y"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:d}),e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto overflow-x-hidden",onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 dark:text-white",children:n("crypto.closePosition","Close Position")}),e.jsx("button",{onClick:d,className:"p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg",children:e.jsx(pe,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-3",children:[e.jsxs("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:[t.protocol," - ",t.name]}),e.jsx("p",{className:"text-xs text-gray-500",children:t.chain_id.toUpperCase()})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[e.jsx(Be,{className:"w-4 h-4 inline mr-1"}),n("crypto.exitDate","Exit Date")]}),e.jsx("input",{type:"datetime-local",value:_,onChange:C=>y(C.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[e.jsx(ot,{className:"w-4 h-4 inline mr-1"}),n("crypto.exitValue","Exit Value")," (USD)"]}),e.jsx("input",{type:"number",step:"0.01",value:v,onChange:C=>c(parseFloat(C.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[n("crypto.exitValue","Exit Value")," (JPY)"]}),e.jsx("input",{type:"number",value:R,onChange:C=>k(parseInt(C.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[e.jsx(De,{className:"w-4 h-4 inline mr-1"}),n("crypto.destinationAccount","Destination Account")]}),e.jsxs("select",{value:D||"",onChange:C=>F(parseInt(C.target.value)||null),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white",children:[e.jsx("option",{value:"",children:n("select","Select...")}),S.map(C=>e.jsx("option",{value:C.id,children:C.name},C.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:n("note","Note")}),e.jsx("input",{type:"text",value:l,onChange:C=>b(C.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:["TX Hash (",n("optional","optional"),")"]}),e.jsx("input",{type:"text",value:h,onChange:C=>N(C.target.value),placeholder:"0x...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white font-mono text-sm"})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:n("crypto.pnlPreview","P&L Preview")}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:n("crypto.costBasis","Cost Basis")}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:r!==null?`$${r.toFixed(2)}`:"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:n("crypto.totalRewards","Total Rewards")}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:a?`$${a.toFixed(2)}`:"$0.00"})]}),e.jsxs("div",{className:"col-span-2 pt-2 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500",children:n("crypto.realizedPnl","Realized P&L")}),e.jsx("p",{className:`text-lg font-bold ${$!==null?$>=0?"text-green-600":"text-red-600":"text-gray-400"}`,children:$!==null?`${$>=0?"+":""}$${$.toFixed(2)} (${P==null?void 0:P.toFixed(1)}%)`:"N/A"})]})]})]}),g.error&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(qt,{className:"w-4 h-4"}),g.error.message]})]}),e.jsxs("div",{className:"flex gap-3 p-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("button",{onClick:d,className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800",children:n("cancel","Cancel")}),e.jsx("button",{onClick:()=>g.mutate(),disabled:!D||g.isPending,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50",children:g.isPending?n("loading","Loading..."):n("crypto.confirmClose","Confirm Close")})]})]})]});return typeof document>"u"?null:ke.createPortal(q,document.body)}function Os({group:t,onClose:s}){const[r,a]=u.useState("overview"),[d,i]=u.useState(!1),n=t.tokens[0],m=Ye({queries:t.tokens.map(l=>({queryKey:["position-history",l.id],queryFn:()=>Jt(l.id,30),retry:!1}))}),p=m.some(l=>l.isLoading),w=u.useMemo(()=>{const l=m.filter(N=>{var j;return(j=N.data)==null?void 0:j.snapshots}).flatMap(N=>N.data.snapshots);if(l.length===0)return null;const b=new Map;for(const N of l){const j=b.get(N.snapshot_date)||0;b.set(N.snapshot_date,j+Number(N.balance_usd))}return{snapshots:Array.from(b.entries()).map(([N,j])=>({snapshot_date:N,balance_usd:j}))}},[m]),_=Ye({queries:t.tokens.map(l=>({queryKey:["position-performance",l.id],queryFn:()=>Gt(l.id),retry:!1}))}),y=_.some(l=>l.isLoading),v=_.every(l=>!l.isLoading),c=u.useMemo(()=>{if(!v)return null;const l=_.filter(q=>q.data);if(l.length===0)return null;const b=l[0].data;if(l.length===1)return b;let h=0,N=0,j=0,S=0,$=0,P=!1,A=0,x=0;for(const q of l){const o=q.data;h+=Number(o.start_value_usd),N+=Number(o.current_value_usd),j+=Number(o.total_return_usd),S=Math.max(S,o.days_held),$+=o.snapshot_count,o.il_usd!=null&&(P=!0,A+=Number(o.il_usd)),o.hodl_value_usd!=null&&(x+=Number(o.hodl_value_usd))}const M=h>0?j/h*100:0;let g=null;if(S>=7&&h>0){const q=((N/h)**(365/S)-1)*100;Math.abs(q)<=500&&(g=q)}return{position_id:b.position_id,protocol:b.protocol,symbol:t.name,days_held:S,start_value_usd:h,current_value_usd:N,total_return_usd:j,total_return_pct:M,annualized_return_pct:g,current_apy:b.current_apy,snapshot_count:$,il_percentage:P&&h>0?A/h*100:null,il_usd:P?A:null,hodl_value_usd:P?x:null,lp_vs_hodl_usd:P?N-x:null,lp_outperformed_hodl:P?N>x:void 0}},[_,t.name,v]),{data:R}=Q({queryKey:["position-roi",n.id],queryFn:()=>ut(n.id),retry:!1}),k=p||y,D=l=>{const b=Number(l.balance);return b<1e-4?"<0.0001":b<1?b.toFixed(4):b.toFixed(2)},F=e.jsxs("div",{className:"fixed inset-0 z-[100001]",children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm",onClick:s}),e.jsx("div",{className:"fixed inset-0 z-[100002] flex items-center justify-center p-4 overflow-y-auto",children:e.jsxs("div",{className:"relative bg-white dark:bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90dvh] my-auto overflow-hidden",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-900 to-gray-800 dark:from-gray-800 dark:to-gray-900 p-6 text-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex -space-x-2",children:t.tokens.slice(0,3).map((l,b)=>l.logo_url?e.jsx("img",{src:l.logo_url,alt:l.symbol,className:"w-10 h-10 rounded-full border-2 border-white/20",style:{zIndex:t.tokens.length-b}},l.id):e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm border-2 border-white/20",style:{zIndex:t.tokens.length-b},children:l.symbol.slice(0,2)},l.id))}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:t.protocol}),e.jsx("p",{className:"text-gray-400 text-sm",children:t.name})]})]}),e.jsx("button",{onClick:s,className:"p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition-colors",children:e.jsx(pe,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-gray-400 text-sm mb-1",children:"Current Value"}),e.jsxs("p",{className:"text-4xl font-bold",children:["$",t.total_usd.toFixed(2)]}),e.jsx("div",{className:"flex items-center justify-center gap-2 mt-2 text-sm",children:e.jsx("span",{className:"text-gray-400",children:t.tokens.map((l,b)=>e.jsxs("span",{children:[b>0&&" + ",D(l)," ",l.symbol]},l.id))})})]})]}),e.jsxs("div",{className:"flex border-b border-gray-200 dark:border-gray-700",children:[e.jsx("button",{onClick:()=>a("overview"),className:B("flex-1 px-4 py-3 text-sm font-medium transition-colors",r==="overview"?"text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400":"text-gray-500 hover:text-gray-700"),children:"Gain/Loss"}),e.jsxs("button",{onClick:()=>a("rewards"),className:B("flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2",r==="rewards"?"text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400":"text-gray-500 hover:text-gray-700"),children:[e.jsx(Qe,{className:"w-4 h-4"}),"Rewards"]})]}),e.jsx("div",{className:"p-4 space-y-4 max-h-[50vh] overflow-y-auto",children:k?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(me,{size:"lg"})}):e.jsxs(e.Fragment,{children:[r==="overview"&&e.jsxs(e.Fragment,{children:[c&&e.jsxs(xe,{className:"overflow-hidden",children:[e.jsxs("div",{className:B("p-4 text-center",Number(c.total_return_pct)>=0?"bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20":"bg-gradient-to-br from-red-50 to-rose-50 dark:from-red-900/20 dark:to-rose-900/20"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[Number(c.total_return_pct)>=0?e.jsx(ps,{className:"w-5 h-5 text-green-600"}):e.jsx(us,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:B("text-sm font-medium",Number(c.total_return_pct)>=0?"text-green-700 dark:text-green-400":"text-red-700 dark:text-red-400"),children:"Total Return"})]}),e.jsxs("p",{className:B("text-3xl font-bold",Number(c.total_return_pct)>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"),children:[Number(c.total_return_pct)>=0?"+":"",c.total_return_pct.toFixed(2),"%"]}),e.jsxs("p",{className:B("text-lg font-semibold mt-1",Number(c.total_return_usd)>=0?"text-green-700 dark:text-green-400":"text-red-700 dark:text-red-400"),children:[Number(c.total_return_usd)>=0?"+":"","$",Math.abs(Number(c.total_return_usd)).toFixed(2)]})]}),e.jsxs("div",{className:"p-4 grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-gray-500 dark:text-gray-400 text-xs mb-1",children:[e.jsx(ot,{className:"w-3.5 h-3.5"}),"Invested"]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-white",children:["$",Number(c.start_value_usd).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-gray-500 dark:text-gray-400 text-xs mb-1",children:[e.jsx(vs,{className:"w-3.5 h-3.5"}),"Duration"]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-white",children:[c.days_held," days"]})]})]})]}),c&&c.annualized_return_pct!==null&&e.jsx(xe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Cs,{className:"w-4 h-4 text-indigo-500"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Annualized Return"})]}),e.jsxs("span",{className:B("font-bold text-lg",Number(c.annualized_return_pct)>=0?"text-green-600":"text-red-600"),children:[Number(c.annualized_return_pct)>=0?"+":"",c.annualized_return_pct.toFixed(2),"%"]})]})}),c&&c.current_apy!=null&&e.jsx(xe,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4 text-purple-500"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Current APY"})]}),e.jsxs("span",{className:"font-bold text-lg text-purple-600 dark:text-purple-400",children:[Number(c.current_apy).toFixed(2),"%"]})]})}),w&&w.snapshots.length>0&&e.jsxs(xe,{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-600 dark:text-gray-400 mb-3",children:"30-Day Performance"}),e.jsx("div",{className:"h-40",children:e.jsx(Ps,{snapshots:w.snapshots})})]}),e.jsx("button",{onClick:()=>i(!0),className:"w-full py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors",children:"Close Position"})]}),r==="rewards"&&e.jsx(e.Fragment,{children:t.protocol_module==="staked"?e.jsx($s,{source:"symbiotic"}):e.jsx(Ls,{positionId:n.id})})]})}),d&&e.jsx(Ts,{group:t,lastSnapshotValueUsd:t.total_usd,costBasisUsd:(R==null?void 0:R.cost_basis_usd)??null,totalRewardsUsd:(R==null?void 0:R.total_rewards_usd)??null,onClose:()=>i(!1),onSuccess:()=>{i(!1),s()}})]})})]});return typeof document>"u"?null:ke.createPortal(F,document.body)}function Bs({walletId:t}){const{t:s}=G(),r=re(),[a,d]=u.useState(new Set),[i,n]=u.useState(""),{data:m=[]}=Q({queryKey:["unattributed-rewards"],queryFn:gt}),{data:p}=Q({queryKey:["defi-positions",t],queryFn:()=>ht(t),enabled:!!t}),w=Y({mutationFn:({rewardIds:x,positionId:M})=>Xt(x,M),onSuccess:()=>{r.invalidateQueries({queryKey:["unattributed-rewards"]}),r.invalidateQueries({queryKey:["position-rewards"]}),d(new Set),n("")}}),[_,y]=u.useState(null),[v,c]=u.useState(null),[R,k]=u.useState(null),D=Y({mutationFn:x=>mt(x),onSuccess:x=>{c(s("crypto.transactionCreated","Transaction created: ${{amount}}",{amount:x.amount_usd.toFixed(2)})),r.invalidateQueries({queryKey:["unattributed-rewards"]}),r.invalidateQueries({queryKey:["transactions"]}),y(null),setTimeout(()=>c(null),5e3)},onError:x=>{k(x.message||s("crypto.transactionCreateError","Failed to create transaction")),y(null),setTimeout(()=>k(null),5e3)}});if(m.length===0)return null;const F=1,l=m.filter(x=>Number(x.reward_usd||0)>=F);if(l.length===0)return null;const b=(p==null?void 0:p.positions)||[],h=x=>`${Number(x.reward_amount).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:6})} ${x.reward_token_symbol||"tokens"}`,N=x=>new Date(x).toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"}),j=x=>{const M=new Set(a);M.has(x)?M.delete(x):M.add(x),d(M)},S=()=>{a.size===l.length?d(new Set):d(new Set(l.map(x=>x.id)))},$=l.length>0&&a.size===l.length,P=a.size>0,A=()=>{a.size===0||!i||w.mutate({rewardIds:Array.from(a),positionId:i})};return e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Tt,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-500"}),e.jsx("h3",{className:"font-medium text-yellow-800 dark:text-yellow-200",children:s("crypto.unattributedRewards",{count:l.length})})]}),e.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300 mb-4",children:s("crypto.unattributedRewardsDesc","These rewards need to be assigned to a position for ROI tracking.")}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3 mb-4 p-3 bg-white dark:bg-gray-800 rounded-lg border border-yellow-100 dark:border-gray-700",children:[e.jsxs("button",{type:"button",onClick:S,className:"flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors",children:[$?e.jsx(Je,{className:"h-4 w-4 text-primary-600"}):e.jsx(Ge,{className:"h-4 w-4"}),$?s("deselectAll","Deselect All"):s("selectAll","Select All")]}),e.jsxs("div",{className:"flex-1 flex flex-col sm:flex-row items-stretch sm:items-center gap-2",children:[e.jsxs("select",{value:i,onChange:x=>n(x.target.value),disabled:!P,className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-100 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx("option",{value:"",children:s("crypto.selectPosition","Select position...")}),b.map(x=>e.jsxs("option",{value:x.id,children:[x.protocol," - ",x.symbol]},x.id))]}),e.jsxs("button",{type:"button",onClick:A,disabled:!P||!i||w.isPending,className:"flex items-center justify-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-700 disabled:bg-gray-400 text-white text-sm font-medium rounded-md transition-colors disabled:cursor-not-allowed",children:[e.jsx(fs,{className:"h-4 w-4"}),w.isPending?s("assigning","Assigning..."):s("crypto.assignSelected","Assign {{count}} Selected",{count:a.size})]})]})]}),v&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(be,{className:"h-4 w-4"}),v]}),R&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-sm text-red-700 dark:text-red-300",children:[e.jsx(pe,{className:"h-4 w-4"}),R]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:l.map(x=>e.jsxs("div",{onClick:()=>j(x.id),className:`flex items-center gap-3 p-3 rounded-md border cursor-pointer transition-colors ${a.has(x.id)?"bg-primary-50 dark:bg-primary-900/20 border-primary-300 dark:border-primary-700":"bg-white dark:bg-gray-800 border-yellow-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750"}`,children:[e.jsx("div",{className:"flex-shrink-0",children:a.has(x.id)?e.jsx(Je,{className:"h-5 w-5 text-primary-600"}):e.jsx(Ge,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:h(x)}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[N(x.claimed_at)," via ",x.source,x.reward_usd&&e.jsxs("span",{className:"ml-2 text-green-600 dark:text-green-400",children:["â‰ˆ $",Number(x.reward_usd).toFixed(2)]})]})]}),x.reward_usd&&x.reward_usd>0&&e.jsx("div",{className:"flex-shrink-0",onClick:M=>M.stopPropagation(),children:x.transaction_id?e.jsxs("a",{href:`/transactions?id=${x.transaction_id}`,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/30 rounded hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors",children:[e.jsx(ze,{className:"h-3 w-3"}),s("crypto.viewTransaction","View Txn")]}):e.jsxs("button",{type:"button",onClick:()=>{y(x.id),D.mutate(x.id)},disabled:_===x.id,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-primary-700 dark:text-primary-300 bg-primary-100 dark:bg-primary-900/30 rounded hover:bg-primary-200 dark:hover:bg-primary-900/50 disabled:opacity-50 transition-colors",children:[_===x.id?e.jsx(Le,{className:"h-3 w-3 animate-spin"}):e.jsx(Pe,{className:"h-3 w-3"}),s("crypto.createTransaction","Create Txn")]})})]},x.id))}),P&&e.jsx("div",{className:"mt-3 pt-3 border-t border-yellow-200 dark:border-gray-700 text-sm text-yellow-700 dark:text-yellow-300",children:s("crypto.selectedRewards","{{count}} reward(s) selected",{count:a.size})})]})}const Is={deposit:"ðŸ’°",stake:"ðŸ”’",borrow:"ðŸ’¸",reward:"ðŸŽ",liquidity:"ðŸ’§"},zs={liquidity_pool:"LP",staking:"Staking",lending:"Lending",farming:"Farming",vault:"Vault"};function Qs(t){const s={};for(const r of t){const a=`${r.protocol}-${r.chain_id}-${r.name||r.token_name}-${r.position_type}`;s[a]||(s[a]={key:a,name:r.name||r.token_name,protocol:r.protocol,protocol_module:r.protocol_module,position_type:r.position_type,chain_id:r.chain_id,tokens:[],total_usd:0}),s[a].tokens.push(r),s[a].total_usd+=Number(r.balance_usd)}return Object.values(s)}function Ks({group:t,onClick:s,isPrivacyMode:r}){const a=t.chain_id,d=je[a],i=t.tokens[0],n=r?t.tokens.map(m=>`*** ${m.symbol}`).join(" + "):t.tokens.map(m=>{const p=Number(m.balance);return`${p<1e-4?"<0.0001":p<1?p.toFixed(4):p.toFixed(2)} ${m.symbol}`}).join(" + ");return e.jsxs("button",{onClick:()=>s(t),className:"w-full flex items-center justify-between py-3 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors text-left group",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"relative flex-shrink-0",children:t.tokens.length>1?e.jsxs("div",{className:"flex -space-x-2",children:[t.tokens.slice(0,3).map((m,p)=>m.logo_url?e.jsx("img",{src:m.logo_url,alt:m.symbol,className:"w-7 h-7 rounded-full border-2 border-white dark:border-gray-800",style:{zIndex:t.tokens.length-p},onError:w=>{w.target.style.display="none"}},m.id):e.jsx("div",{className:"w-7 h-7 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold border-2 border-white dark:border-gray-800",style:{zIndex:t.tokens.length-p},children:m.symbol.slice(0,2)},m.id)),t.tokens.length>3&&e.jsxs("div",{className:"w-7 h-7 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-xs font-medium border-2 border-white dark:border-gray-800",children:["+",t.tokens.length-3]})]}):i.logo_url?e.jsx("img",{src:i.logo_url,alt:i.symbol,className:"w-8 h-8 rounded-full",onError:m=>{m.target.style.display="none"}}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold",children:Is[t.position_type]||"ðŸ“ˆ"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-white truncate",children:t.protocol}),e.jsx("span",{className:"text-xs px-1.5 py-0.5 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded",children:zs[t.protocol_module]||t.protocol_module})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("span",{className:"truncate",children:t.name}),d&&e.jsxs("span",{className:"text-xs px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded",children:[d.icon," ",a.toUpperCase()]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:r?"$***":`$${t.total_usd.toFixed(2)}`}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 max-w-[180px] truncate",children:n})]}),e.jsx(lt,{className:"w-4 h-4 text-gray-400 group-hover:text-indigo-500 transition-colors"})]})]})}function et(){const{t}=G("common"),{currency:s}=nt(),{isPrivacyMode:r}=ve(),[a,d]=u.useState(null),i=Ne(),{data:n,isLoading:m}=Q({queryKey:["crypto-wallets"],queryFn:ct}),{data:p=[]}=Q({queryKey:["unattributed-rewards"],queryFn:gt}),{data:w,isLoading:_,refetch:y}=Q({queryKey:["crypto-defi-positions",n==null?void 0:n.map(h=>h.id)],queryFn:async()=>!n||n.length===0?[]:await Promise.all(n.map(N=>ht(N.id).catch(()=>({wallet_address:N.wallet_address,total_value_usd:0,positions:[],last_sync_at:null})))),enabled:!!n&&n.length>0}),v=(w==null?void 0:w.flatMap(h=>h.positions))||[],c=Qs(v),R=(w==null?void 0:w.reduce((h,N)=>h+Number(N.total_value_usd||0),0))||0,k=1/((i==null?void 0:i.USD)||.00667),D=Math.round(R*k),F=c.reduce((h,N)=>{const j=N.protocol;return h[j]||(h[j]=[]),h[j].push(N),h},{});if(m||_)return e.jsx(fe,{title:t("crypto.defiPositions"),badge:0,children:e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(me,{size:"md"})})});if(!n||n.length===0)return null;const b=p.length>0?`${c.length} Â· ${p.length} âš `:c.length;return e.jsxs(fe,{title:t("crypto.defiPositions"),badge:b,defaultOpen:c.length>0,children:[v.length>0&&e.jsx("div",{className:"mb-4 p-4 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:t("crypto.totalDefiValue")}),e.jsx("p",{className:"text-2xl font-bold text-indigo-600 dark:text-indigo-400",children:se(D,s,i,!1,r)})]}),e.jsx("button",{onClick:()=>y(),className:"p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors",title:t("crypto.refresh"),children:e.jsx(ie,{className:"w-5 h-5"})})]})}),n[0]&&e.jsx("div",{className:"mb-4",children:e.jsx(Bs,{walletId:n[0].id})}),c.length>0?e.jsx("div",{className:"space-y-4",children:Object.entries(F).sort(([,h],[,N])=>{const j=h.reduce(($,P)=>$+P.total_usd,0);return N.reduce(($,P)=>$+P.total_usd,0)-j}).map(([h,N])=>e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsx("div",{className:"px-4 py-2 bg-gray-100 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:h}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:r?"$***":`$${N.reduce((j,S)=>j+S.total_usd,0).toFixed(2)}`})]})}),e.jsx("div",{className:"divide-y divide-gray-100 dark:divide-gray-700/50",children:N.sort((j,S)=>S.total_usd-j.total_usd).map(j=>e.jsx(Ks,{group:j,onClick:d,isPrivacyMode:r},j.key))})]},h))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ws,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:t("crypto.noDefiPositions")}),e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500 mt-1",children:t("crypto.noDefiPositionsDescription")})]}),a&&e.jsx(Os,{group:a,onClose:()=>d(null)})]})}function tt(){const{t}=G("common"),[s,r]=u.useState(!1),{data:a,isLoading:d}=Q({queryKey:["closed-positions"],queryFn:Es});return d||!a||a.total_closed===0?null:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700",children:[e.jsxs("button",{onClick:()=>r(!s),className:"w-full flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(xs,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h3",{className:"font-medium text-gray-900 dark:text-white",children:t("crypto.closedPositions","Closed Positions")}),e.jsxs("p",{className:"text-sm text-gray-500",children:[a.total_closed," ",t("crypto.positions","positions")]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[a.total_realized_pnl_jpy!==null&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500",children:t("crypto.totalPnl","Total P&L")}),e.jsxs("p",{className:`font-medium ${a.total_realized_pnl_jpy>=0?"text-green-600":"text-red-600"}`,children:[a.total_realized_pnl_jpy>=0?"+":"",Se(a.total_realized_pnl_jpy,"JPY")]})]}),s?e.jsx(yt,{className:"w-5 h-5 text-gray-500"}):e.jsx(_e,{className:"w-5 h-5 text-gray-500"})]})]}),s&&e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-4 space-y-3",children:a.positions.map(i=>{const n=je[i.chain_id],m=i.realized_pnl_jpy!==null&&i.realized_pnl_jpy>=0;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:[i.protocol," - ",i.symbol]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[n&&e.jsx("span",{children:n.icon}),e.jsx("span",{children:new Date(i.exit_date).toLocaleDateString()})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:Se(i.exit_value_jpy,"JPY")}),i.realized_pnl_jpy!==null&&e.jsxs("div",{className:`flex items-center justify-end gap-1 text-sm ${m?"text-green-600":"text-red-600"}`,children:[m?e.jsx(we,{className:"w-3 h-3"}):e.jsx(Ot,{className:"w-3 h-3"}),m?"+":"",Se(i.realized_pnl_jpy,"JPY"),i.realized_pnl_pct!==null&&e.jsxs("span",{className:"text-xs",children:["(",i.realized_pnl_pct.toFixed(1),"%)"]})]})]})]},i.id)})})]})}async function Vs(t){return(await Ie.post("/api/transfers/",t)).data}const de={JPY:"Â¥",USD:"$",VND:"â‚«"};function ce(t){const s=t.replace(/[^\d]/g,"");return s?parseInt(s).toLocaleString("en-US"):""}function X(t){return parseInt(t.replace(/[,.\s]/g,""),10)||0}function Hs({isOpen:t,onClose:s}){const{t:r}=G("common"),a=re(),{data:d}=dt(),i=Ne(),[n,m]=u.useState(null),[p,w]=u.useState(null),[_,y]=u.useState(""),[v,c]=u.useState(""),[R,k]=u.useState(""),[D,F]=u.useState(new Date().toISOString().split("T")[0]),[l,b]=u.useState(""),[h,N]=u.useState({}),j=u.useMemo(()=>d==null?void 0:d.find(g=>g.id===n),[d,n]),S=u.useMemo(()=>d==null?void 0:d.find(g=>g.id===p),[d,p]),$=u.useMemo(()=>(d==null?void 0:d.filter(g=>g.id!==n))||[],[d,n]);u.useEffect(()=>{if(!j||!S||!_||!i)return;const g=X(_);if(g<=0)return;if(j.currency===S.currency){c(ce(g.toString()));return}const q=i[j.currency]||1,o=i[S.currency]||1,C=g/q,Z=Math.round(C*o);c(ce(Z.toString()))},[j,S,_,i]),u.useEffect(()=>{var g;t&&(m(((g=d==null?void 0:d[0])==null?void 0:g.id)||null),w(null),y(""),c(""),k(""),F(new Date().toISOString().split("T")[0]),b(""),N({}))},[t,d]);const P=Y({mutationFn:Vs,onSuccess:()=>{a.invalidateQueries({queryKey:["accounts"]}),a.invalidateQueries({queryKey:["transactions"]}),a.invalidateQueries({queryKey:["transfers"]}),a.invalidateQueries({queryKey:["analytics"]}),s()}}),A=()=>{const g={};return n||(g.fromAccount=r("transfer.errors.fromRequired")),p||(g.toAccount=r("transfer.errors.toRequired")),n&&p&&n===p&&(g.toAccount=r("transfer.errors.sameAccount")),(!_||X(_)<=0)&&(g.fromAmount=r("transfer.errors.amountRequired")),(!v||X(v)<=0)&&(g.toAmount=r("transfer.errors.amountRequired")),N(g),Object.keys(g).length===0},x=g=>{if(g.preventDefault(),!A())return;const q=(j==null?void 0:j.currency)||"JPY",o=(S==null?void 0:S.currency)||"JPY",C={from_account_id:n,to_account_id:p,from_amount:Fe(X(_),q),to_amount:Fe(X(v),o),fee_amount:Fe(X(R)||0,q),date:D,description:l.trim()||void 0};j&&S&&j.currency!==S.currency&&(C.exchange_rate=X(v)/X(_)),P.mutate(C)};if(!t)return null;const M=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 animate-modal-backdrop",onClick:s}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 dark:border-gray-700 px-6 py-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:r("transfer.title")}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:e.jsx(pe,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:x,className:"p-6 space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:r("transfer.fromAccount")}),e.jsxs("select",{value:n||"",onChange:g=>m(g.target.value?parseInt(g.target.value):null),className:B("w-full h-12 px-4 border rounded-lg","bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",h.fromAccount?"border-red-500":"border-gray-300"),children:[e.jsx("option",{value:"",children:r("transfer.selectAccount")}),d==null?void 0:d.map(g=>e.jsxs("option",{value:g.id,children:[g.name," (",de[g.currency]||g.currency,")"]},g.id))]}),h.fromAccount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:h.fromAccount})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(Bt,{className:"w-6 h-6 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:r("transfer.toAccount")}),e.jsxs("select",{value:p||"",onChange:g=>w(g.target.value?parseInt(g.target.value):null),className:B("w-full h-12 px-4 border rounded-lg","bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",h.toAccount?"border-red-500":"border-gray-300"),children:[e.jsx("option",{value:"",children:r("transfer.selectAccount")}),$.map(g=>e.jsxs("option",{value:g.id,children:[g.name," (",de[g.currency]||g.currency,")"]},g.id))]}),h.toAccount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:h.toAccount})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:r("transfer.amount")}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-gray-500",children:j?de[j.currency]||j.currency:"Â¥"}),e.jsx("input",{type:"text",inputMode:"numeric",value:_,onChange:g=>y(ce(g.target.value)),className:B("w-full h-12 pl-10 pr-4 border rounded-lg text-right","dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",h.fromAmount?"border-red-500":"border-gray-300"),placeholder:"0"})]}),h.fromAmount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:h.fromAmount})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:r("transfer.convertedAmount")}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-gray-500",children:S?de[S.currency]||S.currency:"Â¥"}),e.jsx("input",{type:"text",inputMode:"numeric",value:v,onChange:g=>c(ce(g.target.value)),className:B("w-full h-12 pl-10 pr-4 border rounded-lg text-right","dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",h.toAmount?"border-red-500":"border-gray-300"),placeholder:"0"})]}),h.toAmount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:h.toAmount})]})]}),j&&S&&j.currency!==S.currency&&_&&v&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["1 ",j.currency," â‰ˆ ",(X(v)/X(_)).toFixed(4)," ",S.currency]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[r("transfer.fee")," (",r("optional"),")"]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-gray-500",children:j?de[j.currency]||j.currency:"Â¥"}),e.jsx("input",{type:"text",inputMode:"numeric",value:R,onChange:g=>k(ce(g.target.value)),className:"w-full h-12 pl-10 pr-4 border border-gray-300 rounded-lg text-right dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",placeholder:"0"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:r("transfer.date")}),e.jsx("input",{type:"date",value:D,onChange:g=>F(g.target.value),className:"w-full h-12 px-4 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[r("transfer.description")," (",r("optional"),")"]}),e.jsx("input",{type:"text",value:l,onChange:g=>b(g.target.value),className:"w-full h-12 px-4 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",placeholder:r("transfer.descriptionPlaceholder")})]}),P.isError&&e.jsx("p",{className:"text-sm text-red-500 text-center",children:r("transfer.error")}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx(ue,{type:"button",variant:"outline",onClick:s,className:"flex-1 h-12",children:r("cancel")}),e.jsx(ue,{type:"submit",loading:P.isPending,className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700",children:r("transfer.create")})]})]})]})]});return typeof document>"u"?null:ke.createPortal(M,document.body)}const pt="accounts_collapsed_sections";function Us(){try{const t=localStorage.getItem(pt);if(t)return new Set(JSON.parse(t))}catch{}return new Set}function Ws(t){localStorage.setItem(pt,JSON.stringify([...t]))}function Ys(){const{t}=G("common"),[s,r]=u.useState(!1),[a,d]=u.useState(!1),[i,n]=u.useState(!1),[m,p]=u.useState(!1),[w,_]=u.useState(!1),[y,v]=u.useState(null),[c,R]=u.useState(null),[k,D]=u.useState(()=>Us());u.useEffect(()=>{Ws(k)},[k]),u.useEffect(()=>{const A=()=>{p(!0)},x=()=>{_(!0)};return window.addEventListener("open-add-transaction-modal",A),window.addEventListener("open-receipt-scanner",x),()=>{window.removeEventListener("open-add-transaction-modal",A),window.removeEventListener("open-receipt-scanner",x)}},[]);const F=u.useCallback(A=>{D(x=>{const M=new Set(x);return M.has(A)?M.delete(A):M.add(A),M})},[]),{data:l,isLoading:b,error:h}=dt(s),N=()=>{v(null),d(!0)},j=A=>{v(A),d(!0)},S=()=>{d(!1),v(null)},$=l==null?void 0:l.reduce((A,x)=>{const M=x.type;return A[M]||(A[M]=[]),A[M].push(x),A},{}),P=["bank","savings","cash","credit_card","investment","crypto","receivable","other"];return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:t("account.accounts")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-1",children:t("account.manageYourAccounts")})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>n(!0),className:"inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(hs,{className:"w-5 h-5"}),t("transfer.title")]}),e.jsxs("button",{onClick:N,className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:2,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"})}),t("account.createAccount")]})]})]}),e.jsx("div",{className:"mt-4 flex items-center gap-4",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:s,onChange:A=>r(A.target.checked),className:"rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 dark:bg-gray-700"}),t("account.showInactive")]})})]}),b&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}),h&&e.jsx("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6",children:e.jsxs("p",{className:"text-red-700 dark:text-red-400",children:[t("account.errors.loadFailed"),": ",h.message]})}),!b&&!h&&(!l||l.length===0)&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-gray-700 mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-8 h-8 text-gray-400",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"})})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:t("account.noAccounts")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:t("account.createFirstAccount")}),e.jsxs("button",{onClick:N,className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:2,stroke:"currentColor",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"})}),t("account.createAccount")]})]}),!b&&!h&&l&&l.length>0&&e.jsxs("div",{className:"space-y-8",children:[P.map(A=>{const x=$==null?void 0:$[A];if(!x||x.length===0)return null;const M=k.has(A);return e.jsxs("div",{children:[e.jsxs("button",{type:"button",onClick:()=>F(A),className:"w-full flex items-center justify-between mb-4 group cursor-pointer",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white flex items-center gap-2",children:[t(`account.type.${A}`),e.jsxs("span",{className:"text-sm font-normal text-gray-500 dark:text-gray-400",children:["(",x.length,")"]})]}),e.jsx(_e,{className:`w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform duration-200 ${M?"-rotate-90":""}`})]}),e.jsx("div",{className:`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 transition-all duration-200 ease-in-out ${M?"max-h-0 opacity-0 overflow-hidden":"max-h-[2000px] opacity-100"}`,children:x.map(g=>e.jsx(Rs,{account:g,onEdit:j,onAddTransaction:q=>{R(q),p(!0)}},g.id))})]},A)}),e.jsx(Ze,{}),e.jsx(et,{}),e.jsx(tt,{})]}),!b&&!h&&(!l||l.length===0)&&e.jsxs("div",{className:"mt-8 space-y-6",children:[e.jsx(Ze,{}),e.jsx(et,{}),e.jsx(tt,{})]}),e.jsx(Ms,{isOpen:a,onClose:S,editingAccountId:y}),e.jsx(Hs,{isOpen:i,onClose:()=>n(!1)}),e.jsx(ls,{isOpen:m,onClose:()=>{p(!1),R(null)},defaultAccountId:c}),e.jsx(is,{isOpen:w,onClose:()=>_(!1),onScanComplete:()=>_(!1)})]})}const or=It("/accounts")({component:Ys});export{or as Route};

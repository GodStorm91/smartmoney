import{u as E,J as O,a1 as Z,r as l,a3 as F,j as e,X as H,l as b,I as M,B as P,v as $,z as I,C as ee,as as te,P as U,R as ae,i as re}from"./index-X-uCg_76.js";import{R as se}from"./RecurringTransactionsList-CYvO-VPS.js";import{S as J}from"./Select-DnyC9QYO.js";import{R as ne}from"./RecurringOptions-nYiHot5Y.js";import{d as ce}from"./useCategories-BE9aRRvq.js";import{c as le,u as oe,d as ie,f as ue}from"./recurring-service-ChfyxMdN.js";import{C as de}from"./chevron-up-BdJ3y48Y.js";import{C as me}from"./chevron-down-K9sNSf8Y.js";function ge({isOpen:i,onClose:c,editItem:s,initialSuggestion:n}){const{t:r}=E("common"),d=O(),{data:u}=Z(),{data:o}=ce(),x=(a=[])=>a.flatMap(g=>[{name:g.name},...g.children.map(V=>({name:V.name}))]),q=x(o==null?void 0:o.expense),R=x(o==null?void 0:o.income),[f,y]=l.useState(""),[t,m]=l.useState(""),[T,v]=l.useState(""),[j,k]=l.useState(null),[N,h]=l.useState(!1),[p,w]=l.useState("monthly"),[A,S]=l.useState(0),[L,C]=l.useState(1),[Q,_]=l.useState(7),[K,D]=l.useState(new Date().toISOString().split("T")[0]);l.useEffect(()=>{i&&s?(y(s.description),m(Math.abs(s.amount).toString()),v(s.category),k(s.account_id),h(s.is_income),w(s.frequency),S(s.day_of_week??0),C(s.day_of_month??1),_(s.interval_days??7),D(s.next_run_date)):i&&n?(y(n.description),m(n.amount.toString()),v(n.category),k(null),h(n.is_income),w(n.frequency),S(n.day_of_week??0),C(n.day_of_month??new Date().getDate()),_(n.interval_days??14),D(new Date().toISOString().split("T")[0])):i&&(y(""),m(""),v(""),k(null),h(!1),w("monthly"),S(0),C(new Date().getDate()),_(7),D(new Date().toISOString().split("T")[0]))},[i,s,n]);const z=F({mutationFn:le,onSuccess:()=>{d.invalidateQueries({queryKey:["recurring-transactions"]}),c()}}),Y=F({mutationFn:({id:a,data:g})=>oe(a,g),onSuccess:()=>{d.invalidateQueries({queryKey:["recurring-transactions"]}),c()}}),W=a=>{a.preventDefault();const g={description:f,amount:parseInt(t,10),category:T,account_id:j,is_income:N,frequency:p,day_of_week:p==="weekly"?A:null,day_of_month:p==="monthly"?L:null,interval_days:p==="custom"?Q:null,start_date:K};s?Y.mutate({id:s.id,data:g}):z.mutate(g)},X=N?R:q,B=z.isPending||Y.isPending;if(!i)return null;const G=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:c}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl w-[calc(100%-2rem)] max-w-lg max-h-[90vh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:r(s?"recurring.edit":"recurring.add")}),e.jsx("button",{onClick:c,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:e.jsx(H,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:W,className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:r("transaction.type")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>h(!1),className:b("flex-1 py-2 px-4 rounded-lg font-medium transition-colors",N?"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400":"bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300"),children:r("transaction.expense")}),e.jsx("button",{type:"button",onClick:()=>h(!0),className:b("flex-1 py-2 px-4 rounded-lg font-medium transition-colors",N?"bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400"),children:r("transaction.income")})]})]}),e.jsx(M,{label:r("transaction.description"),value:f,onChange:a=>y(a.target.value),placeholder:r("recurring.descriptionPlaceholder","e.g., Monthly rent"),required:!0}),e.jsx(M,{label:r("transaction.amount"),type:"number",value:t,onChange:a=>m(a.target.value),placeholder:"0",min:"1",required:!0}),e.jsx(J,{label:r("transaction.category"),value:T,onChange:a=>v(a.target.value),options:[{value:"",label:r("transaction.selectCategory")},...X.map(a=>({value:a.name,label:a.name}))],required:!0}),e.jsx(J,{label:r("transaction.account"),value:(j==null?void 0:j.toString())??"",onChange:a=>k(a.target.value?parseInt(a.target.value,10):null),options:[{value:"",label:r("transaction.selectAccount","Select account (optional)")},...(u==null?void 0:u.map(a=>({value:a.id.toString(),label:a.name})))??[]]}),e.jsx(ne,{frequency:p,setFrequency:w,dayOfWeek:A,setDayOfWeek:S,dayOfMonth:L,setDayOfMonth:C,intervalDays:Q,setIntervalDays:_}),e.jsx(M,{label:r("recurring.startDate"),type:"date",value:K,onChange:a=>D(a.target.value),required:!0}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(P,{type:"button",variant:"outline",onClick:c,className:"flex-1",children:r("button.cancel")}),e.jsx(P,{type:"submit",disabled:B,className:"flex-1",children:B?r("button.saving","Saving..."):r("button.save")})]})]})]})]});return typeof document>"u"?null:$.createPortal(G,document.body)}const xe={JPY:"Â¥"};function ye({onCreateFromSuggestion:i}){const{t:c}=E("common"),s=O(),[n,r]=l.useState(!0),[d,u]=l.useState(null),{data:o,isLoading:x}=I({queryKey:["recurring-suggestions"],queryFn:()=>ue(3),staleTime:5*60*1e3}),q=F({mutationFn:ie,onSuccess:()=>{s.invalidateQueries({queryKey:["recurring-suggestions"]}),u(null)},onError:()=>{u(null)}}),R=(t,m)=>{m.stopPropagation(),u(t),q.mutate(t)},f=t=>{switch(t.frequency){case"weekly":return c("recurring.weekly");case"monthly":return c("recurring.monthly");case"custom":return c("recurring.everyNDays",{n:t.interval_days??14});default:return t.frequency}},y=t=>t>=80?"bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300":t>=60?"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300";return x||!o||o.length===0?null:e.jsxs(ee,{className:"mb-6 border-l-4 border-l-amber-400 bg-amber-50/50 dark:bg-amber-950/20",children:[e.jsxs("button",{onClick:()=>r(!n),className:"w-full flex items-center justify-between text-left",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-amber-100 dark:bg-amber-900/50 rounded-lg",children:e.jsx(te,{className:"w-5 h-5 text-amber-600 dark:text-amber-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:c("recurring.suggestions.title","Detected Patterns")}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:c("recurring.suggestions.subtitle","{{count}} potential recurring transactions found",{count:o.length})})]})]}),n?e.jsx(de,{className:"w-5 h-5 text-gray-400"}):e.jsx(me,{className:"w-5 h-5 text-gray-400"})]}),n&&e.jsx("div",{className:"mt-4 space-y-3",children:o.map(t=>e.jsx("div",{className:b("p-4 rounded-lg border bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700","transition-opacity",d===t.hash&&"opacity-50"),children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-gray-100 truncate",children:t.description}),e.jsxs("span",{className:b("px-2 py-0.5 text-xs font-medium rounded-full",y(t.confidence)),children:[t.confidence,"%"]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 mt-1 text-sm text-gray-500 dark:text-gray-400",children:[e.jsxs("span",{className:b("font-numbers",t.is_income?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"),children:[t.is_income?"+":"-",xe.JPY,t.amount.toLocaleString()]}),e.jsx("span",{children:t.category}),e.jsx("span",{children:f(t)}),e.jsx("span",{className:"text-xs",children:c("recurring.suggestions.occurrences","{{count}} times",{count:t.occurrences})})]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsxs(P,{size:"sm",variant:"primary",onClick:()=>i(t),className:"gap-1",children:[e.jsx(U,{className:"w-4 h-4"}),c("button.create")]}),e.jsx("button",{onClick:m=>R(t.hash,m),disabled:d===t.hash,className:"p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors",title:c("recurring.suggestions.dismiss","Dismiss"),children:e.jsx(H,{className:"w-4 h-4"})})]})]})},t.hash))})]})}function he(){const{t:i}=E("common"),c=O(),[s,n]=l.useState(!1),[r,d]=l.useState(null),u=x=>{d(x),n(!0)},o=()=>{n(!1),d(null),c.invalidateQueries({queryKey:["recurring-suggestions"]})};return e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ae,{className:"w-8 h-8 text-blue-500"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:i("recurring.pageTitle","Recurring Transactions")}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:i("recurring.pageSubtitle","Automate your regular income and expenses")})]})]}),e.jsxs("button",{onClick:()=>n(!0),className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(U,{className:"w-5 h-5"}),i("recurring.add","Add Recurring")]})]}),e.jsx(ye,{onCreateFromSuggestion:u}),e.jsx(se,{}),e.jsx(ge,{isOpen:s,onClose:o,initialSuggestion:r})]})}const Se=re("/recurring")({component:he});export{Se as Route};

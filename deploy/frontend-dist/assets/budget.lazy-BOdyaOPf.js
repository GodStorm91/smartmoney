import{j as e,u as t,e as a,c as s,k as r,m as n}from"./vendor-tanstack-CNAyyoyW.js";import{r as l}from"./vendor-react-Bx4JnVfy.js";import{l as o,C as i,B as d,I as c,U as g,c as m,V as u,W as x,X as h,Y as b,L as p,Z as y,_ as j,$ as v}from"./index-CL4Qiyvp.js";import{u as f}from"./vendor-i18n-BrrOrGm_.js";import{T as N,w as k,C as w,F as C,ab as _,P as S,ac as M,D as P,ad as D,ae as A,u as B,v as F,X as $,af as I,a3 as T,ag as E,O as q}from"./vendor-icons-BP-EQ_TG.js";import{k as L,d as O}from"./recurring-service-DFZkC56R.js";import"./vendor-recharts-BrNIwK9z.js";import"./vendor-date-BkGg5e1q.js";function U(e,t=0){if(!e&&0!==e)return"";const a="string"==typeof e?parseFloat(e):e;return isNaN(a)?"":new Intl.NumberFormat("en-US",{minimumFractionDigits:t,maximumFractionDigits:t}).format(a)}function K({onGenerate:t,isLoading:a,error:s,suggestions:r}){const{t:n}=f("common"),{currency:g}=o(),[m,u]=l.useState(""),[x,h]=l.useState(!1),b=function(e){return{JPY:"¥",USD:"$",VND:"₫",EUR:"€",GBP:"£"}[e]||e}(g),p=function(e){return["VND"].includes(e)?"suffix":"prefix"}(g),y=function(e){return{JPY:0,VND:0,KRW:0,USD:2,EUR:2,GBP:2}[e]??0}(g);l.useEffect(()=>{if((null==r?void 0:r.previous_income)&&!x&&!m){const e=r.previous_income/Math.pow(10,y);u(U(e,y)),h(!0)}},[r,x,m,y]);return e.jsxs("div",{className:"space-y-4",children:[(null==r?void 0:r.has_previous)&&r.previous_month&&e.jsx(i,{className:"p-6 border-blue-200 dark:border-blue-800 bg-blue-50/50 dark:bg-blue-900/20",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 p-2 bg-blue-100 dark:bg-blue-800 rounded-lg",children:e.jsx("svg",{className:"w-5 h-5 text-blue-600 dark:text-blue-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-800 dark:text-blue-200 mb-1",children:n("budget.previousBudgetFound",{month:(e=>{const[t,a]=e.split("-");return new Date(parseInt(t),parseInt(a)-1).toLocaleDateString(void 0,{month:"long",year:"numeric"})})(r.previous_month)})}),e.jsx("p",{className:"text-sm text-blue-600 dark:text-blue-300 mb-3",children:n("budget.cloneDescription")}),e.jsx(d,{onClick:()=>{(null==r?void 0:r.previous_income)&&t(r.previous_income)},loading:a,className:"w-full sm:w-auto",children:n("budget.clonePreviousMonth")})]})]})}),(null==r?void 0:r.has_previous)&&e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"w-full border-t border-gray-200 dark:border-gray-700"})}),e.jsx("div",{className:"relative flex justify-center text-sm",children:e.jsx("span",{className:"px-3 bg-gray-50 dark:bg-gray-900 text-gray-500 dark:text-gray-400",children:n("budget.orCreateNew")})})]}),e.jsxs(i,{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4",children:n("budget.generateTitle")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:n("budget.generateDescription")}),e.jsxs("form",{onSubmit:e=>{e.preventDefault();const a=function(e){if(!e)return 0;const t=e.replace(/,/g,""),a=parseFloat(t);return isNaN(a)?0:a}(m),s=Math.round(a*Math.pow(10,y));s>0&&(t(s),u(""))},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:n("budget.monthlyIncome")}),e.jsxs("div",{className:"relative",children:["prefix"===p&&e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm font-medium",children:b})}),e.jsx(c,{type:"text",inputMode:"decimal",value:m,onChange:e=>{const t=e.target.value.replace(/[^\d.]/g,"");if(t){const e=parseFloat(t);isNaN(e)||u(U(e,y))}else u("")},placeholder:U(5e5,y),required:!0,disabled:a,className:"prefix"===p?"pl-8":"pr-10"}),"suffix"===p&&e.jsx("div",{className:"absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm font-medium",children:b})})]}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:[n("budget.incomeHint"),(null==r?void 0:r.previous_income)&&e.jsxs("span",{className:"ml-2 text-blue-600 dark:text-blue-400",children:["(",n("budget.previousIncome"),": ",b,U(r.previous_income/Math.pow(10,y),y),")"]})]})]}),e.jsx(d,{type:"submit",loading:a,disabled:!m,className:"w-full",children:n("budget.generateButton")}),s&&e.jsx("p",{className:"text-sm text-red-600 mt-2",children:n("budget.generateError")})]})]})]})}function R({budget:t,totalAllocated:a,isDraft:s,previousMonth:r,onRegenerateClick:n,onSaveClick:l,isSaving:o}){var c;const{t:u,i18n:x}=f("common"),h=t.language||"ja",b=x.language,p=t.advice&&h!==b,y=r?t.monthly_income-r.monthly_income:0,j=r?a-((null==(c=r.allocations)?void 0:c.reduce((e,t)=>e+t.amount,0))||0):0;return e.jsxs(i,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-xl font-semibold",children:u("budget.currentBudget")}),s&&e.jsx("span",{className:"px-2 py-1 text-xs font-medium bg-amber-100 text-amber-800 rounded",children:u("budget.draft")})]}),e.jsx("p",{className:"text-sm text-gray-500",children:t.month})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",onClick:n,children:u("budget.regenerate")}),s&&e.jsx(d,{onClick:l,disabled:o,children:u(o?"budget.saving":"budget.save")})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:u("budget.monthlyIncome")}),e.jsx("p",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:g(t.monthly_income)}),r&&0!==y&&e.jsxs("div",{className:m("flex items-center gap-1 mt-1 text-xs",y>0?"text-green-600":"text-red-600"),children:[y>0?e.jsx(N,{className:"w-3 h-3"}):e.jsx(k,{className:"w-3 h-3"}),e.jsxs("span",{children:[y>0?"+":"",g(y)]})]})]}),void 0!==t.savings_target&&t.savings_target>0&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/30 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:u("budget.savingsTarget")}),e.jsx("p",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:g(t.savings_target)})]}),void 0!==t.carry_over&&0!==t.carry_over&&e.jsxs("div",{className:"p-4 rounded-lg "+(t.carry_over>0?"bg-teal-50 dark:bg-teal-900/30":"bg-orange-50 dark:bg-orange-900/30"),children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:u("budget.carryOver")}),e.jsxs("p",{className:"text-2xl font-bold "+(t.carry_over>0?"text-teal-600 dark:text-teal-400":"text-orange-600 dark:text-orange-400"),children:[t.carry_over>0?"+":"",g(t.carry_over)]})]}),e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:u("budget.totalAllocated")}),e.jsx("p",{className:"text-2xl font-bold text-purple-600 dark:text-purple-400",children:g(a)}),r&&0!==j&&e.jsxs("div",{className:m("flex items-center gap-1 mt-1 text-xs",j>0?"text-red-600":"text-green-600"),children:[j>0?e.jsx(N,{className:"w-3 h-3"}):e.jsx(k,{className:"w-3 h-3"}),e.jsxs("span",{children:[j>0?"+":"",g(j)]})]})]})]}),t.advice&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-amber-800 dark:text-amber-300 mb-1",children:u("budget.aiAdvice")}),e.jsx("p",{className:"text-amber-700 dark:text-amber-400",children:t.advice}),p&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-amber-200 dark:border-amber-700 flex items-start gap-2",children:[e.jsx(w,{className:"w-4 h-4 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-amber-600 dark:text-amber-400",children:u("budget.languageMismatchNotice")})]})]})]})}function z({onSubmit:t,onCancel:a,isLoading:s}){const{t:r}=f("common"),[n,o]=l.useState("");return e.jsxs(i,{className:"p-6 border-blue-200 bg-blue-50",children:[e.jsx("h4",{className:"font-semibold mb-3",children:r("budget.feedbackTitle")}),e.jsxs("form",{onSubmit:e=>{e.preventDefault(),n.trim()&&(t(n.trim()),o(""))},className:"space-y-4",children:[e.jsx("textarea",{value:n,onChange:e=>o(e.target.value),placeholder:r("budget.feedbackPlaceholder"),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 min-h-[100px]",disabled:s,required:!0}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{type:"submit",disabled:s||!n.trim(),children:r(s?"budget.regenerating":"budget.submitFeedback")}),e.jsx(d,{type:"button",variant:"outline",onClick:a,children:r("common.cancel")})]})]})]})}function V({budget:a,tracking:s}){const{t:r}=f("common"),{data:n}=t({queryKey:["recurring-monthly-summary",a.month],queryFn:()=>L(a.month),staleTime:3e5}),o=l.useMemo(()=>{const[e,t]=a.month.split("-").map(Number),r=new Date(e,t,0).getDate(),l=r-s.days_remaining,o=Math.round(l/r*100),i=(null==n?void 0:n.paid_this_month)??0,d=(null==n?void 0:n.upcoming_this_month)??0,c=(null==n?void 0:n.upcoming_count)??0;if(l<=0)return{daysInMonth:r,daysElapsed:0,progressPercent:0,dailyAvg:0,variableSpending:0,variableProjection:0,upcomingBills:d,upcomingCount:c,projectedSpending:d,projectedSavings:a.monthly_income-d,isOnTrack:a.monthly_income-d>=(a.savings_target||0)};const g=Math.max(0,s.total_spent-i),m=g+g/l*s.days_remaining,u=m+d,x=s.total_spent/l,h=a.monthly_income-u;return{daysInMonth:r,daysElapsed:l,progressPercent:o,dailyAvg:Math.round(x),variableSpending:Math.round(g),variableProjection:Math.round(m),upcomingBills:d,upcomingCount:c,projectedSpending:Math.round(u),projectedSavings:Math.round(h),isOnTrack:h>=(a.savings_target||0)}},[a,s,n]);return e.jsxs(i,{className:"p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(C,{className:"w-5 h-5 text-gray-500"}),r("budget.projection.title","Spending Projection")]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:r("budget.projection.monthProgress","Month Progress")}),e.jsxs("span",{className:"font-medium",children:[o.daysElapsed," / ",o.daysInMonth," ",r("budget.projection.days","days")]})]}),e.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 transition-all duration-500",style:{width:`${o.progressPercent}%`}})}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1 text-right",children:[o.progressPercent,"% ",r("budget.projection.elapsed","elapsed")]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:r("budget.projection.spentSoFar","Spent so far")}),e.jsx("p",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:g(s.total_spent)})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-1",children:r("budget.projection.dailyAvg","Daily average")}),e.jsx("p",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:g(o.dailyAvg)})]})]}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-3",children:r("budget.projection.projectedByMonthEnd","Projected by month end")}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:r("budget.projection.variableSpending","Variable spending")}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:g(o.variableProjection)})]}),o.upcomingBills>0&&e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("span",{className:"text-gray-500 dark:text-gray-400 flex items-center gap-1",children:[e.jsx(_,{className:"w-4 h-4"}),r("budget.projection.upcomingBills","Upcoming bills"),e.jsx("span",{className:"text-xs bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded",children:o.upcomingCount})]}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:g(o.upcomingBills)})]}),e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-gray-100 dark:border-gray-700",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400 font-medium",children:r("budget.projection.totalProjected","Total projected")}),e.jsx("span",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:g(o.projectedSpending)})]}),e.jsxs("div",{className:m("flex justify-between items-center p-3 rounded-lg",o.isOnTrack?"bg-green-50 dark:bg-green-900/30":"bg-red-50 dark:bg-red-900/30"),children:[e.jsxs("span",{className:"flex items-center gap-2",children:[o.isOnTrack?e.jsx(N,{className:"w-5 h-5 text-green-600 dark:text-green-400"}):e.jsx(k,{className:"w-5 h-5 text-red-600 dark:text-red-400"}),e.jsx("span",{className:m("font-medium",o.isOnTrack?"text-green-700 dark:text-green-300":"text-red-700 dark:text-red-300"),children:r("budget.projection.projectedSavings","Projected savings")})]}),e.jsxs("span",{className:m("text-xl font-bold",o.isOnTrack?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"),children:[o.projectedSavings>=0?"+":"",g(o.projectedSavings)]})]}),a.savings_target&&a.savings_target>0&&e.jsx("p",{className:m("text-sm text-center",o.isOnTrack?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"),children:o.isOnTrack?r("budget.projection.onTrack","On track to meet your savings goal!"):r("budget.projection.offTrack","At risk of missing savings goal by {{amount}}",{amount:g(Math.abs(o.projectedSavings-a.savings_target))})})]})]})]})}function W({budgetId:t,allocations:n,totalBudget:o,tracking:i,month:c,isDraft:g,onAddCategory:h,onAllocationChange:b}){const{t:p}=f("common"),y=a(),j=s(),{data:v}=O(),[N,k]=l.useState("priority"),[w,C]=l.useState("none"),[_,P]=l.useState("desc"),D=l.useMemo(()=>{const e=new Map;return v?(v.expense.forEach(t=>{const a=t.children.map(e=>e.name);e.set(t.name,a)}),v.income.forEach(t=>{const a=t.children.map(e=>e.name);e.set(t.name,a)}),e):e},[v]),A=new Map;(null==i?void 0:i.categories)&&i.categories.forEach(e=>{A.set(e.category,e)});const B=r({mutationFn:({category:e,amount:a})=>u(t,e,a),onSuccess:()=>{j.invalidateQueries({queryKey:["budget"]})}}),F=r({mutationFn:e=>x(t,e),onSuccess:()=>{j.invalidateQueries({queryKey:["budget"]})}}),$=l.useMemo(()=>{let e=[...n];return e.sort((e,t)=>{const a=A.get(e.category),s=A.get(t.category),r=(null==a?void 0:a.spent)||0,n=(null==s?void 0:s.spent)||0,l=(null==a?void 0:a.budgeted)||e.amount,o=(null==s?void 0:s.budgeted)||t.amount,i=l>0?r/l:0,d=o>0?n/o:0,c=r-l,g=n-o;let m=0;switch(N){case"priority":m=g-c,0===m&&(m=d-i);break;case"amount":m=t.amount-e.amount;break;case"category":m=e.category.localeCompare(t.category);break;case"percentage":m=d-i}return"asc"===_?-m:m}),e},[n,N,_,A]),I=l.useMemo(()=>{if("none"===w)return{default:$};const e={need:[],want:[],savings:[]};return $.forEach(t=>{const a=(e=>{const t=e.category.toLowerCase();return["savings","investment","retirement","emergency","fund"].some(e=>t.includes(e))?"savings":["housing","rent","utilities","electric","gas","water","internet","phone","insurance","groceries","transportation","medical","health"].some(e=>t.includes(e))?"need":"want"})(t);e[a].push(t)}),e},[$,w]),T=e=>{N===e?P(e=>"asc"===e?"desc":"asc"):(k(e),P("desc"))};return e.jsxs("div",{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:p("budget.allocations")}),e.jsxs("div",{className:"flex items-center gap-2",children:[h&&e.jsxs(d,{variant:"outline",size:"sm",onClick:h,children:[e.jsx(S,{className:"w-4 h-4 mr-1"}),p("budget.addCategory")]}),e.jsx("div",{className:"flex items-center gap-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-1",children:e.jsxs("select",{value:w,onChange:e=>C(e.target.value),className:"text-sm bg-transparent border-none px-2 py-1",children:[e.jsx("option",{value:"none",children:p("budget.groupNone")}),e.jsx("option",{value:"needs-wants",children:p("budget.groupNeedsWants")})]})}),e.jsxs("div",{className:"flex items-center gap-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-1",children:[e.jsx("button",{onClick:()=>T("priority"),className:m("px-2 py-1 text-xs rounded","priority"===N?"bg-white dark:bg-gray-700 shadow":""),children:p("budget.sortPriority")}),e.jsx("button",{onClick:()=>T("amount"),className:m("px-2 py-1 text-xs rounded","amount"===N?"bg-white dark:bg-gray-700 shadow":""),children:p("budget.sortAmount")})]})]})]}),g&&b&&e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-4",children:p("budget.tapToEdit","Tap amount to edit or use quick buttons")}),Object.entries(I).map(([t,a])=>a.length>0&&e.jsxs("div",{className:"mb-6",children:["needs-wants"===w&&e.jsxs("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-3 flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4"}),p("need"===t?"budget.needs":"want"===t?"budget.wants":"budget.savings"),e.jsxs("span",{className:"text-xs text-gray-400",children:["(",a.length,")"]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:a.map(t=>{const a=n.findIndex(e=>e.category===t.category);return e.jsx(Q,{allocation:t,totalBudget:o,trackingItem:A.get(t.category),isDraft:g,isUpdating:B.isPending,isDeleting:F.isPending,onAmountChange:e=>{if(g&&b){const s=[...n];s[a]={...t,amount:e},b(s)}else B.mutate({category:t.category,amount:e})},onDelete:()=>{if(g&&b){const e=n.filter((e,t)=>t!==a);b(e)}else F.mutate(t.category)},onCategoryClick:()=>(e=>{const t=[e,...D.get(e)||[]].join(",");y({to:"/transactions",search:{categories:t,month:c||void 0}})})(t.category),onQuickAdjust:e=>((e,t)=>{if(!g||!b)return;const a=n[e];let s=a.amount;s="percent"===t?Math.floor(1.1*a.amount):Math.max(0,a.amount+t);const r=[...n];r[e]={...a,amount:s},b(r)})(a,e)},t.category)})})]},t))]})}function Q({allocation:t,totalBudget:a,trackingItem:s,isDraft:r,isUpdating:n,isDeleting:o,onAmountChange:d,onDelete:c,onCategoryClick:u,onQuickAdjust:x}){const{t:h}=f("common"),[b,p]=l.useState(!1),[y,j]=l.useState(""),[v,N]=l.useState(!1),k=l.useRef(null),w=()=>{const e=parseInt(y)||0;e!==t.amount&&d(e),p(!1)},C=a>0?t.amount/a*100:0,_=(null==s?void 0:s.spent)||0,S=(null==s?void 0:s.budgeted)||t.amount,M=S-_,$=S>0?Math.min(_/S*100,100):0,I=_>S,T=_-S;return e.jsxs(i,{className:m("p-4 transition-all",r?"border-dashed border-blue-300 dark:border-blue-700":"cursor-pointer hover:shadow-md hover:border-blue-300 dark:hover:border-blue-600",(n||o)&&"opacity-50 pointer-events-none"),onClick:()=>{r||v||u()},children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold dark:text-gray-100 truncate",children:t.category}),s&&I&&e.jsx(P,{className:"w-4 h-4 text-red-500 flex-shrink-0","aria-label":h("budget.overBudget")})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[b?e.jsx("input",{ref:k,type:"number",value:y,onChange:e=>j(e.target.value),onBlur:w,onKeyDown:e=>{"Enter"===e.key?w():"Escape"===e.key&&p(!1)},onClick:e=>e.stopPropagation(),className:"w-24 text-right text-lg font-bold border rounded px-2 py-1 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"}):e.jsx("span",{className:"text-lg font-bold text-blue-600 dark:text-blue-400 whitespace-nowrap",children:g(t.amount)}),r&&!b&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),x(-5e3)},className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors","aria-label":"Decrease by 5000",children:e.jsx(D,{className:"w-3 h-3 text-gray-500"})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),x(5e3)},className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors","aria-label":"Increase by 5000",children:e.jsx(A,{className:"w-3 h-3 text-gray-500"})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),x("percent")},className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors","aria-label":"Increase by 10%",children:e.jsx("span",{className:"text-xs font-medium text-gray-500",children:"+10%"})})]}),!b&&e.jsx("button",{onClick:e=>{e.stopPropagation(),j(String(t.amount)),p(!0),setTimeout(()=>{var e;return null==(e=k.current)?void 0:e.focus()},0)},className:"p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors","aria-label":h("budget.editAmount","Edit amount"),children:e.jsx(B,{className:"w-4 h-4 text-gray-500 dark:text-gray-400"})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),N(!0)},className:"p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors","aria-label":h("budget.deleteAllocation","Delete"),children:e.jsx(F,{className:"w-4 h-4 text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400"})})]})]}),v&&e.jsxs("div",{className:"mb-3 p-2 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800",children:[e.jsx("p",{className:"text-sm text-red-700 dark:text-red-300 mb-2",children:h("budget.deleteConfirm","Delete this category?")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:e=>{e.stopPropagation(),N(!1)},className:"flex-1 py-1.5 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors",children:h("common.cancel")}),e.jsx("button",{onClick:e=>{e.stopPropagation(),c(),N(!1)},className:"flex-1 py-1.5 text-sm text-white bg-red-600 hover:bg-red-700 rounded transition-colors",children:h("common.delete")})]})]}),t.reasoning&&e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 line-clamp-2",children:t.reasoning}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-blue-500 transition-all duration-500 ease-out",style:{width:`${Math.min(C,100)}%`}})}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:[C.toFixed(1),"% ",h("budget.ofTotal")]})]}),s&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:[g(_)," / ",g(S)]}),e.jsx("span",{className:m("font-medium",I?"text-red-600 dark:text-red-400":"text-green-600 dark:text-green-400"),children:I?e.jsx(e.Fragment,{children:h("budget.overBy",{amount:g(T)})}):e.jsxs(e.Fragment,{children:[g(M)," ",h("budget.remaining")]})})]}),e.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:e.jsx("div",{className:m("h-full transition-all",I?"bg-red-500":$>=80?"bg-orange-500":$>=60?"bg-yellow-500":"bg-green-500"),style:{width:`${Math.min($,100)}%`}})}),I&&e.jsx("div",{className:"h-1 bg-red-200 dark:bg-red-900/50 rounded-full mt-1 overflow-hidden",children:e.jsx("div",{className:"h-full bg-red-500",style:{width:`${Math.min((_-S)/S*100,100)}%`}})})]})]})}function G({totalBudget:t,totalAllocated:a,tracking:s}){const{t:r}=f("common"),n=l.useMemo(()=>{const e=t>0?a/t*100:0,n=t-a,l=s.total_budgeted>0?s.total_spent/s.total_budgeted*100:0,o=s.categories.filter(e=>"red"===e.status||"orange"===e.status).length,i=s.categories.filter(e=>"yellow"===e.status).length,d=s.categories.filter(e=>"green"===e.status).length;let c,g;return o>0?(c="poor",g=r("budget.health.overBudget",{count:o})):l>100?(c="poor",g=r("budget.health.exceededTotal")):l>90?(c="fair",g=r("budget.health.warningNearLimit")):e>100?(c="fair",g=r("budget.health.overAllocated")):e>95?(c="good",g=r("budget.health.almostFull")):(c="excellent",g=r("budget.health.onTrack")),{allocatedPercent:e,remaining:n,spendingPercent:l,overBudgetCategories:o,warningCategories:i,healthyCategories:d,status:c,message:g,ringProgress:Math.min(100,Math.max(0,100-e))}},[t,a,s,r]);return e.jsx(i,{className:m("p-4",(()=>{switch(n.status){case"excellent":return"bg-green-50 dark:bg-green-900/30";case"good":return"bg-blue-50 dark:bg-blue-900/30";case"fair":return"bg-yellow-50 dark:bg-yellow-900/30";case"poor":return"bg-red-50 dark:bg-red-900/30"}})()),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative w-16 h-16",children:[e.jsxs("svg",{className:"w-16 h-16 transform -rotate-90",children:[e.jsx("circle",{cx:"32",cy:"32",r:"28",stroke:"currentColor",strokeWidth:"6",fill:"none",className:"text-gray-200 dark:text-gray-700"}),e.jsx("circle",{cx:"32",cy:"32",r:"28",stroke:"currentColor",strokeWidth:"6",fill:"none",strokeDasharray:1.76*Math.min(n.allocatedPercent,100)+" 176",className:m("transition-all duration-500",(()=>{switch(n.status){case"excellent":return"text-green-500";case"good":return"text-blue-500";case"fair":return"text-yellow-500";case"poor":return"text-red-500"}})())})]}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("span",{className:"text-xs font-bold",children:[Math.round(n.allocatedPercent),"%"]})})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:r("budget.health.title")}),e.jsx("p",{className:m("text-sm","poor"===n.status?"text-red-600 dark:text-red-400":"fair"===n.status?"text-yellow-600 dark:text-yellow-400":"text-green-600 dark:text-green-400"),children:n.message})]})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:n.overBudgetCategories})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-yellow-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:n.warningCategories})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-green-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:n.healthyCategories})]})]})]})})}function Y({budget:t,onClose:a,onAdd:s}){const{t:r}=f("common"),{data:n}=O(),[o,m]=l.useState(""),[u,x]=l.useState(""),[h,b]=l.useState(""),p=l.useMemo(()=>{if(!n)return[];const e=new Set(t.allocations.map(e=>e.category)),a=[];return n.expense.forEach(t=>{e.has(t.name)||a.push(t.name),t.children.forEach(t=>{e.has(t.name)||a.push(t.name)})}),a.sort()},[n,t.allocations]),y=l.useMemo(()=>{const e=t.allocations.reduce((e,t)=>e+t.amount,0);return t.monthly_income-(t.savings_target||0)-e},[t]),j="__custom__"===o,v=j?u:o,N=v.trim().length>0&&parseInt(h)>0,k=Math.floor(y/(p.length+1));return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs(i,{className:"w-full max-w-md animate-in fade-in zoom-in duration-200",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-semibold",children:r("budget.addCategory")}),e.jsx("button",{onClick:a,className:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors",children:e.jsx($,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:e=>{e.preventDefault(),N&&s(v,parseInt(h))},className:"p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:r("budget.category")}),e.jsxs("select",{value:o,onChange:e=>{m(e.target.value),"__custom__"!==e.target.value&&x("")},className:"w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700",children:[e.jsx("option",{value:"",children:r("budget.selectCategory")}),p.map(t=>e.jsx("option",{value:t,children:t},t)),e.jsx("option",{value:"__custom__",children:r("budget.customCategory")})]})]}),j&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:r("budget.categoryName")}),e.jsx(c,{value:u,onChange:e=>x(e.target.value),placeholder:r("budget.categoryPlaceholder")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:r("budget.amount")}),e.jsx(c,{type:"number",value:h,onChange:e=>b(e.target.value),placeholder:g(0),min:1}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[r("budget.remainingBudget"),": ",g(y)]})]}),k>0&&e.jsx("button",{type:"button",onClick:()=>b(String(k)),className:"text-sm text-blue-600 dark:text-blue-400 hover:underline",children:r("budget.suggestAmount",{amount:g(k)})}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(d,{type:"button",variant:"outline",onClick:a,className:"flex-1",children:r("common.cancel")}),e.jsxs(d,{type:"submit",disabled:!N,className:"flex-1",children:[e.jsx(S,{className:"w-4 h-4 mr-1"}),r("budget.add")]})]})]})]})})}const H=n("/budget")({component:function(){const{t:a,i18n:n}=f("common"),o=s(),[c,g]=l.useState(!1),[m,u]=l.useState(null),[x,N]=l.useState(()=>{const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}),[k,w]=l.useState([]),[C,_]=l.useState(!1),S=l.useCallback(e=>{N(t=>{const[a,s]=t.split("-").map(Number);let r=a,n=s;return"prev"===e?(n-=1,n<1&&(n=12,r-=1)):(n+=1,n>12&&(n=1,r+=1)),`${r}-${String(n).padStart(2,"0")}`})},[]),{data:M,isLoading:P,error:D}=t({queryKey:["budget","month",x],queryFn:async()=>{var e;try{return await y(x)}catch(t){if(404===(null==(e=null==t?void 0:t.response)?void 0:e.status))return null;throw t}},retry:!1}),{data:A}=t({queryKey:["budget","previous-month",x],queryFn:async()=>{const[e,t]=x.split("-").map(Number);let a=e,s=t-1;s<1&&(s=12,a-=1);const r=`${a}-${String(s).padStart(2,"0")}`;try{return await y(r)}catch{return null}},enabled:!!M,staleTime:3e5}),{data:B}=t({queryKey:["budget","tracking",x],queryFn:async()=>{var e;try{return await j()}catch(t){if(404===(null==(e=null==t?void 0:t.response)?void 0:e.status))return null;throw t}},retry:!1,enabled:!!M}),{data:F}=t({queryKey:["budget","suggestions"],queryFn:v,enabled:!M&&!P}),$=r({mutationFn:e=>h({monthly_income:e,language:n.language}),onSuccess:e=>{u(e),O("generate",e)}}),L=r({mutationFn:e=>b((m||M).id,{feedback:e,language:n.language}),onSuccess:e=>{u(e),g(!1),O("regenerate",e)}}),O=l.useCallback((e,t)=>{w(a=>[...a.slice(-9),{action:e,data:t}])},[]),U=l.useCallback(()=>{if(0===k.length)return;const e=k[k.length-1];u(e.data),w(e=>e.slice(0,-1))},[k]),Q=m||M,H=!!m,J=(null==Q?void 0:Q.allocations.reduce((e,t)=>e+t.amount,0))||0,X=((null==Q?void 0:Q.monthly_income)||0)-((null==Q?void 0:Q.savings_target)||0),Z=l.useCallback(()=>{if(!Q)return;const e=`${a("budget.title")} - ${Q.month}\n${a("budget.monthlyIncome")}: ${Q.monthly_income}\n${a("budget.savingsTarget")}: ${Q.savings_target||0}\n\n${a("budget.allocations")}:\n${Q.allocations.map(e=>`- ${e.category}: ${e.amount}`).join("\n")}\n\n${a("budget.aiAdvice")}: ${Q.advice||"-"}\n`,t=new Blob([e],{type:"text/plain"}),s=URL.createObjectURL(t),r=document.createElement("a");r.href=s,r.download=`budget-${Q.month}.txt`,r.click(),URL.revokeObjectURL(s)},[Q,a]);return P?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(p,{})}):e.jsxs("div",{className:"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-28",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:a("budget.title")}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:a("budget.subtitle")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[k.length>0&&e.jsxs(d,{variant:"outline",size:"sm",onClick:U,children:[e.jsx(I,{className:"w-4 h-4 mr-1"}),a("common.undo")]}),Q&&e.jsxs(d,{variant:"outline",size:"sm",onClick:Z,children:[e.jsx(T,{className:"w-4 h-4 mr-1"}),a("common.export")]})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-gray-100 dark:bg-gray-800 rounded-lg p-1 w-fit",children:[e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>S("prev"),className:"px-3",children:e.jsx(E,{className:"w-4 h-4"})}),e.jsx("span",{className:"px-4 font-semibold min-w-[180px] text-center",children:(e=>{const[t,a]=e.split("-");return new Date(parseInt(t),parseInt(a)-1).toLocaleDateString(n.language,{month:"long",year:"numeric"})})(x)}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>S("next"),className:"px-3",disabled:x>=(new Date).toISOString().slice(0,7),children:e.jsx(q,{className:"w-4 h-4"})})]})]}),!Q&&!D&&e.jsx(K,{onGenerate:e=>$.mutate(e),isLoading:$.isPending,error:$.isError,suggestions:F}),Q&&e.jsxs("div",{className:"space-y-6",children:[B&&e.jsx(G,{totalBudget:X,totalAllocated:J,tracking:B}),e.jsx(R,{budget:Q,totalAllocated:J,isDraft:H,previousMonth:A||void 0,onRegenerateClick:()=>g(!c),onSaveClick:async()=>{await o.refetchQueries({queryKey:["budget"]}),u(null)},isSaving:!1}),c&&e.jsx(z,{onSubmit:e=>L.mutate(e),onCancel:()=>g(!1),isLoading:L.isPending}),!H&&B&&e.jsx(V,{budget:Q,tracking:B}),e.jsx(W,{budgetId:Q.id,allocations:Q.allocations,totalBudget:X,tracking:B||void 0,month:Q.month,isDraft:H,onAddCategory:()=>_(!0),onAllocationChange:e=>{if(Q){const t=e.reduce((e,t)=>e+t.amount,0),a=Math.max(0,Q.monthly_income-t);u({...Q,allocations:e,savings_target:a}),O("edit",Q)}}})]}),D&&e.jsx(i,{className:"p-6 border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20",children:e.jsx("p",{className:"text-red-600 dark:text-red-400",children:D instanceof Error?D.message:a("budget.generateError")})}),C&&Q&&e.jsx(Y,{budget:Q,onClose:()=>_(!1),onAdd:(e,t)=>{const a=[...Q.allocations,{category:e,amount:t}],s=a.reduce((e,t)=>e+t.amount,0),r=Math.max(0,Q.monthly_income-s);u({...Q,allocations:a,savings_target:r}),_(!1),O("add-category",Q)}})]})}});export{H as Route};

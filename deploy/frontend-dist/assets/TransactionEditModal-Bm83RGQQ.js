import{u as H,r as n,j as e,aN as me,X as O,G as xe,$ as pe,a1 as $,aW as he,a2 as fe,B as v,I as A,aX as ge,l as ye,w as be}from"./index-Df5i9fLp.js";import{i as X,H as je,B as ve,j as we}from"./BudgetInsightWidget-L6nYz4Lf.js";import{S as P}from"./Select-Cbmm4aAQ.js";import{Z as Ne,a as ke}from"./zoom-out-2epYhCTc.js";import{D as Ce}from"./download-3guVaSkv.js";function Se({receiptUrl:u,onClose:d}){const{t:a}=H(),[s,i]=n.useState(1),c=X(u);if(!c)return null;const f=()=>i(r=>Math.min(r+.25,3)),g=()=>i(r=>Math.max(r-.25,.5)),y=()=>{const r=document.createElement("a");r.href=c,r.download=`receipt-${Date.now()}.jpg`,r.click()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/90 flex flex-col",onClick:r=>{r.target===r.currentTarget&&d()},children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-black/50",children:[e.jsxs("h2",{className:"text-white font-medium flex items-center gap-2",children:[e.jsx(me,{size:20}),a("receipt.viewReceipt","View Receipt")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:g,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white","aria-label":a("zoomOut","Zoom out"),children:e.jsx(Ne,{size:20})}),e.jsxs("span",{className:"text-white text-sm w-12 text-center",children:[Math.round(s*100),"%"]}),e.jsx("button",{onClick:f,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white","aria-label":a("zoomIn","Zoom in"),children:e.jsx(ke,{size:20})}),e.jsx("button",{onClick:y,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white ml-2","aria-label":a("download","Download"),children:e.jsx(Ce,{size:20})}),e.jsx("button",{onClick:d,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white ml-2","aria-label":a("close","Close"),children:e.jsx(O,{size:20})})]})]}),e.jsx("div",{className:"flex-1 overflow-auto flex items-center justify-center p-4",children:e.jsx("img",{src:c,alt:"Receipt",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${s})`}})})]})}function Ue({isOpen:u,onClose:d,transaction:a}){const{t:s}=H("common"),i=xe(),{data:c=[]}=pe(),[f,g]=n.useState(""),[y,r]=n.useState(""),[U,z]=n.useState(""),[G,E]=n.useState(""),[w,N]=n.useState("JPY"),[b,I]=n.useState(""),[o,q]=n.useState(null),[x,T]=n.useState("expense"),[ee,Z]=n.useState(""),[k,Q]=n.useState(!1),[te,C]=n.useState(!1),[p,V]=n.useState(null),[K,S]=n.useState(null),[h,R]=n.useState(null),[ae,_]=n.useState(!1),[B,F]=n.useState(!1),[L,W]=n.useState(!1),j=n.useRef(null),se=[{value:"JPY",label:"¥ JPY"},{value:"USD",label:"$ USD"},{value:"VND",label:"₫ VND"}],J=t=>{const l=t.replace(/[^\d]/g,"");return l?Number(l).toLocaleString():""},ne=t=>{const l=t.target.value.replace(/[^\d]/g,"");z(l),E(J(l))},D=$({mutationFn:t=>he(a.id,t),onSuccess:()=>{i.invalidateQueries({queryKey:["transactions"]}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["analytics"]}),d()}}),M=$({mutationFn:()=>fe(a.id),onSuccess:()=>{i.invalidateQueries({queryKey:["transactions"]}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["analytics"]}),d()}});n.useEffect(()=>{if(a&&u){g(a.date),r(a.description);const t=Math.abs(a.amount).toString();z(t),E(J(t)),N(a.currency||"JPY"),I(a.category),Z(""),q(a.account_id??null),T(a.type),Q(a.is_adjustment||!1),C(!1),V(a.receipt_url||null),S(null),R(null),W(!1)}},[a==null?void 0:a.id,u]);const le=t=>{var m;const l=(m=t.target.files)==null?void 0:m[0];!l||!l.type.startsWith("image/")||(S(l),R(URL.createObjectURL(l)))},re=()=>{S(null),h&&(URL.revokeObjectURL(h),R(null)),V(null),j.current&&(j.current.value="")};n.useEffect(()=>{if(o&&!L){const t=c.find(l=>l.id===o);t!=null&&t.currency&&N(t.currency)}},[o,c,L]);const ie=async t=>{t.preventDefault();const l=parseFloat(U);if(isNaN(l))return;const m=c.find(de=>de.id===o),ue=(m==null?void 0:m.name)||(a==null?void 0:a.source)||"";let Y=p;if(K){F(!0);try{Y=await we(K)}finally{F(!1)}}D.mutate({date:f,description:y,amount:Math.round(x==="expense"?-Math.abs(l):Math.abs(l)),currency:w,category:b||"Other",source:ue,type:x,account_id:o,receipt_url:Y,is_adjustment:k})},ce=()=>{M.mutate()};if(n.useEffect(()=>(u&&(document.body.style.overflow="hidden"),()=>{document.body.style.overflow=""}),[u]),!u||!a)return null;const oe=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:d}),e.jsx("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md max-h-[90dvh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:s("transaction.editTitle")}),te?e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:s("transaction.deleteConfirm")}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.description}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(v,{variant:"outline",onClick:()=>C(!1),className:"flex-1",children:s("button.cancel")}),e.jsx(v,{variant:"secondary",onClick:ce,disabled:M.isPending,className:"flex-1 bg-red-600 hover:bg-red-700 text-white",children:M.isPending?"...":s("button.delete")})]})]}):e.jsxs("form",{onSubmit:ie,className:"space-y-4",children:[e.jsx(A,{label:s("transaction.date"),type:"date",value:f,onChange:t=>g(t.target.value),required:!0}),e.jsx(A,{label:s("transaction.description"),value:y,onChange:t=>r(t.target.value),required:!0}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(A,{label:s("transaction.amount"),type:"text",inputMode:"numeric",value:G,onChange:ne,required:!0})}),e.jsx("div",{className:"w-28",children:e.jsx(P,{label:s("transaction.currency","Currency"),value:w,onChange:t=>{N(t.target.value),W(!0)},options:se})})]}),e.jsx(P,{label:s("transaction.type"),value:x,onChange:t=>T(t.target.value),options:[{value:"income",label:s("transaction.typeIncome")},{value:"expense",label:s("transaction.typeExpense")}]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:s("transaction.category")}),e.jsx(je,{selected:b,onSelect:(t,l)=>{I(t),Z(l)},isIncome:x==="income"})]}),b&&!k&&e.jsx(ve,{parentCategory:ee||b,transactionAmount:parseInt(U)||0,isExpense:x==="expense",transactionCurrency:w}),e.jsx(P,{label:s("account.account"),value:(o==null?void 0:o.toString())||"",onChange:t=>q(t.target.value?Number(t.target.value):null),options:[{value:"",label:s("account.selectAccount")},...c.map(t=>({value:t.id.toString(),label:t.name}))]}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer py-2",children:[e.jsx("input",{type:"checkbox",checked:k,onChange:t=>Q(t.target.checked),className:"w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:s("transaction.balanceAdjustment","Balance adjustment")}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("transaction.balanceAdjustmentHint","Won't count toward budget")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:s("receipt.receipt","Receipt")}),e.jsx("input",{ref:j,type:"file",accept:"image/*",capture:"environment",onChange:le,className:"hidden"}),h||p?e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700",children:[e.jsx("img",{src:h||X(p)||"",alt:"Receipt",className:"w-full h-20 object-cover cursor-pointer",onClick:()=>!h&&_(!0)}),e.jsx("button",{type:"button",onClick:re,className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(O,{size:14})})]}):e.jsxs("button",{type:"button",onClick:()=>{var t;return(t=j.current)==null?void 0:t.click()},className:"w-full h-10 flex items-center justify-center gap-2 border border-dashed border-gray-300 dark:border-gray-600 hover:border-blue-400 text-gray-500 dark:text-gray-400 rounded-lg text-sm",children:[e.jsx(ge,{size:16}),s("receipt.attachReceipt","Attach Receipt")]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(v,{type:"button",variant:"outline",onClick:d,className:"flex-1",children:s("button.cancel")}),e.jsx(v,{type:"submit",disabled:D.isPending||B,className:"flex-1",children:B?s("receipt.uploading","Uploading..."):D.isPending?"...":s("button.save")})]}),e.jsx("button",{type:"button",onClick:()=>C(!0),className:ye("w-full text-center text-sm text-red-600 hover:text-red-700","py-2 transition-colors"),children:s("transaction.deleteTransaction")})]})]})}),ae&&p&&e.jsx(Se,{receiptUrl:p,onClose:()=>_(!1)})]});return typeof document<"u"?be.createPortal(oe,document.body):null}export{Ue as T};

import{u as B,r as n,j as e,aP as ue,X as H,G as de,$ as me,a1 as $,aU as xe,a2 as pe,B as j,I as R,aV as he,l as fe,v as be}from"./index-4Dd6_etk.js";import{g as O,H as ge,u as ye}from"./HierarchicalCategoryPicker-4pScR14n.js";import{S as D}from"./Select-ED7OSqD0.js";import{Z as je,a as ve}from"./zoom-out-jyUf02we.js";import{D as we}from"./download-Cs_EJ6jw.js";function Ne({receiptUrl:u,onClose:d}){const{t:a}=B(),[s,i]=n.useState(1),c=O(u);if(!c)return null;const h=()=>i(r=>Math.min(r+.25,3)),f=()=>i(r=>Math.max(r-.25,.5)),b=()=>{const r=document.createElement("a");r.href=c,r.download=`receipt-${Date.now()}.jpg`,r.click()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/90 flex flex-col",onClick:r=>{r.target===r.currentTarget&&d()},children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-black/50",children:[e.jsxs("h2",{className:"text-white font-medium flex items-center gap-2",children:[e.jsx(ue,{size:20}),a("receipt.viewReceipt","View Receipt")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:f,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white","aria-label":a("zoomOut","Zoom out"),children:e.jsx(je,{size:20})}),e.jsxs("span",{className:"text-white text-sm w-12 text-center",children:[Math.round(s*100),"%"]}),e.jsx("button",{onClick:h,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white","aria-label":a("zoomIn","Zoom in"),children:e.jsx(ve,{size:20})}),e.jsx("button",{onClick:b,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white ml-2","aria-label":a("download","Download"),children:e.jsx(we,{size:20})}),e.jsx("button",{onClick:d,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white ml-2","aria-label":a("close","Close"),children:e.jsx(H,{size:20})})]})]}),e.jsx("div",{className:"flex-1 overflow-auto flex items-center justify-center p-4",children:e.jsx("img",{src:c,alt:"Receipt",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${s})`}})})]})}function Me({isOpen:u,onClose:d,transaction:a}){const{t:s}=B("common"),i=de(),{data:c=[]}=me(),[h,f]=n.useState(""),[b,r]=n.useState(""),[W,M]=n.useState(""),[G,U]=n.useState(""),[P,v]=n.useState("JPY"),[z,A]=n.useState(""),[o,E]=n.useState(null),[g,q]=n.useState("expense"),[I,T]=n.useState(!1),[X,w]=n.useState(!1),[x,V]=n.useState(null),[Z,N]=n.useState(null),[p,k]=n.useState(null),[ee,Q]=n.useState(!1),[K,_]=n.useState(!1),[F,L]=n.useState(!1),y=n.useRef(null),te=[{value:"JPY",label:"¥ JPY"},{value:"USD",label:"$ USD"},{value:"VND",label:"₫ VND"}],J=t=>{const l=t.replace(/[^\d]/g,"");return l?Number(l).toLocaleString():""},ae=t=>{const l=t.target.value.replace(/[^\d]/g,"");M(l),U(J(l))},S=$({mutationFn:t=>xe(a.id,t),onSuccess:()=>{i.invalidateQueries({queryKey:["transactions"]}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["analytics"]}),d()}}),C=$({mutationFn:()=>pe(a.id),onSuccess:()=>{i.invalidateQueries({queryKey:["transactions"]}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["analytics"]}),d()}});n.useEffect(()=>{if(a&&u){f(a.date),r(a.description);const t=Math.abs(a.amount).toString();M(t),U(J(t)),v(a.currency||"JPY"),A(a.category),E(a.account_id??null),q(a.type),T(a.is_adjustment||!1),w(!1),V(a.receipt_url||null),N(null),k(null),L(!1)}},[a==null?void 0:a.id,u]);const se=t=>{var m;const l=(m=t.target.files)==null?void 0:m[0];!l||!l.type.startsWith("image/")||(N(l),k(URL.createObjectURL(l)))},ne=()=>{N(null),p&&(URL.revokeObjectURL(p),k(null)),V(null),y.current&&(y.current.value="")};n.useEffect(()=>{if(o&&!F){const t=c.find(l=>l.id===o);t!=null&&t.currency&&v(t.currency)}},[o,c,F]);const le=async t=>{t.preventDefault();const l=parseFloat(W);if(isNaN(l))return;const m=c.find(oe=>oe.id===o),ce=(m==null?void 0:m.name)||(a==null?void 0:a.source)||"";let Y=x;if(Z){_(!0);try{Y=await ye(Z)}finally{_(!1)}}S.mutate({date:h,description:b,amount:Math.round(g==="expense"?-Math.abs(l):Math.abs(l)),currency:P,category:z||"Other",source:ce,type:g,account_id:o,receipt_url:Y,is_adjustment:I})},re=()=>{C.mutate()};if(n.useEffect(()=>(u&&(document.body.style.overflow="hidden"),()=>{document.body.style.overflow=""}),[u]),!u||!a)return null;const ie=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:d}),e.jsx("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md max-h-[90dvh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:s("transaction.editTitle")}),X?e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:s("transaction.deleteConfirm")}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.description}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(j,{variant:"outline",onClick:()=>w(!1),className:"flex-1",children:s("button.cancel")}),e.jsx(j,{variant:"secondary",onClick:re,disabled:C.isPending,className:"flex-1 bg-red-600 hover:bg-red-700 text-white",children:C.isPending?"...":s("button.delete")})]})]}):e.jsxs("form",{onSubmit:le,className:"space-y-4",children:[e.jsx(R,{label:s("transaction.date"),type:"date",value:h,onChange:t=>f(t.target.value),required:!0}),e.jsx(R,{label:s("transaction.description"),value:b,onChange:t=>r(t.target.value),required:!0}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(R,{label:s("transaction.amount"),type:"text",inputMode:"numeric",value:G,onChange:ae,required:!0})}),e.jsx("div",{className:"w-28",children:e.jsx(D,{label:s("transaction.currency","Currency"),value:P,onChange:t=>{v(t.target.value),L(!0)},options:te})})]}),e.jsx(D,{label:s("transaction.type"),value:g,onChange:t=>q(t.target.value),options:[{value:"income",label:s("transaction.typeIncome")},{value:"expense",label:s("transaction.typeExpense")}]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:s("transaction.category")}),e.jsx(ge,{selected:z,onSelect:t=>A(t),isIncome:g==="income"})]}),e.jsx(D,{label:s("account.account"),value:(o==null?void 0:o.toString())||"",onChange:t=>E(t.target.value?Number(t.target.value):null),options:[{value:"",label:s("account.selectAccount")},...c.map(t=>({value:t.id.toString(),label:t.name}))]}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer py-2",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:t=>T(t.target.checked),className:"w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:s("transaction.balanceAdjustment","Balance adjustment")}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("transaction.balanceAdjustmentHint","Won't count toward budget")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:s("receipt.receipt","Receipt")}),e.jsx("input",{ref:y,type:"file",accept:"image/*",capture:"environment",onChange:se,className:"hidden"}),p||x?e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700",children:[e.jsx("img",{src:p||O(x)||"",alt:"Receipt",className:"w-full h-20 object-cover cursor-pointer",onClick:()=>!p&&Q(!0)}),e.jsx("button",{type:"button",onClick:ne,className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(H,{size:14})})]}):e.jsxs("button",{type:"button",onClick:()=>{var t;return(t=y.current)==null?void 0:t.click()},className:"w-full h-10 flex items-center justify-center gap-2 border border-dashed border-gray-300 dark:border-gray-600 hover:border-blue-400 text-gray-500 dark:text-gray-400 rounded-lg text-sm",children:[e.jsx(he,{size:16}),s("receipt.attachReceipt","Attach Receipt")]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(j,{type:"button",variant:"outline",onClick:d,className:"flex-1",children:s("button.cancel")}),e.jsx(j,{type:"submit",disabled:S.isPending||K,className:"flex-1",children:K?s("receipt.uploading","Uploading..."):S.isPending?"...":s("button.save")})]}),e.jsx("button",{type:"button",onClick:()=>w(!0),className:fe("w-full text-center text-sm text-red-600 hover:text-red-700","py-2 transition-colors"),children:s("transaction.deleteTransaction")})]})]})}),ee&&x&&e.jsx(Ne,{receiptUrl:x,onClose:()=>Q(!1)})]});return typeof document<"u"?be.createPortal(ie,document.body):null}export{Me as T};

import{k as $,u as B,r as n,j as e,aM as de,X as O,J as me,a0 as xe,a2 as Y,aS as he,a3 as pe,B as v,I as R,aT as fe,l as ye,v as be}from"./index-BadmHgZg.js";import{g as W,H as ge,u as ve}from"./HierarchicalCategoryPicker-DsVud-2u.js";import{S as M}from"./Select-CPZb2nKz.js";import{Z as je,a as we}from"./zoom-out-u9fW-Zgd.js";/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],ke=$("download",Ne);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],Ae=$("file-text",Se);function Ce({receiptUrl:u,onClose:d}){const{t:a}=B(),[s,i]=n.useState(1),c=W(u);if(!c)return null;const p=()=>i(r=>Math.min(r+.25,3)),f=()=>i(r=>Math.max(r-.25,.5)),y=()=>{const r=document.createElement("a");r.href=c,r.download=`receipt-${Date.now()}.jpg`,r.click()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/90 flex flex-col",onClick:r=>{r.target===r.currentTarget&&d()},children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-black/50",children:[e.jsxs("h2",{className:"text-white font-medium flex items-center gap-2",children:[e.jsx(de,{size:20}),a("receipt.viewReceipt","View Receipt")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:f,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white","aria-label":a("zoomOut","Zoom out"),children:e.jsx(je,{size:20})}),e.jsxs("span",{className:"text-white text-sm w-12 text-center",children:[Math.round(s*100),"%"]}),e.jsx("button",{onClick:p,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white","aria-label":a("zoomIn","Zoom in"),children:e.jsx(we,{size:20})}),e.jsx("button",{onClick:y,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white ml-2","aria-label":a("download","Download"),children:e.jsx(ke,{size:20})}),e.jsx("button",{onClick:d,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white ml-2","aria-label":a("close","Close"),children:e.jsx(O,{size:20})})]})]}),e.jsx("div",{className:"flex-1 overflow-auto flex items-center justify-center p-4",children:e.jsx("img",{src:c,alt:"Receipt",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${s})`}})})]})}function Ue({isOpen:u,onClose:d,transaction:a}){const{t:s}=B("common"),i=me(),{data:c=[]}=xe(),[p,f]=n.useState(""),[y,r]=n.useState(""),[X,D]=n.useState(""),[G,z]=n.useState(""),[A,j]=n.useState("JPY"),[U,P]=n.useState(""),[o,E]=n.useState(null),[b,I]=n.useState("expense"),[T,q]=n.useState(!1),[ee,w]=n.useState(!1),[x,_]=n.useState(null),[V,N]=n.useState(null),[h,k]=n.useState(null),[te,Z]=n.useState(!1),[F,H]=n.useState(!1),[Q,K]=n.useState(!1),g=n.useRef(null),ae=[{value:"JPY",label:"¥ JPY"},{value:"USD",label:"$ USD"},{value:"VND",label:"₫ VND"}],L=t=>{const l=t.replace(/[^\d]/g,"");return l?Number(l).toLocaleString():""},se=t=>{const l=t.target.value.replace(/[^\d]/g,"");D(l),z(L(l))},S=Y({mutationFn:t=>he(a.id,t),onSuccess:()=>{i.invalidateQueries({queryKey:["transactions"]}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["analytics"]}),d()}}),C=Y({mutationFn:()=>pe(a.id),onSuccess:()=>{i.invalidateQueries({queryKey:["transactions"]}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["analytics"]}),d()}});n.useEffect(()=>{if(a&&u){f(a.date),r(a.description);const t=Math.abs(a.amount).toString();D(t),z(L(t)),j(a.currency||"JPY"),P(a.category),E(a.account_id??null),I(a.type),q(a.is_adjustment||!1),w(!1),_(a.receipt_url||null),N(null),k(null),K(!1)}},[a==null?void 0:a.id,u]);const ne=t=>{var m;const l=(m=t.target.files)==null?void 0:m[0];!l||!l.type.startsWith("image/")||(N(l),k(URL.createObjectURL(l)))},le=()=>{N(null),h&&(URL.revokeObjectURL(h),k(null)),_(null),g.current&&(g.current.value="")};n.useEffect(()=>{if(o&&!Q){const t=c.find(l=>l.id===o);t!=null&&t.currency&&j(t.currency)}},[o,c,Q]);const re=async t=>{t.preventDefault();const l=parseFloat(X);if(isNaN(l))return;const m=c.find(ue=>ue.id===o),oe=(m==null?void 0:m.name)||(a==null?void 0:a.source)||"";let J=x;if(V){H(!0);try{J=await ve(V)}finally{H(!1)}}S.mutate({date:p,description:y,amount:Math.round(b==="expense"?-Math.abs(l):Math.abs(l)),currency:A,category:U||"Other",source:oe,type:b,account_id:o,receipt_url:J,is_adjustment:T})},ie=()=>{C.mutate()};if(n.useEffect(()=>(u&&(document.body.style.overflow="hidden"),()=>{document.body.style.overflow=""}),[u]),!u||!a)return null;const ce=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:d}),e.jsx("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md max-h-[90dvh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:s("transaction.editTitle")}),ee?e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:s("transaction.deleteConfirm")}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.description}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(v,{variant:"outline",onClick:()=>w(!1),className:"flex-1",children:s("button.cancel")}),e.jsx(v,{variant:"secondary",onClick:ie,disabled:C.isPending,className:"flex-1 bg-red-600 hover:bg-red-700 text-white",children:C.isPending?"...":s("button.delete")})]})]}):e.jsxs("form",{onSubmit:re,className:"space-y-4",children:[e.jsx(R,{label:s("transaction.date"),type:"date",value:p,onChange:t=>f(t.target.value),required:!0}),e.jsx(R,{label:s("transaction.description"),value:y,onChange:t=>r(t.target.value),required:!0}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(R,{label:s("transaction.amount"),type:"text",inputMode:"numeric",value:G,onChange:se,required:!0})}),e.jsx("div",{className:"w-28",children:e.jsx(M,{label:s("transaction.currency","Currency"),value:A,onChange:t=>{j(t.target.value),K(!0)},options:ae})})]}),e.jsx(M,{label:s("transaction.type"),value:b,onChange:t=>I(t.target.value),options:[{value:"income",label:s("transaction.typeIncome")},{value:"expense",label:s("transaction.typeExpense")}]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:s("transaction.category")}),e.jsx(ge,{selected:U,onSelect:t=>P(t),isIncome:b==="income"})]}),e.jsx(M,{label:s("account.account"),value:(o==null?void 0:o.toString())||"",onChange:t=>E(t.target.value?Number(t.target.value):null),options:[{value:"",label:s("account.selectAccount")},...c.map(t=>({value:t.id.toString(),label:t.name}))]}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer py-2",children:[e.jsx("input",{type:"checkbox",checked:T,onChange:t=>q(t.target.checked),className:"w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:s("transaction.balanceAdjustment","Balance adjustment")}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("transaction.balanceAdjustmentHint","Won't count toward budget")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:s("receipt.receipt","Receipt")}),e.jsx("input",{ref:g,type:"file",accept:"image/*",capture:"environment",onChange:ne,className:"hidden"}),h||x?e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700",children:[e.jsx("img",{src:h||W(x)||"",alt:"Receipt",className:"w-full h-20 object-cover cursor-pointer",onClick:()=>!h&&Z(!0)}),e.jsx("button",{type:"button",onClick:le,className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(O,{size:14})})]}):e.jsxs("button",{type:"button",onClick:()=>{var t;return(t=g.current)==null?void 0:t.click()},className:"w-full h-10 flex items-center justify-center gap-2 border border-dashed border-gray-300 dark:border-gray-600 hover:border-blue-400 text-gray-500 dark:text-gray-400 rounded-lg text-sm",children:[e.jsx(fe,{size:16}),s("receipt.attachReceipt","Attach Receipt")]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(v,{type:"button",variant:"outline",onClick:d,className:"flex-1",children:s("button.cancel")}),e.jsx(v,{type:"submit",disabled:S.isPending||F,className:"flex-1",children:F?s("receipt.uploading","Uploading..."):S.isPending?"...":s("button.save")})]}),e.jsx("button",{type:"button",onClick:()=>w(!0),className:ye("w-full text-center text-sm text-red-600 hover:text-red-700","py-2 transition-colors"),children:s("transaction.deleteTransaction")})]})]})}),te&&x&&e.jsx(Ce,{receiptUrl:x,onClose:()=>Z(!1)})]});return typeof document<"u"?be.createPortal(ce,document.body):null}export{ke as D,Ae as F,Ue as T};

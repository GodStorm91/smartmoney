import{a as Ze,j as e,e as et}from"./vendor-router-DONIM_LE.js";import{r as c,a as he}from"./vendor-react-Cwh1aMWO.js";import{i as J,z as we,y as ce,C as X,j as I,Y as W,b8 as tt,b9 as at,ba as rt,G as pe,K as Ee,s as le,ah as me,m as Ie,R as Y,T as st,I as Fe,B as ie,P as oe,aa as nt,o as Z,f as de,an as be,n as _e,aF as ve,L as ue,X as G,w as fe,at as lt,x as it,aH as ot,aE as xe,am as dt,N as Be,al as ct,a3 as ae,a5 as xt,aL as Me,aM as mt,bb as ut,a1 as gt}from"./index-MF_XS6R5.js";import{f as Ne,p as ke,u as yt,T as ht,R as pt}from"./useDebouncedValue-CHcRHUEF.js";import{u as H}from"./vendor-i18n-CNDlYvyf.js";import{b as ee,u as O,c as Q,e as Ae}from"./vendor-query-B0NEAgzV.js";import{c as bt,d as ft,s as jt,C as ge,e as ye,f as Ke,h as Nt,i as kt,j as ze,k as Oe,l as Qe,m as Ve,n as vt,o as wt,p as _t,q as St,r as Ct,t as Ft,u as He,v as Ue}from"./crypto-ISZ13pOW.js";import{E as Se}from"./BudgetInsightWidget-BZXXOk6B.js";import{C as je}from"./chevron-down-DXKXSbVN.js";import{R as Mt,h as At,e as Dt,X as Pt,Y as Rt,T as Tt,g as Lt}from"./vendor-charts-D-N8xF42.js";import{C as We}from"./chevron-up-CeJuXOgR.js";import{D as Ye}from"./dollar-sign-9v549d3a.js";import{C as qt}from"./clock-n-vsJ834.js";import{T as $t}from"./triangle-alert-nBcCFUMa.js";import{a as De,S as Pe}from"./square-C4e4vUZa.js";import"./recurring-service-CeElhNBI.js";import"./RecurringOptions-C5WG_2la.js";import"./useXPGain-C01xP4e3.js";import"./useCategories-BWWJ94t8.js";/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],It=J("archive",Et);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=[["path",{d:"m7 7 10 10",key:"1fmybs"}],["path",{d:"M17 7v10H7",key:"6fjiku"}]],Kt=J("arrow-down-right",Bt);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]],Ot=J("arrow-right-left",zt);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]],Vt=J("arrow-up-right",Qt);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]],Ce=J("gift",Ht);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],Wt=J("layers",Ut);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]],Jt=J("percent",Yt),Gt={bank:{icon:"ðŸ¦",color:"text-blue-600",bgColor:"bg-blue-50 dark:bg-blue-900/30"},cash:{icon:"ðŸ’µ",color:"text-green-600",bgColor:"bg-green-50 dark:bg-green-900/30"},credit_card:{icon:"ðŸ’³",color:"text-purple-600",bgColor:"bg-purple-50 dark:bg-purple-900/30"},investment:{icon:"ðŸ“ˆ",color:"text-orange-600",bgColor:"bg-orange-50 dark:bg-orange-900/30"},receivable:{icon:"ðŸ’°",color:"text-teal-600",bgColor:"bg-teal-50 dark:bg-teal-900/30"},savings:{icon:"ðŸ·",color:"text-pink-600",bgColor:"bg-pink-50 dark:bg-pink-900/30"},crypto:{icon:"â‚¿",color:"text-amber-600",bgColor:"bg-amber-50 dark:bg-amber-900/30"},other:{icon:"ðŸ“",color:"text-gray-600",bgColor:"bg-gray-50 dark:bg-gray-700"}};function Xt({account:t,onEdit:r,onAddTransaction:a}){const{t:s}=H("common"),p=Ze(),{data:h}=we(),{isPrivacyMode:n}=ce(),f=Gt[t.type],k=t.current_balance>=0,v=()=>{const C=new Date,S=`${C.getFullYear()}-${String(C.getMonth()+1).padStart(2,"0")}`;p({to:"/transactions",search:{accountId:t.id,month:S,fromAccounts:!0}})},M=C=>{C.stopPropagation(),a==null||a(t.id)};return e.jsxs(X,{className:"relative hover:shadow-md transition-shadow cursor-pointer",onClick:v,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:I("p-3 rounded-lg",f.bgColor),children:e.jsx("span",{className:"text-2xl",children:f.icon})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg text-gray-900 dark:text-gray-100",children:t.name}),e.jsx("p",{className:I("text-sm",f.color),children:s(`account.type.${t.type}`)})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[a&&e.jsx("button",{onClick:M,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors","aria-label":s("transaction.addTransaction"),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5 text-green-600 dark:text-green-400",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"})})}),r&&e.jsx("button",{onClick:C=>{C.stopPropagation(),r(t.id)},className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors","aria-label":s("account.edit"),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor",className:"w-5 h-5 text-gray-600 dark:text-gray-400",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"})})}),!t.is_active&&e.jsx("span",{className:"text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-full",children:s("account.inactive")})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mb-1",children:s("account.currentBalance")}),e.jsx("p",{className:I("text-3xl font-bold font-mono",k?"text-green-600":"text-red-600"),children:W(t.current_balance,t.currency,(h==null?void 0:h.rates)||{},!0,n)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("account.initialBalance")}),e.jsx("p",{className:"text-sm font-mono text-gray-700 dark:text-gray-300",children:W(t.initial_balance,t.currency,(h==null?void 0:h.rates)||{},!0,n)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("account.transactions")}),e.jsx("p",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300",children:t.transaction_count})]})]}),t.notes&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-1",children:s("account.notes")}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:t.notes})]})]})}const re=t=>t==="USD"?100:1;function Zt({isOpen:t,onClose:r,editingAccountId:a}){const{t:s}=H("common"),p=tt(),h=at(),{data:n}=rt(a||void 0),f=pe(),{isPrivacyMode:k}=ce(),[v,M]=c.useState(""),[C,S]=c.useState("bank"),[x,R]=c.useState(""),[D,E]=c.useState(""),[T,b]=c.useState("JPY"),[w,g]=c.useState(""),[j,N]=c.useState({}),[L,q]=c.useState(""),[l,u]=c.useState(!1),d=["bank","cash","credit_card","investment","receivable","savings","other"],P=n&&n.transaction_count>0,$=(()=>{if(!n||!L)return null;const A=re(n.currency),m=parseFloat(L)*A,i=n.current_balance;return m-i})();c.useEffect(()=>{if(t){if(a&&n)if(M(n.name),S(n.type),g(n.notes||""),b(n.currency),P)q(""),u(!1);else{const A=re(n.currency);R((n.initial_balance/A).toString()),E(n.initial_balance_date)}else M(""),S("bank"),R("0"),E(new Date().toISOString().split("T")[0]),b("JPY"),g(""),q(""),u(!1);N({})}},[t,a,n,P]);const o=()=>{const A={};return v.trim()||(A.name=s("account.errors.nameRequired")),a?a&&!P&&(D||(A.initialBalanceDate=s("account.errors.dateRequired"))):D||(A.initialBalanceDate=s("account.errors.dateRequired")),N(A),Object.keys(A).length===0},_=async A=>{if(A.preventDefault(),!!o()){if(a&&P&&L&&!l){u(!0);return}try{if(a){const m={name:v.trim(),type:C,notes:w.trim()||void 0};if(!P&&n){const i=re(n.currency);m.initial_balance=Math.round(parseFloat(x||"0")*i),m.initial_balance_date=D}if(P&&L&&n){const i=re(n.currency);m.desired_current_balance=Math.round(parseFloat(L)*i)}await h.mutateAsync({id:a,data:m})}else{const m=re(T),i={name:v.trim(),type:C,initial_balance:Math.round(parseFloat(x||"0")*m),initial_balance_date:D,currency:T,notes:w.trim()||void 0};await p.mutateAsync(i)}r()}catch(m){N({submit:m.message||s("account.errors.submitFailed")})}}};if(!t)return null;const U=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:r}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},children:[e.jsxs("div",{className:"sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s(a?"account.editAccount":"account.createAccount")}),e.jsx("button",{onClick:r,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:2,stroke:"currentColor",className:"w-6 h-6",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("form",{onSubmit:_,className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[s("account.name")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"name",value:v,onChange:A=>M(A.target.value),className:I("w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500","bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",j.name?"border-red-500":"border-gray-300 dark:border-gray-600"),placeholder:s("account.namePlaceholder")}),j.name&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:j.name})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"type",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[s("account.accountType")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{id:"type",value:C,onChange:A=>S(A.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",children:d.map(A=>e.jsx("option",{value:A,children:s(`account.type.${A}`)},A))})]}),!a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"initialBalance",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:s("account.initialBalance")}),e.jsx("input",{type:"text",inputMode:"decimal",id:"initialBalance",value:Ne(x),onChange:A=>R(ke(A.target.value)),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-numbers",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"initialBalanceDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[s("account.initialBalanceDate")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",id:"initialBalanceDate",value:D,onChange:A=>E(A.target.value),className:I("w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500","bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",j.initialBalanceDate?"border-red-500":"border-gray-300 dark:border-gray-600")}),j.initialBalanceDate&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:j.initialBalanceDate})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"currency",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:s("account.currency")}),e.jsxs("select",{id:"currency",value:T,onChange:A=>b(A.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",children:[e.jsx("option",{value:"JPY",children:"JPY (Â¥)"}),e.jsx("option",{value:"USD",children:"USD ($)"}),e.jsx("option",{value:"VND",children:"VND (â‚«)"})]})]})]}),a&&!P&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"initialBalance",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:s("account.initialBalance")}),e.jsx("input",{type:"text",inputMode:"decimal",id:"initialBalance",value:Ne(x),onChange:A=>R(ke(A.target.value)),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-numbers",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"initialBalanceDate",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[s("account.initialBalanceDate")," ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",id:"initialBalanceDate",value:D,onChange:A=>E(A.target.value),className:I("w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500","bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",j.initialBalanceDate?"border-red-500":"border-gray-300 dark:border-gray-600")}),j.initialBalanceDate&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:j.initialBalanceDate})]})]}),a&&P&&n&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-blue-900 dark:text-blue-200",children:s("account.currentBalance")}),e.jsx("span",{className:"text-lg font-bold text-blue-900 dark:text-blue-200",children:W(n.current_balance,n.currency,f,!0,k)})]}),e.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-300 mt-1",children:s("account.hasTransactionsInfo",{count:n.transaction_count})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"desiredBalance",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:s("account.desiredCurrentBalance")}),e.jsx("input",{type:"text",inputMode:"decimal",id:"desiredBalance",value:Ne(L),onChange:A=>{q(ke(A.target.value)),u(!1)},className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 font-numbers",placeholder:s("account.desiredBalancePlaceholder")}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:s("account.reconcileHint")})]}),$!==null&&$!==0&&e.jsx("div",{className:I("border rounded-lg p-4",$>0?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800":"bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:I("text-sm font-medium",$>0?"text-green-900 dark:text-green-200":"text-red-900 dark:text-red-200"),children:s("account.adjustmentAmount")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:I("text-lg font-bold",$>0?"text-green-900 dark:text-green-200":"text-red-900 dark:text-red-200"),children:$>0?"â†‘":"â†“"}),e.jsx("span",{className:I("text-lg font-bold",$>0?"text-green-900 dark:text-green-200":"text-red-900 dark:text-red-200"),children:W(Math.abs($),n.currency,f,!0,k)})]})]})}),l&&$!==null&&$!==0&&e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("svg",{className:"w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z",clipRule:"evenodd"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-900 dark:text-yellow-200",children:s("account.adjustmentConfirmTitle")}),e.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300 mt-1",children:s("account.adjustmentConfirmMessage",{amount:W(Math.abs($),n.currency,f,!0,k)})})]})]})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:s("account.notes")}),e.jsx("textarea",{id:"notes",value:w,onChange:A=>g(A.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100",rows:3,placeholder:s("account.notesPlaceholder")})]}),j.submit&&e.jsx("div",{className:"bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-3",children:e.jsx("p",{className:"text-red-700 dark:text-red-300 text-sm",children:j.submit})}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[l&&e.jsx("button",{type:"button",onClick:()=>{u(!1),q("")},className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:s("account.cancelAdjustment")}),!l&&e.jsx("button",{type:"button",onClick:r,className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:s("cancel")}),e.jsx("button",{type:"submit",disabled:p.isPending||h.isPending,className:I("flex-1 px-4 py-2 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",l?"bg-yellow-600 hover:bg-yellow-700":"bg-blue-600 hover:bg-blue-700"),children:p.isPending||h.isPending?s("saving"):s(l?"account.confirmAdjustment":a?"update":"create")})]})]})]})]});return typeof document>"u"?null:he.createPortal(U,document.body)}const ea=["eth","bsc","polygon"];function Re({token:t,isPrivacyMode:r}){return e.jsxs("div",{className:"flex items-center justify-between py-1.5 px-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700/50",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.logo_url?e.jsx("img",{src:t.logo_url,alt:t.symbol,className:"w-5 h-5 rounded-full",onError:a=>{a.target.style.display="none"}}):e.jsx("div",{className:"w-5 h-5 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-[10px] font-medium",children:t.symbol.slice(0,2)}),e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 truncate",children:t.symbol})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-900 dark:text-white",children:r?"***":Number(t.balance)<1e-4?"<0.0001":Number(t.balance).toFixed(4)}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:r?"$***":`$${Number(t.balance_usd).toFixed(2)}`})]})]})}function Te(){const{t}=H("common"),r=ee(),{currency:a}=Ee(),{isPrivacyMode:s}=ce(),p=pe(),[h,n]=c.useState(!1),[f,k]=c.useState(""),[v,M]=c.useState(""),[C,S]=c.useState(["eth","bsc","polygon"]),[x,R]=c.useState(null),[D,E]=c.useState(null),{data:T,isLoading:b}=O({queryKey:["crypto-wallets"],queryFn:Ke}),{data:w}=O({queryKey:["crypto-wallets-balance",T==null?void 0:T.map(m=>m.id)],queryFn:async()=>!T||T.length===0?[]:Promise.all(T.map(m=>Nt(m.id))),enabled:!!T&&T.length>0}),{data:g,isLoading:j}=O({queryKey:["crypto-portfolio",D],queryFn:()=>kt(D),enabled:!!D}),N=Q({mutationFn:bt,onSuccess:()=>{r.invalidateQueries({queryKey:["crypto-wallets"]}),n(!1),k(""),M(""),S(["eth","bsc","polygon"])}}),L=Q({mutationFn:ft,onSuccess:()=>{r.invalidateQueries({queryKey:["crypto-wallets"]}),r.invalidateQueries({queryKey:["crypto-wallets-balance"]})}}),q=Q({mutationFn:jt,onSuccess:()=>{r.invalidateQueries({queryKey:["crypto-wallets"]}),r.invalidateQueries({queryKey:["crypto-wallets-balance"]}),r.invalidateQueries({queryKey:["dashboard-summary"]}),R(null)},onError:()=>{R(null)}}),l=()=>{f.trim()&&N.mutate({wallet_address:f.trim(),label:v.trim()||void 0,chains:C})},u=m=>{confirm(t("confirmDelete"))&&L.mutate(m)},d=m=>{R(m),q.mutate(m)},P=m=>{S(i=>i.includes(m)?i.filter(z=>z!==m):[...i,m])},K=m=>{E(i=>i===m?null:m)},$=m=>`${m.slice(0,6)}...${m.slice(-4)}`,o=(m,i)=>{const z={eth:`https://etherscan.io/address/${m}`,bsc:`https://bscscan.com/address/${m}`,polygon:`https://polygonscan.com/address/${m}`,arbitrum:`https://arbiscan.io/address/${m}`,optimism:`https://optimistic.etherscan.io/address/${m}`};return z[i]||z.eth},_=(w==null?void 0:w.reduce((m,i)=>m+Number(i.total_balance_usd||0),0))||0,U=1/((p==null?void 0:p.USD)||.00667),A=Math.round(_*U);return b?e.jsx(ge,{title:t("crypto.wallets"),badge:0,children:e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(le,{size:"md"})})}):e.jsxs(ge,{title:t("crypto.wallets"),badge:(T==null?void 0:T.length)||0,defaultOpen:T&&T.length>0,children:[w&&w.length>0&&e.jsxs("div",{className:"mb-4 p-4 bg-gradient-to-r from-purple-500/10 to-blue-500/10 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:t("crypto.totalBalance")}),e.jsx("p",{className:"text-2xl font-bold text-purple-600 dark:text-purple-400",children:W(A,a,p,!1,s)})]}),w&&w.length>0?e.jsx("div",{className:"space-y-3 mb-4",children:w.map(m=>{var i,z;return e.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg",children:e.jsx(me,{className:"w-5 h-5 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white truncate",children:m.label||$(m.wallet_address)}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("code",{className:"text-xs",children:$(m.wallet_address)}),e.jsx("a",{href:o(m.wallet_address,"eth"),target:"_blank",rel:"noopener noreferrer",className:"hover:text-purple-500",children:e.jsx(Se,{className:"w-3 h-3"})})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:s?"$***":`$${Number(m.total_balance_usd||0).toFixed(2)}`}),e.jsx("div",{className:"flex gap-1 mt-1",children:(i=m.chains)==null?void 0:i.map(y=>{var F;return e.jsx("span",{className:"text-xs px-1.5 py-0.5 bg-gray-200 dark:bg-gray-700 rounded",title:(F=ye[y])==null?void 0:F.name,children:y.toUpperCase()},y)})})]})]}),e.jsxs("button",{onClick:()=>K(m.id),className:"flex items-center gap-2 mt-3 text-sm text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 transition-colors",children:[D===m.id?e.jsx(je,{className:"w-4 h-4"}):e.jsx(Ie,{className:"w-4 h-4"}),t("crypto.tokens")]}),D===m.id&&e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:j?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(le,{size:"sm"})}):g!=null&&g.chains&&g.chains.length>0?e.jsx("div",{className:"space-y-4",children:g.chains.filter(y=>y.tokens.length>0||y.native_balance).sort((y,F)=>Number(F.total_usd)-Number(y.total_usd)).map(y=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase",children:y.chain_name}),e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:s?"$***":`$${Number(y.total_usd).toFixed(2)}`})]}),e.jsxs("div",{className:"space-y-1",children:[y.native_balance&&Number(y.native_balance.balance)>0&&e.jsx(Re,{token:y.native_balance,isPrivacyMode:s}),y.tokens.filter(F=>Number(F.balance_usd)>=1).sort((F,B)=>Number(B.balance_usd)-Number(F.balance_usd)).map(F=>e.jsx(Re,{token:F,isPrivacyMode:s},F.token_address))]})]},y.chain_id))}):e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500 text-center py-2",children:t("crypto.noTokens")})}),e.jsxs("div",{className:"flex items-center justify-between mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:(z=m.sync_statuses)!=null&&z.some(y=>y.last_sync_at)?t("crypto.lastSync",{time:new Date(Math.max(...m.sync_statuses.filter(y=>y.last_sync_at).map(y=>new Date(y.last_sync_at).getTime()))).toLocaleString()}):t("crypto.neverSynced")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>d(m.id),disabled:x===m.id,className:"p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded-lg transition-colors",title:t("crypto.sync"),children:x===m.id?e.jsx(le,{size:"sm"}):e.jsx(Y,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>u(m.id),className:"p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors",title:t("delete"),children:e.jsx(st,{className:"w-4 h-4"})})]})]})]},m.id)})}):h?null:e.jsxs("div",{className:"text-center py-6",children:[e.jsx(me,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mb-2",children:t("crypto.noWallets")}),e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:t("crypto.addWalletDescription")})]}),h?e.jsxs("div",{className:"p-4 bg-gray-50 dark:bg-gray-800 rounded-lg space-y-4",children:[e.jsx(Fe,{label:t("crypto.walletAddress"),placeholder:"0x...",value:f,onChange:m=>k(m.target.value)}),e.jsx(Fe,{label:t("crypto.walletLabel"),placeholder:t("crypto.walletLabelPlaceholder"),value:v,onChange:m=>M(m.target.value)}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:t("crypto.selectChains")}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ea.map(m=>{var i;return e.jsx("button",{type:"button",onClick:()=>P(m),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${C.includes(m)?"bg-purple-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300"}`,children:((i=ye[m])==null?void 0:i.name)||m.toUpperCase()},m)})})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(ie,{variant:"outline",onClick:()=>n(!1),children:t("cancel")}),e.jsx(ie,{onClick:l,disabled:!f.trim()||C.length===0||N.isPending,children:N.isPending?t("saving"):t("crypto.addWallet")})]})]}):e.jsxs(ie,{variant:"outline",onClick:()=>n(!0),className:"w-full",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),t("crypto.addWallet")]})]})}function ta({snapshots:t}){const{resolvedTheme:r}=nt(),a=r==="dark",s=a?"#374151":"#E5E7EB",p=a?"#9CA3AF":"#6B7280",h=a?"#1F2937":"#FFFFFF",n=a?"#374151":"#E5E7EB",f="#6366F1",k=c.useMemo(()=>[...t].sort((C,S)=>new Date(C.snapshot_date).getTime()-new Date(S.snapshot_date).getTime()).map(C=>({date:C.snapshot_date,value:Number(C.balance_usd),formattedDate:new Date(C.snapshot_date).toLocaleDateString(Z(),{month:"short",day:"numeric"})})),[t]),[v,M]=c.useMemo(()=>{const C=k.map(D=>D.value),S=Math.min(...C),x=Math.max(...C),R=(x-S)*.1||10;return[Math.max(0,S-R),x+R]},[k]);return k.length===0?e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500",children:"No historical data available"}):e.jsx(Mt,{width:"100%",height:"100%",children:e.jsxs(At,{data:k,margin:{top:5,right:10,left:0,bottom:5},children:[e.jsx(Dt,{strokeDasharray:"3 3",stroke:s,vertical:!1}),e.jsx(Pt,{dataKey:"formattedDate",tick:{fill:p,fontSize:11},tickLine:!1,axisLine:{stroke:s},interval:"preserveStartEnd"}),e.jsx(Rt,{domain:[v,M],tick:{fill:p,fontSize:11},tickLine:!1,axisLine:!1,tickFormatter:C=>`$${C.toFixed(0)}`,width:50}),e.jsx(Tt,{contentStyle:{backgroundColor:h,border:`1px solid ${n}`,borderRadius:"8px",fontSize:"12px"},labelStyle:{color:p,fontWeight:"bold"},formatter:C=>[`$${C.toFixed(2)}`,"Value"]}),e.jsx(Lt,{type:"monotone",dataKey:"value",stroke:f,strokeWidth:2,dot:k.length<=10,activeDot:{r:6,fill:f}})]})})}function aa({positionId:t}){var K,$;const{t:r}=H(),a=ee(),[s,p]=c.useState(null),[h,n]=c.useState(!1),[f,k]=c.useState(null),[v,M]=c.useState(null),[C,S]=c.useState(null),{data:x,isLoading:R}=O({queryKey:["position-roi",t],queryFn:()=>Ve(t)}),{data:D=[]}=O({queryKey:["position-rewards-list",t],queryFn:()=>vt(t)}),E=Q({mutationFn:()=>ze(90),onSuccess:o=>{p({scanned:o.scanned_claims,new:o.new_claims}),a.invalidateQueries({queryKey:["position-roi"]}),a.invalidateQueries({queryKey:["position-rewards-list"]}),a.invalidateQueries({queryKey:["unattributed-rewards"]}),setTimeout(()=>p(null),5e3)}}),T=Q({mutationFn:o=>Oe(o),onSuccess:o=>{M(r("crypto.transactionCreated","Transaction created: ${{amount}}",{amount:o.amount_usd.toFixed(2)})),a.invalidateQueries({queryKey:["position-rewards-list"]}),a.invalidateQueries({queryKey:["transactions"]}),k(null),setTimeout(()=>M(null),5e3)},onError:o=>{S(o.message||r("crypto.transactionCreateError","Failed to create transaction")),k(null),setTimeout(()=>S(null),5e3)}}),b=Q({mutationFn:o=>Qe(o),onSuccess:o=>{const _=r("crypto.batchTransactionsCreated","Created {{created}} transactions (${{total}}). Skipped: {{skipped}}",{created:o.created,total:o.total_usd.toFixed(2),skipped:o.skipped});M(_),a.invalidateQueries({queryKey:["position-rewards-list"]}),a.invalidateQueries({queryKey:["transactions"]}),setTimeout(()=>M(null),8e3)},onError:o=>{S(o.message||r("crypto.batchTransactionError","Failed to create transactions")),setTimeout(()=>S(null),5e3)}}),w=D.filter(o=>!o.transaction_id),g=1,j=((K=x==null?void 0:x.rewards_by_token)==null?void 0:K.filter(o=>Number(o.amount_usd)>=g))||[],N=(($=x==null?void 0:x.rewards_by_month)==null?void 0:$.filter(o=>Number(o.amount_usd)>=g))||[],L=D.filter(o=>Number(o.reward_usd||0)>=g),q=j.reduce((o,_)=>o+Number(_.amount_usd||0),0);if(R)return e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-24 bg-gray-200 dark:bg-gray-700 rounded-lg"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded-lg"})]});const l=o=>{if(o==null)return null;const _=Number(o);return isNaN(_)?null:`$${_.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`},u=o=>{if(o===null)return"-";const _=Number(o);return`${_>=0?"+":""}${_.toFixed(2)}%`},d=o=>{const[_,U]=o.split("-");return new Date(Number(_),Number(U)-1).toLocaleDateString(Z(),{month:"short",year:"numeric"})},P=o=>Number(o).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg",children:[e.jsx("div",{className:"text-sm text-indigo-700 dark:text-indigo-300",children:r("crypto.scanRewardsHint","Scan blockchain for claimed rewards")}),e.jsx("button",{onClick:()=>E.mutate(),disabled:E.isPending,className:"flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white text-sm font-medium rounded-lg transition-colors",children:E.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4 animate-spin"}),r("crypto.scanning","Scanning...")]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4"}),r("crypto.scanRewards","Scan Rewards")]})})]}),s&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(de,{className:"h-4 w-4"}),r("crypto.scanComplete","Scanned {{scanned}} claims, found {{new}} new",s)]}),x&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-medium text-green-800 dark:text-green-200 mb-3 flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),r("crypto.roiSummary","ROI Summary")]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:r("crypto.totalRewards","Total Rewards")}),j.length>0?e.jsx("div",{className:"space-y-1",children:j.map(o=>{const _=l(o.amount_usd);return e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:[P(o.amount)," ",o.symbol]}),_&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400",children:["â‰ˆ ",_]})]},o.symbol)})}):e.jsx("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:l(q)||"-"}),e.jsxs("div",{className:"text-xs text-green-600 dark:text-green-400",children:[L.length," ",r("crypto.claims","claims")]})]}),x.cost_basis_usd!==null&&x.simple_roi_pct!==null&&e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2 border-t border-green-200 dark:border-green-800",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:r("crypto.costBasis","Cost Basis")}),e.jsx("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:l(x.cost_basis_usd)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:r("crypto.roi","ROI")}),e.jsx("div",{className:`text-lg font-semibold ${x.simple_roi_pct>=0?"text-green-800 dark:text-green-200":"text-red-600 dark:text-red-400"}`,children:u(x.simple_roi_pct)}),x.days_held&&e.jsxs("div",{className:"text-xs text-green-600 dark:text-green-400",children:[x.days_held," ",r("crypto.daysHeld","days")]})]})]})]})]}),x&&N.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2",children:[e.jsx(_e,{className:"h-4 w-4"}),r("crypto.monthlyBreakdown","Monthly Breakdown")]}),e.jsx("div",{className:"space-y-2",children:N.map(o=>{const _=l(o.amount_usd);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-gray-100",children:d(o.month)}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[o.count," ",r("crypto.claims","claims")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[P(o.amount)," ",o.symbol]}),_&&e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["â‰ˆ ",_]})]})]},`${o.month}-${o.symbol}`)})})]}),L.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("button",{onClick:()=>n(!h),className:"flex items-center gap-2 font-medium text-gray-900 dark:text-gray-100 hover:text-primary-600 dark:hover:text-primary-400 transition-colors",children:[e.jsx(ve,{className:"h-4 w-4"}),r("crypto.allRewards","All Rewards")," (",L.length,")",h?e.jsx(We,{className:"h-4 w-4"}):e.jsx(je,{className:"h-4 w-4"})]}),w.length>0&&e.jsxs("button",{type:"button",onClick:()=>b.mutate(w.map(o=>o.id)),disabled:b.isPending,className:"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-white bg-primary-600 hover:bg-primary-700 disabled:bg-primary-400 rounded-lg transition-colors",children:[b.isPending?e.jsx(ue,{className:"h-3.5 w-3.5 animate-spin"}):e.jsx(oe,{className:"h-3.5 w-3.5"}),r("crypto.createAllTransactions","Create All Txns")," (",w.length,")"]})]}),h&&e.jsxs(e.Fragment,{children:[v&&e.jsxs("div",{className:"flex items-center gap-2 p-3 mb-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(de,{className:"h-4 w-4"}),v]}),C&&e.jsxs("div",{className:"flex items-center gap-2 p-3 mb-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-sm text-red-700 dark:text-red-300",children:[e.jsx(G,{className:"h-4 w-4"}),C]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:L.map(o=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:[Number(o.reward_amount).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:4})," ",o.reward_token_symbol||"tokens"]}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[new Date(o.claimed_at).toLocaleDateString(Z())," via ",o.source,o.reward_usd&&e.jsxs("span",{className:"ml-2 text-green-600 dark:text-green-400",children:["â‰ˆ $",Number(o.reward_usd).toFixed(2)]})]})]}),o.reward_usd&&Number(o.reward_usd)>0&&e.jsx("div",{className:"flex-shrink-0 ml-3",children:o.transaction_id?e.jsxs("a",{href:`/transactions?id=${o.transaction_id}`,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/30 rounded hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors",children:[e.jsx(Se,{className:"h-3 w-3"}),r("crypto.viewTransaction","View Txn")]}):e.jsxs("button",{type:"button",onClick:()=>{k(o.id),T.mutate(o.id)},disabled:f===o.id,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-primary-700 dark:text-primary-300 bg-primary-100 dark:bg-primary-900/30 rounded hover:bg-primary-200 dark:hover:bg-primary-900/50 disabled:opacity-50 transition-colors",children:[f===o.id?e.jsx(ue,{className:"h-3 w-3 animate-spin"}):e.jsx(ve,{className:"h-3 w-3"}),r("crypto.createTransaction","Create Txn")]})})]},o.id))})]})]}),x&&L.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx(Ce,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),q<g?r("crypto.rewardsBelowThreshold","No rewards above ${{threshold}} to display",{threshold:g}):r("crypto.noRewards","No rewards claimed for this position yet.")]})]})}function ra({source:t="symbiotic"}){var L,q;const{t:r}=H(),a=ee(),[s,p]=c.useState(null),[h,n]=c.useState(null),[f,k]=c.useState(null),{data:v,isLoading:M}=O({queryKey:["staking-rewards",t],queryFn:()=>wt(t)}),{data:C=[]}=O({queryKey:["all-rewards"],queryFn:_t}),S=C.filter(l=>!l.transaction_id&&l.reward_usd&&Number(l.reward_usd)>0),x=Q({mutationFn:()=>ze(90),onSuccess:l=>{p({scanned:l.scanned_claims,new:l.new_claims}),a.invalidateQueries({queryKey:["staking-rewards"]}),a.invalidateQueries({queryKey:["all-rewards"]}),setTimeout(()=>p(null),5e3)}}),R=Q({mutationFn:l=>Qe(l),onSuccess:l=>{const u=r("crypto.batchTransactionsCreated","Created {{created}} transactions (${{total}}). Skipped: {{skipped}}",{created:l.created,total:l.total_usd.toFixed(2),skipped:l.skipped});n(u),a.invalidateQueries({queryKey:["all-rewards"]}),a.invalidateQueries({queryKey:["staking-rewards"]}),a.invalidateQueries({queryKey:["transactions"]}),setTimeout(()=>n(null),8e3)},onError:l=>{k(l.message||r("crypto.batchTransactionError","Failed to create transactions")),setTimeout(()=>k(null),5e3)}});if(M)return e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-24 bg-gray-200 dark:bg-gray-700 rounded-lg"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded-lg"})]});const D=l=>{if(l==null)return null;const u=Number(l);return isNaN(u)?null:`$${u.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}`},E=l=>{const[u,d]=l.split("-");return new Date(Number(u),Number(d)-1).toLocaleDateString(Z(),{month:"short",year:"numeric"})},T=l=>Number(l).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:4}),b=t==="symbiotic"?"Symbiotic":t,w=1,g=((L=v==null?void 0:v.rewards_by_token)==null?void 0:L.filter(l=>Number(l.amount_usd)>=w))||[],j=((q=v==null?void 0:v.rewards_by_month)==null?void 0:q.filter(l=>Number(l.amount_usd)>=w))||[],N=g.reduce((l,u)=>l+Number(u.amount_usd||0),0);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg",children:[e.jsx("div",{className:"text-sm text-indigo-700 dark:text-indigo-300",children:r("crypto.scanStakingRewardsHint","Scan blockchain for claimed staking rewards")}),e.jsx("button",{onClick:()=>x.mutate(),disabled:x.isPending,className:"flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white text-sm font-medium rounded-lg transition-colors",children:x.isPending?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4 animate-spin"}),r("crypto.scanning","Scanning...")]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4"}),r("crypto.scanRewards","Scan Rewards")]})})]}),s&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(de,{className:"h-4 w-4"}),r("crypto.scanComplete","Scanned {{scanned}} claims, found {{new}} new",s)]}),h&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(de,{className:"h-4 w-4"}),h]}),f&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-sm text-red-700 dark:text-red-300",children:[e.jsx(G,{className:"h-4 w-4"}),f]}),S.length>0&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg",children:[e.jsx("div",{className:"text-sm text-amber-700 dark:text-amber-300",children:r("crypto.unlinkedRewardsHint","{{count}} rewards ready to convert to transactions",{count:S.length})}),e.jsx("button",{onClick:()=>R.mutate(S.map(l=>l.id)),disabled:R.isPending,className:"flex items-center gap-2 px-3 py-1.5 bg-amber-600 hover:bg-amber-700 disabled:bg-amber-400 text-white text-sm font-medium rounded-lg transition-colors",children:R.isPending?e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"h-4 w-4 animate-spin"}),r("crypto.creating","Creating...")]}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"h-4 w-4"}),r("crypto.createAllTransactions","Create All Txns")," (",S.length,")"]})})]}),v&&g.length>0&&e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-4",children:[e.jsxs("h4",{className:"font-medium text-green-800 dark:text-green-200 mb-3 flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),r("crypto.stakingRewardsSummary","{{source}} Rewards Summary",{source:b})]}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400",children:r("crypto.totalRewards","Total Rewards")}),g.length>0?e.jsx("div",{className:"space-y-1",children:g.map(l=>{const u=D(l.amount_usd);return e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:[T(l.amount)," ",l.symbol]}),u&&e.jsxs("div",{className:"text-sm text-green-600 dark:text-green-400",children:["â‰ˆ ",u]})]},l.symbol)})}):e.jsx("div",{className:"text-lg font-semibold text-green-800 dark:text-green-200",children:D(N)||"-"}),e.jsxs("div",{className:"text-xs text-green-600 dark:text-green-400 mt-1",children:[j.reduce((l,u)=>l+u.count,0)," ",r("crypto.claims","claims")]})]})})]}),v&&j.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-gray-900 dark:text-gray-100 mb-3 flex items-center gap-2",children:[e.jsx(_e,{className:"h-4 w-4"}),r("crypto.monthlyBreakdown","Monthly Breakdown")]}),e.jsx("div",{className:"space-y-2",children:j.map(l=>{const u=D(l.amount_usd);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-gray-100",children:E(l.month)}),e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:[l.count," ",r("crypto.claims","claims")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"font-semibold text-gray-900 dark:text-gray-100",children:[T(l.amount)," ",l.symbol]}),u&&e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["â‰ˆ ",u]})]})]},`${l.month}-${l.symbol}`)})})]}),v&&g.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx(Ce,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"font-medium text-gray-700 dark:text-gray-300 mb-2",children:N<w?r("crypto.rewardsBelowThreshold","No rewards above ${{threshold}} to display",{threshold:w}):r("crypto.noStakingRewards","No staking rewards found")}),e.jsx("p",{className:"text-sm",children:r("crypto.noStakingRewardsHint",'Click "Scan Rewards" to search for claimed rewards on the blockchain.')})]})]})}async function sa(t,r){return(await fe.post(`/api/crypto/positions/${encodeURIComponent(t)}/close`,r)).data}async function na(){return(await fe.get("/api/crypto/positions/closed")).data}function la({group:t,lastSnapshotValueUsd:r,costBasisUsd:a,totalRewardsUsd:s,onClose:p,onSuccess:h}){var o;const{t:n}=H("common"),{data:f}=we(),k=((o=f==null?void 0:f.rates)==null?void 0:o.USD)||150,v=ee(),[M,C]=c.useState(new Date().toISOString().slice(0,16)),[S,x]=c.useState(r),[R,D]=c.useState(Math.round(r*k)),[E,T]=c.useState(null),[b,w]=c.useState(`LP Exit: ${t.protocol} ${t.name}`),[g,j]=c.useState("");c.useEffect(()=>{D(Math.round(S*k))},[S,k]);const{data:N}=O({queryKey:["accounts"],queryFn:()=>it()}),L=(N==null?void 0:N.filter(_=>_.is_active&&(_.type==="bank"||_.type==="savings")))||[],q=a!==null?S-a+(s||0):null,l=a&&q!==null?q/a*100:null,u=t.tokens[0],d=(u==null?void 0:u.id)||"",P=(u==null?void 0:u.wallet_address)||"",K=Q({mutationFn:()=>{if(!E)throw new Error(n("crypto.selectAccount","Select destination account"));const _={exit_date:new Date(M).toISOString(),exit_value_usd:S,exit_value_jpy:R,destination_account_id:E,note:b||void 0,tx_hash:g||void 0,wallet_address:P,chain_id:t.chain_id,protocol:t.protocol,symbol:t.name};return sa(d,_)},onSuccess:()=>{v.invalidateQueries({queryKey:["closed-positions"]}),v.invalidateQueries({queryKey:["defi-positions"]}),v.invalidateQueries({queryKey:["accounts"]}),h(),p()}}),$=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4 overflow-hidden",style:{touchAction:"pan-y"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:p}),e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto overflow-x-hidden",onClick:_=>_.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 dark:text-white",children:n("crypto.closePosition","Close Position")}),e.jsx("button",{onClick:p,className:"p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg",children:e.jsx(G,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-3",children:[e.jsxs("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:[t.protocol," - ",t.name]}),e.jsx("p",{className:"text-xs text-gray-500",children:t.chain_id.toUpperCase()})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[e.jsx(_e,{className:"w-4 h-4 inline mr-1"}),n("crypto.exitDate","Exit Date")]}),e.jsx("input",{type:"datetime-local",value:M,onChange:_=>C(_.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[e.jsx(Ye,{className:"w-4 h-4 inline mr-1"}),n("crypto.exitValue","Exit Value")," (USD)"]}),e.jsx("input",{type:"number",step:"0.01",value:S,onChange:_=>x(parseFloat(_.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[n("crypto.exitValue","Exit Value")," (JPY)"]}),e.jsx("input",{type:"number",value:R,onChange:_=>D(parseInt(_.target.value)||0),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[e.jsx(me,{className:"w-4 h-4 inline mr-1"}),n("crypto.destinationAccount","Destination Account")]}),e.jsxs("select",{value:E||"",onChange:_=>T(parseInt(_.target.value)||null),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white",children:[e.jsx("option",{value:"",children:n("select","Select...")}),L.map(_=>e.jsx("option",{value:_.id,children:_.name},_.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:n("note","Note")}),e.jsx("input",{type:"text",value:b,onChange:_=>w(_.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:["TX Hash (",n("optional","optional"),")"]}),e.jsx("input",{type:"text",value:g,onChange:_=>j(_.target.value),placeholder:"0x...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white font-mono text-sm"})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:n("crypto.pnlPreview","P&L Preview")}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:n("crypto.costBasis","Cost Basis")}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:a!==null?`$${a.toFixed(2)}`:"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-500",children:n("crypto.totalRewards","Total Rewards")}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:s?`$${s.toFixed(2)}`:"$0.00"})]}),e.jsxs("div",{className:"col-span-2 pt-2 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("p",{className:"text-gray-500",children:n("crypto.realizedPnl","Realized P&L")}),e.jsx("p",{className:`text-lg font-bold ${q!==null?q>=0?"text-green-600":"text-red-600":"text-gray-400"}`,children:q!==null?`${q>=0?"+":""}$${q.toFixed(2)} (${l==null?void 0:l.toFixed(1)}%)`:"N/A"})]})]})]}),K.error&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[e.jsx(lt,{className:"w-4 h-4"}),K.error.message]})]}),e.jsxs("div",{className:"flex gap-3 p-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("button",{onClick:p,className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800",children:n("cancel","Cancel")}),e.jsx("button",{onClick:()=>K.mutate(),disabled:!E||K.isPending,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50",children:K.isPending?n("loading","Loading..."):n("crypto.confirmClose","Confirm Close")})]})]})]});return typeof document>"u"?null:he.createPortal($,document.body)}function ia({group:t,onClose:r}){const[a,s]=c.useState("overview"),[p,h]=c.useState(!1),n=t.tokens[0],f=Ae({queries:t.tokens.map(b=>({queryKey:["position-history",b.id],queryFn:()=>St(b.id,30),retry:!1}))}),k=f.some(b=>b.isLoading),v=c.useMemo(()=>{const b=f.filter(j=>{var N;return(N=j.data)==null?void 0:N.snapshots}).flatMap(j=>j.data.snapshots);if(b.length===0)return null;const w=new Map;for(const j of b){const N=w.get(j.snapshot_date)||0;w.set(j.snapshot_date,N+Number(j.balance_usd))}return{snapshots:Array.from(w.entries()).map(([j,N])=>({snapshot_date:j,balance_usd:N}))}},[f]),M=Ae({queries:t.tokens.map(b=>({queryKey:["position-performance",b.id],queryFn:()=>Ct(b.id),retry:!1}))}),C=M.some(b=>b.isLoading),S=M.every(b=>!b.isLoading),x=c.useMemo(()=>{if(!S)return null;const b=M.filter($=>$.data);if(b.length===0)return null;const w=b[0].data;if(b.length===1)return w;let g=0,j=0,N=0,L=0,q=0,l=!1,u=0,d=0;for(const $ of b){const o=$.data;g+=Number(o.start_value_usd),j+=Number(o.current_value_usd),N+=Number(o.total_return_usd),L=Math.max(L,o.days_held),q+=o.snapshot_count,o.il_usd!=null&&(l=!0,u+=Number(o.il_usd)),o.hodl_value_usd!=null&&(d+=Number(o.hodl_value_usd))}const P=g>0?N/g*100:0;let K=null;if(L>=7&&g>0){const $=((j/g)**(365/L)-1)*100;Math.abs($)<=500&&(K=$)}return{position_id:w.position_id,protocol:w.protocol,symbol:t.name,days_held:L,start_value_usd:g,current_value_usd:j,total_return_usd:N,total_return_pct:P,annualized_return_pct:K,current_apy:w.current_apy,snapshot_count:q,il_percentage:l&&g>0?u/g*100:null,il_usd:l?u:null,hodl_value_usd:l?d:null,lp_vs_hodl_usd:l?j-d:null,lp_outperformed_hodl:l?j>d:void 0}},[M,t.name,S]),{data:R}=O({queryKey:["position-roi",n.id],queryFn:()=>Ve(n.id),retry:!1}),D=k||C,E=b=>{const w=Number(b.balance);return w<1e-4?"<0.0001":w<1?w.toFixed(4):w.toFixed(2)},T=e.jsxs("div",{className:"fixed inset-0 z-[100001]",children:[e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm",onClick:r}),e.jsx("div",{className:"fixed inset-0 z-[100002] flex items-center justify-center p-4 overflow-y-auto",children:e.jsxs("div",{className:"relative bg-white dark:bg-gray-900 rounded-2xl shadow-2xl max-w-lg w-full mx-4 max-h-[90dvh] my-auto overflow-hidden",children:[e.jsxs("div",{className:"bg-gradient-to-r from-gray-900 to-gray-800 dark:from-gray-800 dark:to-gray-900 p-6 text-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex -space-x-2",children:t.tokens.slice(0,3).map((b,w)=>b.logo_url?e.jsx("img",{src:b.logo_url,alt:b.symbol,className:"w-10 h-10 rounded-full border-2 border-white/20",style:{zIndex:t.tokens.length-w}},b.id):e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-sm border-2 border-white/20",style:{zIndex:t.tokens.length-w},children:b.symbol.slice(0,2)},b.id))}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:t.protocol}),e.jsx("p",{className:"text-gray-400 text-sm",children:t.name})]})]}),e.jsx("button",{onClick:r,className:"p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition-colors",children:e.jsx(G,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-gray-400 text-sm mb-1",children:"Current Value"}),e.jsxs("p",{className:"text-4xl font-bold",children:["$",t.total_usd.toFixed(2)]}),e.jsx("div",{className:"flex items-center justify-center gap-2 mt-2 text-sm",children:e.jsx("span",{className:"text-gray-400",children:t.tokens.map((b,w)=>e.jsxs("span",{children:[w>0&&" + ",E(b)," ",b.symbol]},b.id))})})]})]}),e.jsxs("div",{className:"flex border-b border-gray-200 dark:border-gray-700",children:[e.jsx("button",{onClick:()=>s("overview"),className:I("flex-1 px-4 py-3 text-sm font-medium transition-colors",a==="overview"?"text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400":"text-gray-500 hover:text-gray-700"),children:"Gain/Loss"}),e.jsxs("button",{onClick:()=>s("rewards"),className:I("flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2",a==="rewards"?"text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400":"text-gray-500 hover:text-gray-700"),children:[e.jsx(Ce,{className:"w-4 h-4"}),"Rewards"]})]}),e.jsx("div",{className:"p-4 space-y-4 max-h-[50vh] overflow-y-auto",children:D?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(le,{size:"lg"})}):e.jsxs(e.Fragment,{children:[a==="overview"&&e.jsxs(e.Fragment,{children:[x&&e.jsxs(X,{className:"overflow-hidden",children:[e.jsxs("div",{className:I("p-4 text-center",Number(x.total_return_pct)>=0?"bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20":"bg-gradient-to-br from-red-50 to-rose-50 dark:from-red-900/20 dark:to-rose-900/20"),children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[Number(x.total_return_pct)>=0?e.jsx(Vt,{className:"w-5 h-5 text-green-600"}):e.jsx(Kt,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:I("text-sm font-medium",Number(x.total_return_pct)>=0?"text-green-700 dark:text-green-400":"text-red-700 dark:text-red-400"),children:"Total Return"})]}),e.jsxs("p",{className:I("text-3xl font-bold",Number(x.total_return_pct)>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"),children:[Number(x.total_return_pct)>=0?"+":"",x.total_return_pct.toFixed(2),"%"]}),e.jsxs("p",{className:I("text-lg font-semibold mt-1",Number(x.total_return_usd)>=0?"text-green-700 dark:text-green-400":"text-red-700 dark:text-red-400"),children:[Number(x.total_return_usd)>=0?"+":"","$",Math.abs(Number(x.total_return_usd)).toFixed(2)]})]}),e.jsxs("div",{className:"p-4 grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-gray-500 dark:text-gray-400 text-xs mb-1",children:[e.jsx(Ye,{className:"w-3.5 h-3.5"}),"Invested"]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-white",children:["$",Number(x.start_value_usd).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-gray-500 dark:text-gray-400 text-xs mb-1",children:[e.jsx(qt,{className:"w-3.5 h-3.5"}),"Duration"]}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-white",children:[x.days_held," days"]})]})]})]}),x&&x.annualized_return_pct!==null&&e.jsx(X,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jt,{className:"w-4 h-4 text-indigo-500"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Annualized Return"})]}),e.jsxs("span",{className:I("font-bold text-lg",Number(x.annualized_return_pct)>=0?"text-green-600":"text-red-600"),children:[Number(x.annualized_return_pct)>=0?"+":"",x.annualized_return_pct.toFixed(2),"%"]})]})}),x&&x.current_apy!=null&&e.jsx(X,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-4 h-4 text-purple-500"}),e.jsx("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Current APY"})]}),e.jsxs("span",{className:"font-bold text-lg text-purple-600 dark:text-purple-400",children:[Number(x.current_apy).toFixed(2),"%"]})]})}),v&&v.snapshots.length>0&&e.jsxs(X,{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-600 dark:text-gray-400 mb-3",children:"30-Day Performance"}),e.jsx("div",{className:"h-40",children:e.jsx(ta,{snapshots:v.snapshots})})]}),e.jsx("button",{onClick:()=>h(!0),className:"w-full py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors",children:"Close Position"})]}),a==="rewards"&&e.jsx(e.Fragment,{children:t.protocol_module==="staked"?e.jsx(ra,{source:"symbiotic"}):e.jsx(aa,{positionId:n.id})})]})}),p&&e.jsx(la,{group:t,lastSnapshotValueUsd:t.total_usd,costBasisUsd:(R==null?void 0:R.cost_basis_usd)??null,totalRewardsUsd:(R==null?void 0:R.total_rewards_usd)??null,onClose:()=>h(!1),onSuccess:()=>{h(!1),r()}})]})})]});return typeof document>"u"?null:he.createPortal(T,document.body)}function oa({walletId:t}){const{t:r}=H(),a=ee(),[s,p]=c.useState(new Set),[h,n]=c.useState(""),{data:f=[]}=O({queryKey:["unattributed-rewards"],queryFn:He}),{data:k}=O({queryKey:["defi-positions",t],queryFn:()=>Ue(t),enabled:!!t}),v=Q({mutationFn:({rewardIds:d,positionId:P})=>Ft(d,P),onSuccess:()=>{a.invalidateQueries({queryKey:["unattributed-rewards"]}),a.invalidateQueries({queryKey:["position-rewards"]}),p(new Set),n("")}}),[M,C]=c.useState(null),[S,x]=c.useState(null),[R,D]=c.useState(null),E=Q({mutationFn:d=>Oe(d),onSuccess:d=>{x(r("crypto.transactionCreated","Transaction created: ${{amount}}",{amount:d.amount_usd.toFixed(2)})),a.invalidateQueries({queryKey:["unattributed-rewards"]}),a.invalidateQueries({queryKey:["transactions"]}),C(null),setTimeout(()=>x(null),5e3)},onError:d=>{D(d.message||r("crypto.transactionCreateError","Failed to create transaction")),C(null),setTimeout(()=>D(null),5e3)}});if(f.length===0)return null;const T=1,b=f.filter(d=>Number(d.reward_usd||0)>=T);if(b.length===0)return null;const w=(k==null?void 0:k.positions)||[],g=d=>`${Number(d.reward_amount).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:6})} ${d.reward_token_symbol||"tokens"}`,j=d=>new Date(d).toLocaleDateString(Z(),{month:"short",day:"numeric",year:"numeric"}),N=d=>{const P=new Set(s);P.has(d)?P.delete(d):P.add(d),p(P)},L=()=>{s.size===b.length?p(new Set):p(new Set(b.map(d=>d.id)))},q=b.length>0&&s.size===b.length,l=s.size>0,u=()=>{s.size===0||!h||v.mutate({rewardIds:Array.from(s),positionId:h})};return e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx($t,{className:"h-5 w-5 text-yellow-600 dark:text-yellow-500"}),e.jsx("h3",{className:"font-medium text-yellow-800 dark:text-yellow-200",children:r("crypto.unattributedRewards",{count:b.length})})]}),e.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300 mb-4",children:r("crypto.unattributedRewardsDesc","These rewards need to be assigned to a position for ROI tracking.")}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3 mb-4 p-3 bg-white dark:bg-gray-800 rounded-lg border border-yellow-100 dark:border-gray-700",children:[e.jsxs("button",{type:"button",onClick:L,className:"flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors",children:[q?e.jsx(De,{className:"h-4 w-4 text-primary-600"}):e.jsx(Pe,{className:"h-4 w-4"}),q?r("deselectAll","Deselect All"):r("selectAll","Select All")]}),e.jsxs("div",{className:"flex-1 flex flex-col sm:flex-row items-stretch sm:items-center gap-2",children:[e.jsxs("select",{value:h,onChange:d=>n(d.target.value),disabled:!l,className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-100 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx("option",{value:"",children:r("crypto.selectPosition","Select position...")}),w.map(d=>e.jsxs("option",{value:d.id,children:[d.protocol," - ",d.symbol]},d.id))]}),e.jsxs("button",{type:"button",onClick:u,disabled:!l||!h||v.isPending,className:"flex items-center justify-center gap-2 px-4 py-2 bg-primary-600 hover:bg-primary-700 disabled:bg-gray-400 text-white text-sm font-medium rounded-md transition-colors disabled:cursor-not-allowed",children:[e.jsx(ot,{className:"h-4 w-4"}),v.isPending?r("assigning","Assigning..."):r("crypto.assignSelected","Assign {{count}} Selected",{count:s.size})]})]})]}),S&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300",children:[e.jsx(de,{className:"h-4 w-4"}),S]}),R&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-sm text-red-700 dark:text-red-300",children:[e.jsx(G,{className:"h-4 w-4"}),R]}),e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:b.map(d=>e.jsxs("div",{onClick:()=>N(d.id),className:`flex items-center gap-3 p-3 rounded-md border cursor-pointer transition-colors ${s.has(d.id)?"bg-primary-50 dark:bg-primary-900/20 border-primary-300 dark:border-primary-700":"bg-white dark:bg-gray-800 border-yellow-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750"}`,children:[e.jsx("div",{className:"flex-shrink-0",children:s.has(d.id)?e.jsx(De,{className:"h-5 w-5 text-primary-600"}):e.jsx(Pe,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:g(d)}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[j(d.claimed_at)," via ",d.source,d.reward_usd&&e.jsxs("span",{className:"ml-2 text-green-600 dark:text-green-400",children:["â‰ˆ $",Number(d.reward_usd).toFixed(2)]})]})]}),d.reward_usd&&d.reward_usd>0&&e.jsx("div",{className:"flex-shrink-0",onClick:P=>P.stopPropagation(),children:d.transaction_id?e.jsxs("a",{href:`/transactions?id=${d.transaction_id}`,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-green-700 dark:text-green-300 bg-green-100 dark:bg-green-900/30 rounded hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors",children:[e.jsx(Se,{className:"h-3 w-3"}),r("crypto.viewTransaction","View Txn")]}):e.jsxs("button",{type:"button",onClick:()=>{C(d.id),E.mutate(d.id)},disabled:M===d.id,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-primary-700 dark:text-primary-300 bg-primary-100 dark:bg-primary-900/30 rounded hover:bg-primary-200 dark:hover:bg-primary-900/50 disabled:opacity-50 transition-colors",children:[M===d.id?e.jsx(ue,{className:"h-3 w-3 animate-spin"}):e.jsx(ve,{className:"h-3 w-3"}),r("crypto.createTransaction","Create Txn")]})})]},d.id))}),l&&e.jsx("div",{className:"mt-3 pt-3 border-t border-yellow-200 dark:border-gray-700 text-sm text-yellow-700 dark:text-yellow-300",children:r("crypto.selectedRewards","{{count}} reward(s) selected",{count:s.size})})]})}const da={deposit:"ðŸ’°",stake:"ðŸ”’",borrow:"ðŸ’¸",reward:"ðŸŽ",liquidity:"ðŸ’§"},ca={liquidity_pool:"LP",staking:"Staking",lending:"Lending",farming:"Farming",vault:"Vault"};function xa(t){const r={};for(const a of t){const s=`${a.protocol}-${a.chain_id}-${a.name||a.token_name}-${a.position_type}`;r[s]||(r[s]={key:s,name:a.name||a.token_name,protocol:a.protocol,protocol_module:a.protocol_module,position_type:a.position_type,chain_id:a.chain_id,tokens:[],total_usd:0}),r[s].tokens.push(a),r[s].total_usd+=Number(a.balance_usd)}return Object.values(r)}function ma({group:t,onClick:r,isPrivacyMode:a}){const s=t.chain_id,p=ye[s],h=t.tokens[0],n=a?t.tokens.map(f=>`*** ${f.symbol}`).join(" + "):t.tokens.map(f=>{const k=Number(f.balance);return`${k<1e-4?"<0.0001":k<1?k.toFixed(4):k.toFixed(2)} ${f.symbol}`}).join(" + ");return e.jsxs("button",{onClick:()=>r(t),className:"w-full flex items-center justify-between py-3 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors text-left group",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"relative flex-shrink-0",children:t.tokens.length>1?e.jsxs("div",{className:"flex -space-x-2",children:[t.tokens.slice(0,3).map((f,k)=>f.logo_url?e.jsx("img",{src:f.logo_url,alt:f.symbol,className:"w-7 h-7 rounded-full border-2 border-white dark:border-gray-800",style:{zIndex:t.tokens.length-k},onError:v=>{v.target.style.display="none"}},f.id):e.jsx("div",{className:"w-7 h-7 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-bold border-2 border-white dark:border-gray-800",style:{zIndex:t.tokens.length-k},children:f.symbol.slice(0,2)},f.id)),t.tokens.length>3&&e.jsxs("div",{className:"w-7 h-7 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-xs font-medium border-2 border-white dark:border-gray-800",children:["+",t.tokens.length-3]})]}):h.logo_url?e.jsx("img",{src:h.logo_url,alt:h.symbol,className:"w-8 h-8 rounded-full",onError:f=>{f.target.style.display="none"}}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-sm font-bold",children:da[t.position_type]||"ðŸ“ˆ"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-gray-900 dark:text-white truncate",children:t.protocol}),e.jsx("span",{className:"text-xs px-1.5 py-0.5 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded",children:ca[t.protocol_module]||t.protocol_module})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("span",{className:"truncate",children:t.name}),p&&e.jsxs("span",{className:"text-xs px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded",children:[p.icon," ",s.toUpperCase()]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:a?"$***":`$${t.total_usd.toFixed(2)}`}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 max-w-[180px] truncate",children:n})]}),e.jsx(Ie,{className:"w-4 h-4 text-gray-400 group-hover:text-indigo-500 transition-colors"})]})]})}function Le(){const{t}=H("common"),{currency:r}=Ee(),{isPrivacyMode:a}=ce(),[s,p]=c.useState(null),h=pe(),{data:n,isLoading:f}=O({queryKey:["crypto-wallets"],queryFn:Ke}),{data:k=[]}=O({queryKey:["unattributed-rewards"],queryFn:He}),{data:v,isLoading:M,refetch:C}=O({queryKey:["crypto-defi-positions",n==null?void 0:n.map(g=>g.id)],queryFn:async()=>!n||n.length===0?[]:await Promise.all(n.map(j=>Ue(j.id).catch(()=>({wallet_address:j.wallet_address,total_value_usd:0,positions:[],last_sync_at:null})))),enabled:!!n&&n.length>0}),S=(v==null?void 0:v.flatMap(g=>g.positions))||[],x=xa(S),R=(v==null?void 0:v.reduce((g,j)=>g+Number(j.total_value_usd||0),0))||0,D=1/((h==null?void 0:h.USD)||.00667),E=Math.round(R*D),T=x.reduce((g,j)=>{const N=j.protocol;return g[N]||(g[N]=[]),g[N].push(j),g},{});if(f||M)return e.jsx(ge,{title:t("crypto.defiPositions"),badge:0,children:e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(le,{size:"md"})})});if(!n||n.length===0)return null;const w=k.length>0?`${x.length} Â· ${k.length} âš `:x.length;return e.jsxs(ge,{title:t("crypto.defiPositions"),badge:w,defaultOpen:x.length>0,children:[S.length>0&&e.jsx("div",{className:"mb-4 p-4 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:t("crypto.totalDefiValue")}),e.jsx("p",{className:"text-2xl font-bold text-indigo-600 dark:text-indigo-400",children:W(E,r,h,!1,a)})]}),e.jsx("button",{onClick:()=>C(),className:"p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 rounded-lg transition-colors",title:t("crypto.refresh"),children:e.jsx(Y,{className:"w-5 h-5"})})]})}),n[0]&&e.jsx("div",{className:"mb-4",children:e.jsx(oa,{walletId:n[0].id})}),x.length>0?e.jsx("div",{className:"space-y-4",children:Object.entries(T).sort(([,g],[,j])=>{const N=g.reduce((q,l)=>q+l.total_usd,0);return j.reduce((q,l)=>q+l.total_usd,0)-N}).map(([g,j])=>e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden",children:[e.jsx("div",{className:"px-4 py-2 bg-gray-100 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:g}),e.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:a?"$***":`$${j.reduce((N,L)=>N+L.total_usd,0).toFixed(2)}`})]})}),e.jsx("div",{className:"divide-y divide-gray-100 dark:divide-gray-700/50",children:j.sort((N,L)=>L.total_usd-N.total_usd).map(N=>e.jsx(ma,{group:N,onClick:p,isPrivacyMode:a},N.key))})]},g))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Wt,{className:"w-12 h-12 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:t("crypto.noDefiPositions")}),e.jsx("p",{className:"text-sm text-gray-400 dark:text-gray-500 mt-1",children:t("crypto.noDefiPositionsDescription")})]}),s&&e.jsx(ia,{group:s,onClose:()=>p(null)})]})}function qe(){const{t}=H("common"),[r,a]=c.useState(!1),{data:s,isLoading:p}=O({queryKey:["closed-positions"],queryFn:na});return p||!s||s.total_closed===0?null:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700",children:[e.jsxs("button",{onClick:()=>a(!r),className:"w-full flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(It,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{className:"text-left",children:[e.jsx("h3",{className:"font-medium text-gray-900 dark:text-white",children:t("crypto.closedPositions","Closed Positions")}),e.jsxs("p",{className:"text-sm text-gray-500",children:[s.total_closed," ",t("crypto.positions","positions")]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[s.total_realized_pnl_jpy!==null&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500",children:t("crypto.totalPnl","Total P&L")}),e.jsxs("p",{className:`font-medium ${s.total_realized_pnl_jpy>=0?"text-green-600":"text-red-600"}`,children:[s.total_realized_pnl_jpy>=0?"+":"",xe(s.total_realized_pnl_jpy,"JPY")]})]}),r?e.jsx(We,{className:"w-5 h-5 text-gray-500"}):e.jsx(je,{className:"w-5 h-5 text-gray-500"})]})]}),r&&e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-4 space-y-3",children:s.positions.map(h=>{const n=ye[h.chain_id],f=h.realized_pnl_jpy!==null&&h.realized_pnl_jpy>=0;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-gray-900 dark:text-white",children:[h.protocol," - ",h.symbol]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[n&&e.jsx("span",{children:n.icon}),e.jsx("span",{children:new Date(h.exit_date).toLocaleDateString(Z())})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-white",children:xe(h.exit_value_jpy,"JPY")}),h.realized_pnl_jpy!==null&&e.jsxs("div",{className:`flex items-center justify-end gap-1 text-sm ${f?"text-green-600":"text-red-600"}`,children:[f?e.jsx(be,{className:"w-3 h-3"}):e.jsx(dt,{className:"w-3 h-3"}),f?"+":"",xe(h.realized_pnl_jpy,"JPY"),h.realized_pnl_pct!==null&&e.jsxs("span",{className:"text-xs",children:["(",h.realized_pnl_pct.toFixed(1),"%)"]})]})]})]},h.id)})})]})}async function ua(t){return(await fe.post("/api/transfers/",t)).data}async function ga(t){return(await fe.post("/api/transfers/exchange",t)).data}const se={JPY:"Â¥",USD:"$",VND:"â‚«"};function ne(t){const r=t.replace(/[^\d]/g,"");return r?parseInt(r).toLocaleString("en-US"):""}function V(t){return parseInt(t.replace(/[,.\s]/g,""),10)||0}function ya({isOpen:t,onClose:r}){const{t:a}=H("common"),s=ee(),{data:p}=Be(),h=pe(),[n,f]=c.useState(null),[k,v]=c.useState(null),[M,C]=c.useState(""),[S,x]=c.useState(""),[R,D]=c.useState(""),[E,T]=c.useState(new Date().toISOString().split("T")[0]),[b,w]=c.useState(""),[g,j]=c.useState({}),[N,L]=c.useState(!1),[q,l]=c.useState(null),u=c.useMemo(()=>p==null?void 0:p.find(i=>i.id===n),[p,n]),d=c.useMemo(()=>p==null?void 0:p.find(i=>i.id===k),[p,k]),P=c.useMemo(()=>(p==null?void 0:p.filter(i=>i.id!==n))||[],[p,n]),{data:K}=O({queryKey:["transactions","income",u==null?void 0:u.currency],queryFn:()=>xt({type:"income"}),enabled:N&&!!u,select:i=>i.filter(z=>z.currency===(u==null?void 0:u.currency))});c.useEffect(()=>{if(!u||!d||!M||!h)return;const i=V(M);if(i<=0)return;if(u.currency===d.currency){x(ne(i.toString()));return}const z=h[u.currency]||1,y=h[d.currency]||1,F=i/z,B=Math.round(F*y);x(ne(B.toString()))},[u,d,M,h]),c.useEffect(()=>{var i;t&&(f(((i=p==null?void 0:p[0])==null?void 0:i.id)||null),v(null),C(""),x(""),D(""),T(new Date().toISOString().split("T")[0]),w(""),j({}),L(!1),l(null))},[t,p]);const $=Q({mutationFn:ua,onSuccess:()=>{s.invalidateQueries({queryKey:["accounts"]}),s.invalidateQueries({queryKey:["transactions"]}),s.invalidateQueries({queryKey:["transfers"]}),s.invalidateQueries({queryKey:["analytics"]}),r()}}),o=Q({mutationFn:ga,onSuccess:()=>{s.invalidateQueries({queryKey:["accounts"]}),s.invalidateQueries({queryKey:["transactions"]}),s.invalidateQueries({queryKey:["transfers"]}),s.invalidateQueries({queryKey:["analytics"]}),r()}}),_=N?o:$,U=()=>{const i={};return n||(i.fromAccount=a("transfer.errors.fromRequired")),k||(i.toAccount=a("transfer.errors.toRequired")),n&&k&&n===k&&(i.toAccount=a("transfer.errors.sameAccount")),(!M||V(M)<=0)&&(i.fromAmount=a("transfer.errors.amountRequired")),(!S||V(S)<=0)&&(i.toAmount=a("transfer.errors.amountRequired")),j(i),Object.keys(i).length===0},A=i=>{if(i.preventDefault(),!U())return;const z=(u==null?void 0:u.currency)||"JPY",y=(d==null?void 0:d.currency)||"JPY";if(N){const F={date:E,from_account_id:n,from_amount:ae(V(M),z),to_account_id:k,to_amount:ae(V(S),y),link_to_transaction_id:q||void 0,notes:b.trim()||void 0};o.mutate(F)}else{const F={from_account_id:n,to_account_id:k,from_amount:ae(V(M),z),to_amount:ae(V(S),y),fee_amount:ae(V(R)||0,z),date:E,description:b.trim()||void 0};u&&d&&u.currency!==d.currency&&(F.exchange_rate=V(S)/V(M)),$.mutate(F)}};if(!t)return null;const m=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 animate-modal-backdrop",onClick:r}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 dark:border-gray-700 px-6 py-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:N?a("transfer.exchangeTitle","Currency Exchange"):a("transfer.title")}),e.jsx("button",{onClick:r,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full",children:e.jsx(G,{className:"w-5 h-5"})})]}),e.jsxs("form",{onSubmit:A,className:"p-6 space-y-5",children:[e.jsx("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer text-sm text-gray-600 dark:text-gray-400",children:[e.jsx("input",{type:"checkbox",checked:N,onChange:i=>L(i.target.checked),className:"w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx(Y,{className:"w-4 h-4"}),a("transfer.exchangeMode","Currency Exchange")]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("transfer.fromAccount")}),e.jsxs("select",{value:n||"",onChange:i=>f(i.target.value?parseInt(i.target.value):null),className:I("w-full h-12 px-4 border rounded-lg","bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",g.fromAccount?"border-red-500":"border-gray-300"),children:[e.jsx("option",{value:"",children:a("transfer.selectAccount")}),p==null?void 0:p.map(i=>e.jsxs("option",{value:i.id,children:[i.name," (",se[i.currency]||i.currency,")"]},i.id))]}),g.fromAccount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:g.fromAccount})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(ct,{className:"w-6 h-6 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("transfer.toAccount")}),e.jsxs("select",{value:k||"",onChange:i=>v(i.target.value?parseInt(i.target.value):null),className:I("w-full h-12 px-4 border rounded-lg","bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",g.toAccount?"border-red-500":"border-gray-300"),children:[e.jsx("option",{value:"",children:a("transfer.selectAccount")}),P.map(i=>e.jsxs("option",{value:i.id,children:[i.name," (",se[i.currency]||i.currency,")"]},i.id))]}),g.toAccount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:g.toAccount})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("transfer.amount")}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-gray-500",children:u?se[u.currency]||u.currency:"Â¥"}),e.jsx("input",{type:"text",inputMode:"numeric",value:M,onChange:i=>C(ne(i.target.value)),className:I("w-full h-12 pl-10 pr-4 border rounded-lg text-right","dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",g.fromAmount?"border-red-500":"border-gray-300"),placeholder:"0"})]}),g.fromAmount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:g.fromAmount})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("transfer.convertedAmount")}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-gray-500",children:d?se[d.currency]||d.currency:"Â¥"}),e.jsx("input",{type:"text",inputMode:"numeric",value:S,onChange:i=>x(ne(i.target.value)),className:I("w-full h-12 pl-10 pr-4 border rounded-lg text-right","dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",g.toAmount?"border-red-500":"border-gray-300"),placeholder:"0"})]}),g.toAmount&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:g.toAmount})]})]}),u&&d&&u.currency!==d.currency&&M&&S&&e.jsxs("p",{className:"text-sm text-gray-500 text-center",children:["1 ",u.currency," â‰ˆ ",(V(S)/V(M)).toFixed(4)," ",d.currency]}),N&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[a("transfer.linkToIncome","Link to Income")," (",a("optional"),")"]}),e.jsxs("select",{value:q||"",onChange:i=>l(i.target.value?parseInt(i.target.value):null),className:"w-full h-12 px-4 border border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",children:[e.jsx("option",{value:"",children:a("transfer.noLink","None")}),K==null?void 0:K.map(i=>e.jsxs("option",{value:i.id,children:[i.date," - ",i.description," (",xe(i.amount,i.currency),")"]},i.id))]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:a("transfer.linkToIncomeHelp","Link this exchange to an income transaction for tracking")})]}),!N&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[a("transfer.fee")," (",a("optional"),")"]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 text-gray-500",children:u?se[u.currency]||u.currency:"Â¥"}),e.jsx("input",{type:"text",inputMode:"numeric",value:R,onChange:i=>D(ne(i.target.value)),className:"w-full h-12 pl-10 pr-4 border border-gray-300 rounded-lg text-right dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",placeholder:"0"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:a("transfer.date")}),e.jsx("input",{type:"date",value:E,onChange:i=>T(i.target.value),className:"w-full h-12 px-4 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:[a("transfer.description")," (",a("optional"),")"]}),e.jsx("input",{type:"text",value:b,onChange:i=>w(i.target.value),className:"w-full h-12 px-4 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100",placeholder:a("transfer.descriptionPlaceholder")})]}),_.isError&&e.jsx("p",{className:"text-sm text-red-500 text-center",children:a("transfer.error")}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx(ie,{type:"button",variant:"outline",onClick:r,className:"flex-1 h-12",children:a("cancel")}),e.jsx(ie,{type:"submit",loading:_.isPending,className:"flex-1 h-12 bg-blue-600 hover:bg-blue-700",children:a("transfer.create")})]})]})]})]});return typeof document>"u"?null:he.createPortal(m,document.body)}const Je="accounts_collapsed_sections";function ha(){try{const t=localStorage.getItem(Je);if(t)return new Set(JSON.parse(t))}catch{}return new Set}function pa(t){localStorage.setItem(Je,JSON.stringify([...t]))}const $e=["bank","savings","cash","credit_card","investment","crypto","receivable","other"];function ba(){const{t}=H("common"),[r,a]=c.useState(!1),[s,p]=c.useState(""),h=yt(s,200),[n,f]=c.useState(null),[k,v]=c.useState(!1),[M,C]=c.useState(!1),[S,x]=c.useState(!1),[R,D]=c.useState(!1),[E,T]=c.useState(null),[b,w]=c.useState(null),[g,j]=c.useState(()=>ha()),{data:N}=we(),{isPrivacyMode:L}=ce();c.useEffect(()=>{pa(g)},[g]),c.useEffect(()=>{const y=()=>x(!0),F=()=>D(!0);return window.addEventListener("open-add-transaction-modal",y),window.addEventListener("open-receipt-scanner",F),()=>{window.removeEventListener("open-add-transaction-modal",y),window.removeEventListener("open-receipt-scanner",F)}},[]);const q=c.useCallback(y=>{j(F=>{const B=new Set(F);return B.has(y)?B.delete(y):B.add(y),B})},[]),{data:l,isLoading:u,error:d}=Be(r),P=c.useMemo(()=>{if(!l)return[];let y=l;if(h.trim()){const F=h.toLowerCase();y=y.filter(B=>{var te;return B.name.toLowerCase().includes(F)||t(`account.type.${B.type}`).toLowerCase().includes(F)||((te=B.notes)==null?void 0:te.toLowerCase().includes(F))})}return n&&(y=y.filter(F=>F.type===n)),y},[l,h,n,t]),K=c.useMemo(()=>P.reduce((y,F)=>{const B=F.type;return y[B]||(y[B]=[]),y[B].push(F),y},{}),[P]),$=c.useMemo(()=>{if(!l)return[];const y=new Set(l.map(F=>F.type));return $e.filter(F=>y.has(F))},[l]),o=c.useMemo(()=>P.length?P.reduce((y,F)=>y+F.current_balance,0):0,[P]),_=()=>{T(null),v(!0)},U=y=>{T(y),v(!0)},A=()=>{v(!1),T(null)},m=l&&l.length>0,i=P.length>0,z=h.trim()!==""||n!==null;return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-32",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:t("account.accounts")}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 mt-0.5",children:t("account.subtitle")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>C(!0),className:"inline-flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors",children:[e.jsx(Ot,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:t("transfer.title")})]}),e.jsxs("button",{onClick:_,className:"inline-flex items-center gap-2 px-3 py-2 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(oe,{className:"w-4 h-4"}),t("account.createAccount")]})]})]})}),m&&e.jsxs("div",{className:"mb-6 space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Me,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",value:s,onChange:y=>p(y.target.value),placeholder:t("account.searchPlaceholder","Search accounts..."),className:"w-full pl-10 pr-10 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-sm"}),s&&e.jsx("button",{onClick:()=>p(""),className:"absolute right-3 top-1/2 -translate-y-1/2 p-0.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",children:e.jsx(G,{className:"w-4 h-4 text-gray-400"})})]}),e.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto scrollbar-hide pb-1",children:[e.jsxs("button",{onClick:()=>f(null),className:I("px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-all",n?"text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800":"bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400"),children:[t("account.allTypes","All")," (",(l==null?void 0:l.length)||0,")"]}),$.map(y=>{const F=(l==null?void 0:l.filter(B=>B.type===y).length)||0;return e.jsxs("button",{onClick:()=>f(n===y?null:y),className:I("px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-all",n===y?"bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400":"text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800"),children:[t(`account.type.${y}`)," (",F,")"]},y)}),e.jsx("div",{className:"flex-1"}),e.jsxs("button",{onClick:()=>a(!r),className:I("flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap transition-all",r?"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300":"text-gray-500 dark:text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800"),children:[r?e.jsx(mt,{className:"w-3.5 h-3.5"}):e.jsx(ut,{className:"w-3.5 h-3.5"}),t("account.showInactive")]})]})]}),m&&i&&e.jsx("div",{className:"mb-6",children:e.jsx(X,{variant:"glass",className:"!p-5 bg-hero-gradient",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-widest",children:z?t("account.filteredBalance","Filtered Balance"):t("account.totalBalance","Total Balance")}),e.jsx("p",{className:I("text-3xl sm:text-4xl font-extrabold font-numbers mt-1.5 tracking-tighter",o>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"),children:W(o,"JPY",(N==null?void 0:N.rates)||{},!0,L)})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[P.length," ",t("account.accountCount","accounts")]})})]})})}),u&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"})}),d&&e.jsx("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6",children:e.jsx("p",{className:"text-red-700 dark:text-red-400 text-sm",children:t("account.errors.loadFailed")})}),!u&&!d&&!m&&e.jsx(gt,{icon:e.jsx(me,{}),title:t("emptyState.accounts.title"),description:t("emptyState.accounts.description"),action:e.jsxs("button",{onClick:_,className:"inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm",children:[e.jsx(oe,{className:"w-4 h-4"}),t("emptyState.accounts.cta")]})}),!u&&!d&&m&&!i&&z&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Me,{className:"w-10 h-10 text-gray-300 dark:text-gray-600 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:t("account.noSearchResults","No accounts match your search")}),e.jsx("button",{onClick:()=>{p(""),f(null)},className:"mt-2 text-sm text-primary-600 dark:text-primary-400 hover:underline",children:t("account.clearFilters","Clear filters")})]}),!u&&!d&&i&&e.jsxs("div",{className:"space-y-6",children:[$e.map(y=>{const F=K[y];if(!F||F.length===0)return null;const B=g.has(y);return e.jsxs("div",{children:[e.jsxs("button",{type:"button",onClick:()=>q(y),className:"w-full flex items-center justify-between mb-3 group cursor-pointer",children:[e.jsxs("h2",{className:"text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2",children:[t(`account.type.${y}`),e.jsx("span",{className:"text-xs font-normal text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded-full",children:F.length})]}),e.jsx(je,{className:I("w-4 h-4 text-gray-400 transition-transform duration-200",B&&"-rotate-90")})]}),e.jsx("div",{className:I("grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 transition-all duration-200 ease-in-out",B?"max-h-0 opacity-0 overflow-hidden":"max-h-[2000px] opacity-100"),children:F.map((te,Ge)=>e.jsx("div",{className:"animate-stagger-in",style:{"--stagger-index":Math.min(Ge,9)},children:e.jsx(Xt,{account:te,onEdit:U,onAddTransaction:Xe=>{w(Xe),x(!0)}})},te.id))})]},y)}),e.jsx(Te,{}),e.jsx(Le,{}),e.jsx(qe,{})]}),!u&&!d&&!m&&e.jsxs("div",{className:"mt-8 space-y-6",children:[e.jsx(Te,{}),e.jsx(Le,{}),e.jsx(qe,{})]}),e.jsx(Zt,{isOpen:k,onClose:A,editingAccountId:E}),e.jsx(ya,{isOpen:M,onClose:()=>C(!1)}),e.jsx(ht,{isOpen:S,onClose:()=>{x(!1),w(null)},defaultAccountId:b}),e.jsx(pt,{isOpen:R,onClose:()=>D(!1),onScanComplete:()=>D(!1)})]})}const Ea=et("/accounts")({component:ba});export{Ea as Route};

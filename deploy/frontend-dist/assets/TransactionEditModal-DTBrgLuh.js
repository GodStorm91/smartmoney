import{j as e}from"./vendor-router-DONIM_LE.js";import{r as n,a as me}from"./vendor-react-Cwh1aMWO.js";import{b as xe,c as Y}from"./vendor-query-B0NEAgzV.js";import{aF as pe,X as H,N as he,aW as fe,O as ge,B as v,I as A,aX as ye,j as be}from"./index-V2SVG0IT.js";import{g as $,H as je,B as ve,u as we}from"./BudgetInsightWidget-BbpK3Jth.js";import{S as P}from"./Select-WwOCEm8I.js";import{u as X}from"./vendor-i18n-CNDlYvyf.js";import{Z as Ne,a as ke}from"./zoom-out-BVgTEcNK.js";import{D as Ce}from"./download-C-rElxlp.js";function Se({receiptUrl:u,onClose:d}){const{t:a}=X(),[s,i]=n.useState(1),o=$(u);if(!o)return null;const f=()=>i(l=>Math.min(l+.25,3)),g=()=>i(l=>Math.max(l-.25,.5)),y=()=>{const l=document.createElement("a");l.href=o,l.download=`receipt-${Date.now()}.jpg`,l.click()};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/90 flex flex-col",onClick:l=>{l.target===l.currentTarget&&d()},children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-black/50",children:[e.jsxs("h2",{className:"text-white font-medium flex items-center gap-2",children:[e.jsx(pe,{size:20}),a("receipt.viewReceipt","View Receipt")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:g,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white","aria-label":a("zoomOut","Zoom out"),children:e.jsx(Ne,{size:20})}),e.jsxs("span",{className:"text-white text-sm w-12 text-center",children:[Math.round(s*100),"%"]}),e.jsx("button",{onClick:f,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white","aria-label":a("zoomIn","Zoom in"),children:e.jsx(ke,{size:20})}),e.jsx("button",{onClick:y,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white ml-2","aria-label":a("download","Download"),children:e.jsx(Ce,{size:20})}),e.jsx("button",{onClick:d,className:"p-2 hover:bg-white/10 rounded-lg transition-colors text-white ml-2","aria-label":a("close","Close"),children:e.jsx(H,{size:20})})]})]}),e.jsx("div",{className:"flex-1 overflow-auto flex items-center justify-center p-4",children:e.jsx("img",{src:o,alt:"Receipt",className:"max-w-full max-h-full object-contain transition-transform duration-200",style:{transform:`scale(${s})`}})})]})}function qe({isOpen:u,onClose:d,transaction:a}){const{t:s}=X("common"),i=xe(),{data:o=[]}=he(),[f,g]=n.useState(""),[y,l]=n.useState(""),[U,z]=n.useState(""),[G,E]=n.useState(""),[w,N]=n.useState("JPY"),[b,I]=n.useState(""),[c,q]=n.useState(null),[x,T]=n.useState("expense"),[ee,Z]=n.useState(""),[k,Q]=n.useState(!1),[te,C]=n.useState(!1),[p,V]=n.useState(null),[F,S]=n.useState(null),[h,R]=n.useState(null),[ae,K]=n.useState(!1),[_,B]=n.useState(!1),[L,W]=n.useState(!1),j=n.useRef(null),se=[{value:"JPY",label:"¥ JPY"},{value:"USD",label:"$ USD"},{value:"VND",label:"₫ VND"}],J=t=>{const r=t.replace(/[^\d]/g,"");return r?Number(r).toLocaleString():""},ne=t=>{const r=t.target.value.replace(/[^\d]/g,"");z(r),E(J(r))},D=Y({mutationFn:t=>fe(a.id,t),onSuccess:()=>{i.invalidateQueries({queryKey:["transactions"]}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["analytics"]}),d()}}),M=Y({mutationFn:()=>ge(a.id),onSuccess:()=>{i.invalidateQueries({queryKey:["transactions"]}),i.invalidateQueries({queryKey:["dashboard"]}),i.invalidateQueries({queryKey:["analytics"]}),d()}});n.useEffect(()=>{if(a&&u){g(a.date),l(a.description);const t=Math.abs(a.amount).toString();z(t),E(J(t)),N(a.currency||"JPY"),I(a.category),Z(""),q(a.account_id??null),T(a.type),Q(a.is_adjustment||!1),C(!1),V(a.receipt_url||null),S(null),R(null),W(!1)}},[a==null?void 0:a.id,u]);const re=t=>{var m;const r=(m=t.target.files)==null?void 0:m[0];!r||!r.type.startsWith("image/")||(S(r),R(URL.createObjectURL(r)))},le=()=>{S(null),h&&(URL.revokeObjectURL(h),R(null)),V(null),j.current&&(j.current.value="")};n.useEffect(()=>{if(c&&!L){const t=o.find(r=>r.id===c);t!=null&&t.currency&&N(t.currency)}},[c,o,L]);const ie=async t=>{t.preventDefault();const r=parseFloat(U);if(isNaN(r))return;const m=o.find(de=>de.id===c),ue=(m==null?void 0:m.name)||(a==null?void 0:a.source)||"";let O=p;if(F){B(!0);try{O=await we(F)}finally{B(!1)}}D.mutate({date:f,description:y,amount:Math.round(x==="expense"?-Math.abs(r):Math.abs(r)),currency:w,category:b||"Other",source:ue,type:x,account_id:c,receipt_url:O,is_adjustment:k})},oe=()=>{M.mutate()};if(n.useEffect(()=>(u&&(document.body.style.overflow="hidden"),()=>{document.body.style.overflow=""}),[u]),!u||!a)return null;const ce=e.jsxs("div",{className:"fixed inset-0 z-[100001] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50",onClick:d}),e.jsx("div",{className:"relative bg-white dark:bg-gray-800 rounded-xl shadow-xl w-full max-w-md max-h-[90dvh] overflow-y-auto overflow-x-hidden",style:{touchAction:"pan-y"},children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100",children:s("transaction.editTitle")}),te?e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:s("transaction.deleteConfirm")}),e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:a.description}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(v,{variant:"outline",onClick:()=>C(!1),className:"flex-1",children:s("button.cancel")}),e.jsx(v,{variant:"secondary",onClick:oe,disabled:M.isPending,className:"flex-1 bg-red-600 hover:bg-red-700 text-white",children:M.isPending?"...":s("button.delete")})]})]}):e.jsxs("form",{onSubmit:ie,className:"space-y-4",children:[e.jsx(A,{label:s("transaction.date"),type:"date",value:f,onChange:t=>g(t.target.value),required:!0}),e.jsx(A,{label:s("transaction.description"),value:y,onChange:t=>l(t.target.value),required:!0}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-1",children:e.jsx(A,{label:s("transaction.amount"),type:"text",inputMode:"numeric",value:G,onChange:ne,required:!0})}),e.jsx("div",{className:"w-28",children:e.jsx(P,{label:s("transaction.currency","Currency"),value:w,onChange:t=>{N(t.target.value),W(!0)},options:se})})]}),e.jsx(P,{label:s("transaction.type"),value:x,onChange:t=>T(t.target.value),options:[{value:"income",label:s("transaction.typeIncome")},{value:"expense",label:s("transaction.typeExpense")}]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:s("transaction.category")}),e.jsx(je,{selected:b,onSelect:(t,r)=>{I(t),Z(r)},isIncome:x==="income"})]}),b&&!k&&e.jsx(ve,{parentCategory:ee||b,transactionAmount:parseInt(U)||0,isExpense:x==="expense",transactionCurrency:w}),e.jsx(P,{label:s("account.account"),value:(c==null?void 0:c.toString())||"",onChange:t=>q(t.target.value?Number(t.target.value):null),options:[{value:"",label:s("account.selectAccount")},...o.map(t=>({value:t.id.toString(),label:t.name}))]}),e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer py-2",children:[e.jsx("input",{type:"checkbox",checked:k,onChange:t=>Q(t.target.checked),className:"w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:s("transaction.balanceAdjustment","Balance adjustment")}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:s("transaction.balanceAdjustmentHint","Won't count toward budget")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:s("receipt.receipt","Receipt")}),e.jsx("input",{ref:j,type:"file",accept:"image/*",capture:"environment",onChange:re,className:"hidden"}),h||p?e.jsxs("div",{className:"relative rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700",children:[e.jsx("img",{src:h||$(p)||"",alt:"Receipt",className:"w-full h-20 object-cover cursor-pointer",onClick:()=>!h&&K(!0)}),e.jsx("button",{type:"button",onClick:le,className:"absolute top-1 right-1 p-1 bg-black/50 rounded-full text-white hover:bg-black/70",children:e.jsx(H,{size:14})})]}):e.jsxs("button",{type:"button",onClick:()=>{var t;return(t=j.current)==null?void 0:t.click()},className:"w-full h-10 flex items-center justify-center gap-2 border border-dashed border-gray-300 dark:border-gray-600 hover:border-primary-400 text-gray-500 dark:text-gray-400 rounded-lg text-sm",children:[e.jsx(ye,{size:16}),s("receipt.attachReceipt","Attach Receipt")]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(v,{type:"button",variant:"outline",onClick:d,className:"flex-1",children:s("button.cancel")}),e.jsx(v,{type:"submit",disabled:D.isPending||_,className:"flex-1",children:_?s("receipt.uploading","Uploading..."):D.isPending?"...":s("button.save")})]}),e.jsx("button",{type:"button",onClick:()=>C(!0),className:be("w-full text-center text-sm text-red-600 hover:text-red-700","py-2 transition-colors"),children:s("transaction.deleteTransaction")})]})]})}),ae&&p&&e.jsx(Se,{receiptUrl:p,onClose:()=>K(!1)})]});return typeof document<"u"?me.createPortal(ce,document.body):null}export{qe as T};

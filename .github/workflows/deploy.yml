name: CI/CD Pipeline

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/godstorm91/smartmoney-backend

jobs:
  # ====================
  # BUILD & TEST
  # ====================
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Build frontend
        run: cd frontend && npm run build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -e .

      - name: Login to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/Dockerfile.backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:main
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          no-cache: true
          pull: true

  # ====================
  # AUTO-DEPLOY ON MAIN
  # ====================
  deploy-main:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="/root/smartmoney/deploy"
            REPO_DIR="/root/smartmoney"

            echo "=== Auto-deploying main branch ==="

            # Pull latest code (frontend-dist is inside deploy/)
            cd $REPO_DIR
            git fetch origin main
            git reset --hard origin/main

            # Sync frontend-dist to nginx volume mount directory
            NGINX_VOLUME_DIR="/var/www/smartmoney/deploy/frontend-dist"
            echo "Syncing frontend files to nginx volume..."
            rm -rf "$NGINX_VOLUME_DIR/assets" "$NGINX_VOLUME_DIR/locales" "$NGINX_VOLUME_DIR/icons"
            cp -r $DEPLOY_DIR/frontend-dist/* "$NGINX_VOLUME_DIR/"

            cd $DEPLOY_DIR

            # Pull latest backend image
            echo "Pulling backend image: main"
            docker pull ghcr.io/godstorm91/smartmoney-backend:main

            # Ensure using main tag
            sed -i "s/^BACKEND_IMAGE_TAG=.*/BACKEND_IMAGE_TAG=main/" .env || echo "BACKEND_IMAGE_TAG=main" >> .env

            # Run migrations
            echo "Running migrations..."
            docker compose run --rm backend alembic upgrade head

            # Restart backend
            echo "Restarting backend..."
            docker compose up -d --force-recreate backend

            # Restart nginx to pick up new frontend files
            echo "Restarting nginx..."
            docker compose down nginx && docker compose up -d nginx

            # Cleanup old images
            docker image prune -af --filter "until=168h" || true

            echo "=== Auto-deploy complete ==="
            docker compose ps

  # ====================
  # DEPLOY TO PRODUCTION (versioned)
  # ====================
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      packages: write

    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag image with version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          docker pull ${{ env.BACKEND_IMAGE }}:main
          docker tag ${{ env.BACKEND_IMAGE }}:main ${{ env.BACKEND_IMAGE }}:$VERSION
          docker push ${{ env.BACKEND_IMAGE }}:$VERSION

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: VERSION
          script: |
            set -e
            DEPLOY_DIR="/root/smartmoney/deploy"
            REPO_DIR="/root/smartmoney"

            echo "=== Deploying version: $VERSION ==="

            # Pull latest code (for frontend)
            cd $REPO_DIR
            git fetch origin main
            git checkout main
            git reset --hard origin/main

            # Build frontend
            echo "Building frontend..."
            cd frontend
            npm ci
            npm run build

            # Copy frontend to deploy dir and nginx volume
            echo "Copying frontend files..."
            rm -rf $DEPLOY_DIR/frontend-dist/*
            cp -r dist/* $DEPLOY_DIR/frontend-dist/

            # Sync to nginx volume mount directory
            NGINX_VOLUME_DIR="/var/www/smartmoney/deploy/frontend-dist"
            echo "Syncing frontend files to nginx volume..."
            rm -rf "$NGINX_VOLUME_DIR/assets" "$NGINX_VOLUME_DIR/locales" "$NGINX_VOLUME_DIR/icons"
            cp -r dist/* "$NGINX_VOLUME_DIR/"

            cd $DEPLOY_DIR

            # Pull new backend image
            echo "Pulling backend image: $VERSION"
            docker pull ghcr.io/godstorm91/smartmoney-backend:$VERSION

            # Update .env with new version
            sed -i "s/^BACKEND_IMAGE_TAG=.*/BACKEND_IMAGE_TAG=$VERSION/" .env || echo "BACKEND_IMAGE_TAG=$VERSION" >> .env

            # Run migrations (separate step)
            echo "Running migrations..."
            docker compose run --rm backend alembic upgrade head

            # Restart backend with new image
            echo "Restarting backend..."
            docker compose up -d --force-recreate backend

            # Restart nginx to pick up new frontend files
            echo "Restarting nginx..."
            docker compose down nginx && docker compose up -d nginx

            # Cleanup old images (older than 7 days)
            echo "Cleaning up old images..."
            docker image prune -af --filter "until=168h" || true

            # Show status
            echo "=== Deploy complete: $VERSION ==="
            docker compose ps
